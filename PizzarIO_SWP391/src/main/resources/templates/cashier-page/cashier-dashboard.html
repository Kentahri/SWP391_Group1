<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Cashier Dashboard - Table Management</title>
	<link rel="stylesheet" th:href="@{/css/cashier-dashboard.css}">
</head>
<body>
<div class="dashboard-container">
	<!-- Top bar -->
	<header class="topbar">
		<div class="brand">🍕 PizzarIO</div>
		<div>Tên: <p th:text="${staff.name}"></p></div>
		<div>
			<div id="clock" class="clock">--:--:--</div>
			<div id="date" class="date">--/--/----</div>
		</div>
		<div class="actions">
			<a th:href="@{/cashier/reservations/upcoming}" class="btn">Xem đơn hàng đặt trước</a>
			<button class="btn action" type="button">Tạo mới đơn hàng</button>
			<button class="btn action" type="button">Xem lịch sử hóa đơn</button>
			<form th:action="@{/logout}" method="post">
				<input type="hidden"
				       th:if="${_csrf != null}"
				       th:name="${_csrf.parameterName}"
				       th:value="${_csrf.token}"/>
				<button type="submit" class="btn-logout">Logout</button>
			</form>
		</div>
	</header>
	<div class="horizontal-divider"></div>
	
	<div class="layout">
		<!-- Left: Table manager -->
		<section class="panel left">
			<div class="section-title">Quản lý bàn</div>
			<div class="panel-header">
				<span class="icon">🪑</span>
				<span class="title">Table map</span>
			</div>
			
			<div class="table-grid" id="table-grid">
				<a th:each="table : ${tables}"
				   th:id="'table-' + ${table.id}"
				   th:class="'table-card ' + ${table.tableStatus.toString().toLowerCase()} + ${selectedTableId != null && selectedTableId == table.id ? ' selected' : ''}"
				   th:href="@{/cashier/tables/{id}/order(id=${table.id})}"
				   th:attr="data-id=${table.id},
				            data-status=${table.tableStatus},
				            data-capacity=${table.capacity}"
				   style="text-decoration: none; color: inherit; cursor: pointer;">
					<div class="table-dot"
					     th:classappend="${table.tableStatus.toString().toLowerCase() == 'waiting_payment' ? ' show' : ''}"></div>
					<div class="table-number">Bàn [[${table.id}]]</div>
					<div class="table-status-text"
					     th:text="${table.tableStatus == 'AVAILABLE' ? 'Trống' : (table.tableStatus == 'OCCUPIED' ? 'Có khách' : (table.tableStatus == 'WAITING_PAYMENT' ? 'Chờ thanh toán' : 'Đã đặt trước'))}">
						Trống
					</div>
					<div class="table-note" th:if="${table.tableStatus == 'WAITING_PAYMENT'}">Tiền mặt</div>
					<div class="table-capacity" th:if="${table.tableStatus == 'RESERVED'}">[[${table.capacity}]] người
					</div>
				</a>
			</div>
			
			<div class="legend">
				<div class="legend-title">Chú thích:</div>
				<div class="legend-items">
					<div class="legend-item"><span class="box avail"></span><span>Bàn trống</span></div>
					<div class="legend-item"><span class="box occ"></span><span>Đang có khách</span></div>
					<div class="legend-item"><span class="box wait"></span><span>Chờ thanh toán</span></div>
					<div class="legend-item"><span class="box res"></span><span>Đã đặt trước</span></div>
				</div>
			</div>
		</section>
		
		<!-- Right: Table details -->
		<section class="panel right">
			<div class="section-title" id="right-panel-title">
				<span th:text="${upcomingReservations != null ? 'Danh sách đặt bàn sắp tới' : (tableReservations != null ? 'Đơn đặt trước - Bàn ' + selectedTableId : 'Đơn bàn chi tiết')}">Đơn bàn chi tiết</span>
			</div>
			
			<!-- Table Detail View (default - no table selected) -->
			<div id="table-detail" class="table-detail" th:if="${orderDetail == null && selectedTableId == null && upcomingReservations == null && tableReservations == null}">
				<div class="placeholder">Chọn 1 bàn để xem chi tiết</div>
			</div>
			
			<!-- Empty Table View (table selected but no order) -->
			<div th:if="${selectedTableId != null && orderDetail == null && upcomingReservations == null && tableReservations == null}" class="table-detail">
				<div class="detail-card">
					<div class="detail-row"><strong>Bàn số:</strong> <span th:text="${selectedTableId}">—</span></div>
					
					<div style="margin-top: 12px; display: flex; flex-direction: column; gap: 8px;">
						<button class="btn-reserve" th:onclick="'openReservationModal(' + ${selectedTableId} + ')'">
							📅 Đặt trước bàn này
						</button>
						<a th:href="@{/cashier/tables/{tableId}/reservations(tableId=${selectedTableId})}" class="btn-view-reservations">
							📋 Xem đơn đặt trước
						</a>
					</div>
				</div>
			</div>
			
			<!-- Order Detail View (when table is selected and has order) -->
			<div th:if="${orderDetail != null}" class="table-detail">
				<div class="detail-card">
					<div class="detail-row"><strong>Bàn số:</strong> <span th:text="${selectedTableId}">—</span></div>
					<div class="detail-row"><strong>Số người tối đa:</strong> <span th:text="${tableCapacity}">—</span></div>
				</div>
				<div class="order-detail-card">
					<div class="order-header">
						<span th:class="'order-status ' + ${orderDetail.orderStatus.toString().toLowerCase()}" 
						      th:text="${orderDetail.orderStatus == 'PREPARING' ? 'Đang chuẩn bị' : (orderDetail.orderStatus == 'SERVED' ? 'Đã phục vụ' : (orderDetail.orderStatus == 'COMPLETED' ? 'Hoàn thành' : orderDetail.orderStatus))}">
						</span>
					</div>
					
					<div class="order-meta">
						<div class="meta-row">
							<span class="meta-label">Mã đơn:</span>
							<span class="meta-value">#<span th:text="${orderDetail.orderId}">—</span></span>
						</div>
						<div class="meta-row">
							<span class="meta-label">Trạng thái thanh toán:</span>
							<span th:class="'meta-value payment-' + ${orderDetail.paymentStatus.toString().toLowerCase()}" 
							      th:text="${orderDetail.paymentStatus == 'UNPAID' ? 'Chưa thanh toán' : (orderDetail.paymentStatus == 'PAID' ? 'Đã thanh toán' : 'Đang xử lý')}">
							</span>
						</div>
						<div class="meta-row" th:if="${orderDetail.paymentMethod != null}">
							<span class="meta-label">Phương thức:</span>
							<span class="meta-value" th:text="${orderDetail.paymentMethod == 'CASH' ? 'Tiền mặt' : (orderDetail.paymentMethod == 'QR' ? 'QR Code' : 'Thẻ tín dụng')}"></span>
						</div>
					</div>

					<div class="order-items-section">
						<div class="section-header-small">
							<span>Món đã gọi</span>
							<span class="item-count" th:text="${#lists.isEmpty(orderDetail.items) ? '0' : #aggregates.sum(orderDetail.items.![quantity])} + ' món'">0 món</span>
						</div>
						<div class="order-items-list">
							<div th:if="${#lists.isEmpty(orderDetail.items)}" class="no-items">Chưa có món nào</div>
							<div th:each="item : ${orderDetail.items}" class="order-item">
								<div class="order-item-info">
									<div class="item-name" th:text="${item.productName}">—</div>
									<div class="item-detail">
										<span class="item-quantity">x<span th:text="${item.quantity}">1</span></span>
										<span class="item-price" th:text="${#numbers.formatCurrency(item.unitPrice)}">0đ</span>
									</div>
									<div th:if="${item.note != null && !#strings.isEmpty(item.note)}" class="item-note">📝 <span th:text="${item.note}"></span></div>
								</div>
								<div class="item-total" th:text="${#numbers.formatCurrency(item.totalPrice)}">0đ</div>
							</div>
						</div>
					</div>

					<div class="order-summary">
						<div th:if="${orderDetail.voucherCode != null}" class="summary-row">
							<span>Voucher:</span>
							<span class="voucher-code" th:text="${orderDetail.voucherCode}">—</span>
						</div>
						<div th:if="${orderDetail.discountAmount != null && orderDetail.discountAmount > 0}" class="summary-row discount">
							<span>Giảm giá:</span>
							<span th:text="'-' + ${#numbers.formatCurrency(orderDetail.discountAmount)}">-0đ</span>
						</div>
						<div class="summary-row total">
							<span>Tổng cộng:</span>
							<span class="total-amount" th:text="${#numbers.formatCurrency(orderDetail.totalPrice)}">0đ</span>
						</div>
					</div>

					<div th:if="${orderDetail.note != null && !#strings.isEmpty(orderDetail.note)}" class="order-note">
						<strong>Ghi chú:</strong> <span th:text="${orderDetail.note}"></span>
					</div>
				</div>
				
				<div style="margin-top: 12px;">
					<a th:href="@{/cashier/tables/{tableId}/reservations(tableId=${selectedTableId})}" class="btn-view-reservations">
						📋 Xem đơn đặt trước
					</a>
				</div>
			</div>
			
			<!-- Upcoming Reservations View -->
			<div th:if="${upcomingReservations != null}" class="reservation-list">
				<div class="reservation-header">
					<a th:href="@{/cashier}" class="btn-back">← Quay lại</a>
				</div>
				<div class="reservation-items">
					<div th:if="${#lists.isEmpty(upcomingReservations)}" class="no-reservations">
						<div class="no-reservations-icon">📅</div>
						<div class="no-reservations-text">Chưa có đơn đặt bàn nào</div>
					</div>
					
					<div th:each="reservation : ${upcomingReservations}" class="reservation-card">
						<div class="reservation-card-header">
							<div class="reservation-table-name" th:text="${reservation.tableName}">Bàn —</div>
							<span th:class="'reservation-status ' + ${reservation.status.toString().toLowerCase()}" 
							      th:text="${reservation.status == 'CONFIRMED' ? 'Đã xác nhận' : 'Đã hủy'}">
							</span>
						</div>
						
						<div class="reservation-time">
							🕐 Thời gian: <span th:text="${#temporals.format(reservation.startTime, 'EEE, dd MMM yyyy HH:mm')}">—</span>
						</div>
						
						<div class="reservation-info">
							<div class="reservation-info-row">
								<span class="reservation-info-label">👤 Khách hàng:</span>
								<span class="reservation-info-value" th:text="${reservation.customerName}">—</span>
							</div>
							<div class="reservation-info-row">
								<span class="reservation-info-label">📞 Số điện thoại:</span>
								<span class="reservation-info-value" th:text="${reservation.customerPhone}">—</span>
							</div>
							<div class="reservation-info-row">
								<span class="reservation-info-label">👥 Số khách:</span>
								<span class="reservation-info-value" th:text="${reservation.capacityExpected + ' người'}">— người</span>
							</div>
							<div th:if="${reservation.note != null && !#strings.isEmpty(reservation.note)}" class="reservation-info-row">
								<span class="reservation-info-label">📝 Ghi chú:</span>
								<span class="reservation-info-value" th:text="${reservation.note}">—</span>
							</div>
						</div>
						
						<div th:if="${reservation.status.toString() == 'CONFIRMED'}" class="reservation-actions">
							<form th:action="@{/cashier/reservations/{id}/delete(id=${reservation.id})}" method="post" 
							      onsubmit="return confirm('Bạn có chắc chắn muốn hủy đặt bàn này?');">
								<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
								<input type="hidden" name="returnUrl" th:value="@{/cashier/reservations/upcoming}"/>
								<button type="submit" class="btn-cancel-reservation">❌ Hủy đặt bàn</button>
							</form>
						</div>
					</div>
				</div>
			</div>
			
			<!-- Table Reservations View -->
			<div th:if="${tableReservations != null}" class="reservation-list">
				<div class="detail-card" style="margin-bottom: 16px;">
					<div class="reservation-header">
						<a th:href="@{/cashier/tables/{id}/order(id=${selectedTableId})}" class="btn-back">
							← Quay lại bàn <span th:text="${selectedTableId}">—</span>
						</a>
					</div>
				</div>
				<div class="reservation-items">
					<div th:if="${#lists.isEmpty(tableReservations)}" class="no-reservations">
						<div class="no-reservations-icon">📅</div>
						<div class="no-reservations-text">Chưa có đơn đặt bàn nào</div>
					</div>
					
					<div th:each="reservation : ${tableReservations}" class="reservation-card">
						<div class="reservation-card-header">
							<div class="reservation-table-name">Đặt bàn #<span th:text="${reservation.id}">—</span></div>
							<span th:class="'reservation-status ' + ${reservation.status.toString().toLowerCase()}" 
							      th:text="${reservation.status == 'CONFIRMED' ? 'Đã xác nhận' : 'Đã hủy'}">
							</span>
						</div>
						
						<div class="reservation-time">
							🕐 <span th:text="${#temporals.format(reservation.startTime, 'EEE, dd MMM yyyy HH:mm')}">—</span>
						</div>
						
						<div class="reservation-info">
							<div class="reservation-info-row">
								<span class="reservation-info-label">👤 Khách hàng:</span>
								<span class="reservation-info-value" th:text="${reservation.customerName}">—</span>
							</div>
							<div class="reservation-info-row">
								<span class="reservation-info-label">📞 Số điện thoại:</span>
								<span class="reservation-info-value" th:text="${reservation.customerPhone}">—</span>
							</div>
							<div class="reservation-info-row">
								<span class="reservation-info-label">👥 Số khách:</span>
								<span class="reservation-info-value" th:text="${reservation.capacityExpected + ' người'}">— người</span>
							</div>
							<div th:if="${reservation.note != null && !#strings.isEmpty(reservation.note)}" class="reservation-info-row">
								<span class="reservation-info-label">📝 Ghi chú:</span>
								<span class="reservation-info-value" th:text="${reservation.note}">—</span>
							</div>
						</div>
						
						<div th:if="${reservation.status.toString() == 'CONFIRMED'}" class="reservation-actions">
							<form th:action="@{/cashier/reservations/{id}/delete(id=${reservation.id})}" method="post" 
							      onsubmit="return confirm('Bạn có chắc chắn muốn hủy đặt bàn này?');">
								<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
								<input type="hidden" name="returnUrl" th:value="'/cashier/tables/' + ${selectedTableId} + '/reservations'"/>
								<button type="submit" class="btn-cancel-reservation">❌ Hủy đặt bàn</button>
							</form>
						</div>
					</div>
				</div>
			</div>
		</section>
	</div>
</div>

<div class="toast-container" id="toast-container">
	<!-- Flash messages từ redirect (chỉ hiển thị nếu không phải lỗi validation modal) -->
	<div th:if="${successMessage}" class="toast success" style="display: block;">
		<span th:text="${successMessage}"></span>
	</div>
	<div th:if="${errorMessage != null and (showReservationModal == null or !showReservationModal)}" class="toast error" style="display: block;">
		<span th:text="${errorMessage}"></span>
	</div>
</div>

<!-- Modal Toast Container cho errors trong modal -->
<div class="modal-toast-container" id="modal-toast-container"></div>


<!-- Server Status Indicator - Góc trái dưới -->
<div class="server-status-container">
	<div id="server-status"><button class="btn" onclick="checkServerConnection()">Check connect to server</button></div>
</div>

<!-- Modal đặt bàn -->
<div id="reservation-modal" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<h2>Đặt trước bàn</h2>
			<span class="modal-close" onclick="closeReservationModal()">&times;</span>
		</div>
		<form id="reservation-form" th:action="@{/cashier/reservations}" method="post" th:object="${reservationCreateDTO}">
			<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
			<input type="hidden" id="table-id-hidden" th:field="*{tableId}"/>
			
			<div class="form-group">
				<label for="table-id-display">Bàn số</label>
				<input type="text" id="table-id-display" readonly class="form-control" th:field="*{tableId}">
			</div>
			
			<div class="form-group">
				<label for="customer-name">Tên khách hàng <span class="required">*</span></label>
				<input type="text" id="customer-name" th:field="*{customerName}" required 
				       th:classappend="${#fields.hasErrors('customerName')} ? 'is-invalid' : ''"
				       class="form-control">
				<div class="invalid-feedback" th:if="${#fields.hasErrors('customerName')}" th:errors="*{customerName}"></div>
			</div>
			
			<div class="form-group">
				<label for="customer-phone">Số điện thoại <span class="required">*</span></label>
				<input type="tel" id="customer-phone" th:field="*{customerPhone}" required 
				       th:classappend="${#fields.hasErrors('customerPhone')} ? 'is-invalid' : ''"
				       class="form-control">
				<div class="invalid-feedback" th:if="${#fields.hasErrors('customerPhone')}" th:errors="*{customerPhone}"></div>
			</div>
			
			<div class="form-group">
				<label for="customer-capacity">Số lượng dự kiến <span class="required">*</span></label>
				<input type="number" id="customer-capacity" th:field="*{capacityExpected}" required 
				       th:classappend="${#fields.hasErrors('capacityExpected')} ? 'is-invalid' : ''"
				       class="form-control">
				<div class="invalid-feedback" th:if="${#fields.hasErrors('capacityExpected')}" th:errors="*{capacityExpected}"></div>
			</div>
			
			<div class="form-row">
				<div class="form-group half">
					<label for="start-time">Thời gian bắt đầu <span class="required">*</span></label>
					<input type="datetime-local" id="start-time" th:field="*{startTime}" required 
					       th:classappend="${#fields.hasErrors('startTime')} ? 'is-invalid' : ''"
					       class="form-control">
					<div class="invalid-feedback" th:if="${#fields.hasErrors('startTime')}" th:errors="*{startTime}"></div>
				</div>
			</div>
			
			<div class="form-group">
				<label for="note">Ghi chú (tùy chọn)</label>
				<textarea id="note" th:field="*{note}" 
				          th:classappend="${#fields.hasErrors('note')} ? 'is-invalid' : ''"
				          class="form-control" rows="3"
				          placeholder="Nhập ghi chú nếu có..."></textarea>
				<div class="invalid-feedback" th:if="${#fields.hasErrors('note')}" th:errors="*{note}"></div>
			</div>
			
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" onclick="closeReservationModal()">Hủy</button>
				<button type="submit" class="btn btn-primary">Xác nhận đặt bàn</button>
			</div>
		</form>
	</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    const $clock = document.getElementById('clock');
    const $date = document.getElementById('date');

    function render() {
        const now = new Date();
        $clock.textContent = now.toLocaleTimeString('vi-VN', {hour12: false});
        $date.textContent = now.toLocaleDateString('vi-VN',
            {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
    }
    
    render();
    setInterval(render, 1000);

    document.addEventListener('DOMContentLoaded', function() {
        const toasts = document.querySelectorAll('.toast-container .toast');
        toasts.forEach(toast => {
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 5000);
        });
    });
</script>

<script th:src="@{/js/cashier/utils.js}"></script>
<script th:src="@{/js/cashier/websocket.js}"></script>
<script th:src="@{/js/cashier/table.js}"></script>
<script th:src="@{/js/cashier/reservation.js}"></script>

<!-- Script đơn giản để mở modal khi có lỗi -->
<script th:inline="javascript">
    window.addEventListener('DOMContentLoaded', function() {
        var showModal = /*[[${showReservationModal}]]*/ false;
        
        console.log('Show modal?', showModal);
        
        if (showModal) {
            console.log('✓ Có lỗi validation - mở modal');
	        
            setTimeout(function() {
                var modal = document.getElementById('reservation-modal');
                if (modal) {
                    modal.classList.add('show');
                }
            }, 100);
        }
    });
</script>

</body>
</html>


