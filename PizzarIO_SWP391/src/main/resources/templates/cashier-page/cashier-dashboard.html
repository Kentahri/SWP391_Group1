<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Cashier Dashboard - Table Management</title>
	<link rel="stylesheet" th:href="@{/css/cashier-dashboard.css}">
</head>
<body>
<div class="dashboard-container">
	<!-- Top bar -->
	<header class="topbar">
		<div class="brand">🍕 PizzarIO</div>
		<div class="staff-info">
			<span>Tên: <strong th:text="${staff.name}"></strong></span>
		</div>
		<div class="datetime-info">
			<div id="clock" class="clock">--:--:--</div>
			<div id="date" class="date">--/--/----</div>
		</div>
		<div class="actions">
			<button class="btn btn-secondary"><a th:href="@{/cashier/reservations/upcoming}" style="text-decoration: none">📅 Bàn đã đặt trước</a></button>
			<button class="btn btn-primary" type="button">➕ Tạo đơn hàng</button>
			<button class="btn btn-secondary" type="button">📋 Lịch sử</button>
			<form th:action="@{/logout}" method="post">
				<input type="hidden"
				       th:if="${_csrf != null}"
				       th:name="${_csrf.parameterName}"
				       th:value="${_csrf.token}"/>
				<button type="submit" class="btn-logout" onclick="return confirmLogout()">🚪 Đăng xuất</button>
			</form>
		</div>
	</header>
	
	<div class="layout">
		<!-- Left: Table Management -->
		<section class="panel left">
			<div class="section-title">Quản lý bàn</div>
			
			<!-- Legend -->
			<div class="legend">
				<div class="legend-items">
					<div class="legend-item">
						<span class="legend-dot available"></span>
						<span>Bàn đang trống</span>
					</div>
					<div class="legend-item">
						<span class="legend-dot occupied"></span>
						<span>Bàn đang có khách</span>
					</div>
					<div class="legend-item">
						<span class="legend-dot paid"></span>
						<span>Bàn đang chờ thanh toán</span>
					</div>
					<div class="legend-item">
						<span class="legend-dot reserved"></span>
						<span>Bàn đã được đặt trước</span>
					</div>
				</div>
			</div>
			
			<!-- Table Grid -->
			<div class="table-grid" id="table-grid">
				<a th:each="table : ${tables}"
				   th:id="'table-' + ${table.id}"
				   th:class="'table-card ' + ${table.tableStatus.toString().toLowerCase()} + ${selectedTableId != null && selectedTableId == table.id ? ' selected' : ''}"
				   th:href="@{/cashier/tables/{id}/order(id=${table.id})}"
				   th:attr="data-id=${table.id},
				            data-status=${table.tableStatus},
				            data-capacity=${table.capacity}"
				   style="text-decoration: none; color: inherit; cursor: pointer;">
					<div class="table-icon">
						<span th:if="${table.tableStatus == 'AVAILABLE'}">🪑</span>
						<span th:if="${table.tableStatus == 'OCCUPIED'}">👥</span>
						<span th:if="${table.tableStatus == 'WAITING_PAYMENT'}">✅</span>
						<span th:if="${table.tableStatus == 'RESERVED'}">🕐</span>
					</div>
					<div class="table-number">Bàn [[${table.id}]]</div>
					<div class="table-info">
						<!-- Hiển thị số người -->
						<div class="party-size" th:if="${table.tableStatus != 'AVAILABLE'}">
							Số người tối đa: <span th:text="${table.capacity != null ? table.capacity : 'N/A'}">N/A</span>
						</div>
						
						<!-- Hiển thị trạng thái -->
						<div class="table-status-text">
							<span th:if="${table.tableStatus == 'AVAILABLE'}">Available</span>
							<span th:if="${table.tableStatus == 'OCCUPIED'}">Occupied</span>
							<span th:if="${table.tableStatus == 'WAITING_PAYMENT'}">Paid</span>
							<span th:if="${table.tableStatus == 'RESERVED'}">Reserved</span>
						</div>
						
						<!-- Hiển thị thông tin bổ sung -->
						<div class="table-extra-info" th:if="${table.tableStatus == 'WAITING_PAYMENT'}">
							<span>Payment</span>
						</div>
						<div class="table-extra-info" th:if="${table.tableStatus == 'RESERVED'}">
							<span>Reserved</span>
						</div>
					</div>
				</a>
			</div>
		</section>
		
		<!-- Right: Table details -->
		<section class="panel right">
			<div class="section-title" id="right-panel-title">
				<span th:text="${upcomingReservations != null ? 'Danh sách đặt bàn sắp tới' : (tableReservations != null ? 'Đơn đặt trước - Bàn ' + selectedTableId : 'Đơn bàn chi tiết')}">Đơn bàn chi tiết</span>
			</div>
			
			<!-- Table Detail View (default - no table selected) -->
			<div id="table-detail" class="table-detail" th:if="${orderDetail == null && selectedTableId == null && upcomingReservations == null && tableReservations == null}">
				<div class="placeholder">Chọn 1 bàn để xem chi tiết</div>
			</div>
			
			<!-- Empty Table View (table selected but no order) -->
			<div th:if="${selectedTableId != null && orderDetail == null && upcomingReservations == null && tableReservations == null}" class="table-detail">
				<div class="detail-card">
					<div class="detail-row"><strong>Bàn số:</strong> <span th:text="${selectedTableId}">—</span></div>
					
					<div style="margin-top: 12px; display: flex; flex-direction: column; gap: 8px;">
						<button class="btn-reserve" th:onclick="'openReservationModal(' + ${selectedTableId} + ')'">
							📅 Đặt trước bàn này
						</button>
						<a th:href="@{/cashier/tables/{tableId}/reservations(tableId=${selectedTableId})}" class="btn-view-reservations">
							📋 Xem đơn đặt trước
						</a>
					</div>
				</div>
			</div>
			
			<!-- Order Detail View (when table is selected and has order) -->
			<div th:if="${orderDetail != null}" class="table-detail">
				<div class="detail-card">
					<div class="detail-row"><strong>Bàn số:</strong> <span th:text="${selectedTableId}">—</span></div>
					<div class="detail-row"><strong>Số người tối đa:</strong> <span th:text="${tableCapacity}">—</span></div>
				</div>
				<div class="order-detail-card">
					<div class="order-header">
						<span th:class="'order-status ' + ${orderDetail.orderStatus.toString().toLowerCase()}" 
						      th:text="${orderDetail.orderStatus == 'PREPARING' ? 'Đang chuẩn bị' : (orderDetail.orderStatus == 'SERVED' ? 'Đã phục vụ' : (orderDetail.orderStatus == 'COMPLETED' ? 'Hoàn thành' : orderDetail.orderStatus))}">
						</span>
					</div>
					
					<div class="order-meta">
						<div class="meta-row">
							<span class="meta-label">Mã đơn:</span>
							<span class="meta-value">#<span th:text="${orderDetail.orderId}">—</span></span>
						</div>
						<div class="meta-row">
							<span class="meta-label">Trạng thái thanh toán:</span>
							<span th:class="'meta-value payment-' + ${orderDetail.paymentStatus.toString().toLowerCase()}" 
							      th:text="${orderDetail.paymentStatus == 'UNPAID' ? 'Chưa thanh toán' : (orderDetail.paymentStatus == 'PAID' ? 'Đã thanh toán' : 'Đang xử lý')}">
							</span>
						</div>
						<div class="meta-row" th:if="${orderDetail.paymentMethod != null}">
							<span class="meta-label">Phương thức:</span>
							<span class="meta-value" th:text="${orderDetail.paymentMethod == 'CASH' ? 'Tiền mặt' : (orderDetail.paymentMethod == 'QR' ? 'QR Code' : 'Thẻ tín dụng')}"></span>
						</div>
					</div>

					<div class="order-items-section">
						<div class="section-header-small">
							<span>Món đã gọi</span>
							<span class="item-count" th:text="${#lists.isEmpty(orderDetail.items) ? '0' : #aggregates.sum(orderDetail.items.![quantity])} + ' món'">0 món</span>
						</div>
						<div class="order-items-list">
							<div th:if="${#lists.isEmpty(orderDetail.items)}" class="no-items">Chưa có món nào</div>
							<div th:each="item : ${orderDetail.items}" class="order-item">
								<div class="order-item-info">
									<div class="item-name" th:text="${item.productName}">—</div>
									<div class="item-detail">
										<span class="item-quantity">x<span th:text="${item.quantity}">1</span></span>
										<span class="item-price" th:text="${#numbers.formatCurrency(item.unitPrice)}">0đ</span>
									</div>
									<div th:if="${item.note != null && !#strings.isEmpty(item.note)}" class="item-note">📝 <span th:text="${item.note}"></span></div>
								</div>
								<div class="item-total" th:text="${#numbers.formatCurrency(item.totalPrice)}">0đ</div>
							</div>
						</div>
					</div>

					<div class="order-summary">
						<div th:if="${orderDetail.voucherCode != null}" class="summary-row">
							<span>Voucher:</span>
							<span class="voucher-code" th:text="${orderDetail.voucherCode}">—</span>
						</div>
						<div th:if="${orderDetail.discountAmount != null && orderDetail.discountAmount > 0}" class="summary-row discount">
							<span>Giảm giá:</span>
							<span th:text="'-' + ${#numbers.formatCurrency(orderDetail.discountAmount)}">-0đ</span>
						</div>
						<div class="summary-row total">
							<span>Tổng cộng:</span>
							<span class="total-amount" th:text="${#numbers.formatCurrency(orderDetail.totalPrice)}">0đ</span>
						</div>
					</div>

					<div th:if="${orderDetail.note != null && !#strings.isEmpty(orderDetail.note)}" class="order-note">
						<strong>Ghi chú:</strong> <span th:text="${orderDetail.note}"></span>
					</div>
				</div>
				
				<div style="margin-top: 12px;">
					<a th:href="@{/cashier/tables/{tableId}/reservations(tableId=${selectedTableId})}" class="btn-view-reservations">
						📋 Xem đơn đặt trước
					</a>
				</div>
			</div>
			
			<!-- Upcoming Reservations View -->
			<div th:if="${upcomingReservations != null}" class="reservation-list">
				<div class="reservation-header">
					<a th:href="@{/cashier}" class="btn-back-styled">← Quay lại</a>
				</div>
				
				<!-- Search Form - chỉ hiện trong upcoming reservations -->
				<div class="search-container" style="margin: 16px 0;">
					<form th:action="@{/cashier/reservations/upcoming}" method="get" style="display: flex; gap: 8px;">
						<input type="text" 
						       name="search" 
						       th:value="${searchKeyword}" 
						       placeholder="Tìm theo tên, SĐT, hoặc số bàn..." 
						       class="search-input"
						       style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
						<button type="submit" class="btn btn-primary" style="padding: 10px 20px; white-space: nowrap;">🔍 Tìm kiếm</button>
						<a th:href="@{/cashier/reservations/upcoming}" class="btn btn-secondary" style="padding: 10px 20px; text-decoration: none; display: inline-block;">↻ Xóa lọc</a>
					</form>
				</div>
				
				<div class="reservation-items">
					<div th:if="${#lists.isEmpty(upcomingReservations)}" class="no-reservations-card">
						<div class="no-reservations-content">
							<div class="no-reservations-icon">📅</div>
							<div class="no-reservations-text">Chưa có đơn đặt bàn nào</div>
						</div>
					</div>
					
					<div th:each="reservation : ${upcomingReservations}" class="reservation-card">
					<div class="reservation-card-header">
						<div class="reservation-table-name">
							<span style="font-weight: 700; color: #2c3e50;" th:text="${reservation.tableName}">Bàn #</span>
							<span style="font-size: 12px; color: #6c757d; margin-left: 8px;">| Đơn #<span th:text="${reservation.id}">—</span></span>
						</div>
						<span th:class="'reservation-status ' + ${reservation.status.toString().toLowerCase()}" 
						      th:text="${reservation.status == 'CONFIRMED' ? 'Đã xác nhận' : 
						                (reservation.status == 'ARRIVED' ? 'Đã đến' : 
						                (reservation.status == 'CANCELED' ? 'Đã hủy' : 'Không đến'))}">
						</span>
					</div>
						
						<div class="reservation-time">
							🕐 Thời gian: <span th:text="${#temporals.format(reservation.startTime, 'EEE, dd MMM yyyy HH:mm')}">—</span>
						</div>
						
						<div class="reservation-info">
							<div class="reservation-info-row">
								<span class="reservation-info-label">👤 Khách hàng:</span>
								<span class="reservation-info-value" th:text="${reservation.customerName}">—</span>
							</div>
							<div class="reservation-info-row">
								<span class="reservation-info-label">📞 Số điện thoại:</span>
								<span class="reservation-info-value" th:text="${reservation.customerPhone}">—</span>
							</div>
							<div class="reservation-info-row">
								<span class="reservation-info-label">👥 Số khách:</span>
								<span class="reservation-info-value" th:text="${reservation.capacityExpected + ' người'}">— người</span>
							</div>
							<div th:if="${reservation.note != null && !#strings.isEmpty(reservation.note)}" class="reservation-info-row">
								<span class="reservation-info-label">📝 Ghi chú:</span>
								<span class="reservation-info-value" th:text="${reservation.note}">—</span>
							</div>
						</div>
						
					<div th:if="${reservation.status.toString() == 'CONFIRMED'}" class="reservation-actions" style="display: flex; flex-direction: column; gap: 8px;">
						<!-- Nút mở bàn cho khách (nút chính) -->
						<form th:action="@{/cashier/reservations/{id}/open(id=${reservation.id})}" method="post" 
						      onsubmit="return confirm('Xác nhận khách đã đến và mở bàn?');">
							<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
							<input type="hidden" name="returnUrl" value="/cashier/reservations/upcoming"/>
							<button type="submit" class="btn-open-table" 
							        style="width: 100%; padding: 12px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 15px;">
								🔓 Mở bàn cho khách
							</button>
						</form>
						
						<!-- Các nút phụ -->
						<div style="display: flex; gap: 8px;">
							<a th:href="@{/cashier/reservations/{id}/edit(id=${reservation.id}, returnUrl='/cashier/reservations/upcoming')}" 
							   class="btn-edit-reservation"
							   style="flex: 1; text-align: center; padding: 10px; background-color: #4CAF50; color: white; border-radius: 4px; text-decoration: none; border: none; cursor: pointer;">
								✏️ Sửa
							</a>
							<form th:action="@{/cashier/reservations/{id}/delete(id=${reservation.id})}" method="post" 
							      onsubmit="return confirm('Bạn có chắc chắn muốn hủy đặt bàn này?');"
							      style="flex: 1;">
								<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
								<input type="hidden" name="returnUrl" value="/cashier/reservations/upcoming"/>
								<button type="submit" class="btn-cancel-reservation" style="width: 100%;">❌ Hủy đặt bàn</button>
							</form>
						</div>
					</div>
					</div>
				</div>
			</div>
			
			<!-- Table Reservations View -->
			<div th:if="${tableReservations != null}" class="reservation-list">
				<div class="detail-card" style="margin-bottom: 16px; box-shadow: none">
					<div class="reservation-header">
						<a th:href="@{/cashier/tables/{id}/order(id=${selectedTableId})}" class="btn-back-styled">
							← Quay lại bàn <span th:text="${selectedTableId}">—</span>
						</a>
					</div>
				</div>
				<div class="reservation-items">
					<div th:if="${#lists.isEmpty(tableReservations)}" class="no-reservations-card">
						<div class="no-reservations-content">
							<div class="no-reservations-icon">📅</div>
							<div class="no-reservations-text">Chưa có đơn đặt bàn nào</div>
						</div>
					</div>
					
					<div th:each="reservation : ${tableReservations}" class="reservation-card">
						<div class="reservation-card-header">
							<div class="reservation-table-name">
								<span style="font-weight: 700; color: #2c3e50;">Bàn <span th:text="${reservation.tableId}">#</span></span>
								<span style="font-size: 12px; color: #6c757d; margin-left: 8px;">| Đơn #<span th:text="${reservation.id}">—</span></span>
							</div>
							<span th:class="'reservation-status ' + ${reservation.status.toString().toLowerCase()}" 
							      th:text="${reservation.status == 'CONFIRMED' ? 'Đã xác nhận' : 
							                (reservation.status == 'ARRIVED' ? 'Đã đến' : 
							                (reservation.status == 'CANCELED' ? 'Đã hủy' : 'Không đến'))}">
							</span>
						</div>
						
						<div class="reservation-time">
							🕐 <span th:text="${#temporals.format(reservation.startTime, 'EEE, dd MMM yyyy HH:mm')}">—</span>
						</div>
						
						<div class="reservation-info">
							<div class="reservation-info-row">
								<span class="reservation-info-label">👤 Khách hàng:</span>
								<span class="reservation-info-value" th:text="${reservation.customerName}">—</span>
							</div>
							<div class="reservation-info-row">
								<span class="reservation-info-label">📞 Số điện thoại:</span>
								<span class="reservation-info-value" th:text="${reservation.customerPhone}">—</span>
							</div>
							<div class="reservation-info-row">
								<span class="reservation-info-label">👥 Số khách:</span>
								<span class="reservation-info-value" th:text="${reservation.capacityExpected + ' người'}">— người</span>
							</div>
							<div th:if="${reservation.note != null && !#strings.isEmpty(reservation.note)}" class="reservation-info-row">
								<span class="reservation-info-label">📝 Ghi chú:</span>
								<span class="reservation-info-value" th:text="${reservation.note}">—</span>
							</div>
						</div>
						
						<div th:if="${reservation.status.toString() == 'CONFIRMED'}" class="reservation-actions">
							<!-- Nút mở bàn cho khách (nút chính) -->
							<form th:action="@{/cashier/reservations/{id}/open(id=${reservation.id})}" method="post" 
							      onsubmit="return confirm('Xác nhận khách đã đến và mở bàn?');">
								<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
								<input type="hidden" name="returnUrl" th:value="'/cashier/tables/' + ${selectedTableId} + '/reservations'"/>
								<button type="submit" class="btn-open-table">
									🔓 Mở bàn cho khách
								</button>
							</form>
							
							<!-- Các nút phụ -->
							<div class="reservation-secondary-actions">
								<a th:href="@{/cashier/reservations/{id}/edit(id=${reservation.id}, returnUrl='/cashier/tables/' + ${selectedTableId} + '/reservations')}" 
								   class="btn-edit-reservation">
									✏️ Sửa
								</a>
								<form th:action="@{/cashier/reservations/{id}/delete(id=${reservation.id})}" method="post" 
								      onsubmit="return confirm('Bạn có chắc chắn muốn hủy đặt bàn này?');">
									<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
									<input type="hidden" name="returnUrl" th:value="'/cashier/tables/' + ${selectedTableId} + '/reservations'"/>
									<button type="submit" class="btn-cancel-reservation">❌ Hủy đặt bàn</button>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
	</div>
</div>

<div class="toast-container" id="toast-container">
	<!-- Flash messages từ redirect (chỉ hiển thị nếu không phải lỗi validation modal) -->
	<div th:if="${successMessage}" class="toast success" style="display: block;">
		<span th:text="${successMessage}"></span>
	</div>
	<div th:if="${errorMessage != null and (showReservationModal == null or !showReservationModal)}" class="toast error" style="display: block;">
		<span th:text="${errorMessage}"></span>
	</div>
</div>

<!-- Modal Toast Container cho errors trong modal -->
<div class="modal-toast-container" id="modal-toast-container"></div>


<!-- Server Status Indicator - Góc trái dưới -->
<div class="server-status-container">
	<div id="server-status">
		<button class="btn btn-server-check" onclick="checkServerConnection()">
			🔗 Kiểm tra kết nối với server
		</button>
	</div>
</div>

<!-- Modal đặt bàn -->
<div id="reservation-modal" class="modal">
	<div class="modal-content">
		<div class="modal-header">
			<h2>Đặt trước bàn</h2>
			<span class="modal-close" onclick="closeReservationModal()">&times;</span>
		</div>
		<div class="modal-body">
			<form id="reservation-form" th:action="@{/cashier/reservations}" method="post" th:object="${reservationCreateDTO}">
				<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
				<input type="hidden" id="table-id-hidden" th:field="*{tableId}"/>
				
				<!-- Hiển thị lỗi chung (global errors) -->
				<div th:if="${#fields.hasGlobalErrors()}" class="form-alert-error">
					<span class="alert-icon">⚠️</span>
					<div th:each="error : ${#fields.globalErrors()}" th:text="${error}" class="error-message"></div>
				</div>
				
				<div class="form-group">
					<label for="table-id-display">Bàn số</label>
					<input type="text" id="table-id-display" readonly class="form-control" th:field="*{tableId}">
				</div>
				
				<div class="form-group">
					<label for="customer-name">Tên khách hàng <span class="required">*</span></label>
					<input type="text" id="customer-name" th:field="*{customerName}" required 
					       th:classappend="${#fields.hasErrors('customerName')} ? 'is-invalid' : ''"
					       class="form-control">
					<div class="invalid-feedback" th:if="${#fields.hasErrors('customerName')}" th:errors="*{customerName}"></div>
				</div>
				
				<div class="form-group">
					<label for="customer-phone">Số điện thoại <span class="required">*</span></label>
					<input type="tel" id="customer-phone" th:field="*{customerPhone}" required 
					       th:classappend="${#fields.hasErrors('customerPhone')} ? 'is-invalid' : ''"
					       class="form-control">
					<div class="invalid-feedback" th:if="${#fields.hasErrors('customerPhone')}" th:errors="*{customerPhone}"></div>
				</div>
				
				<div class="form-group">
					<label for="customer-capacity">Số lượng dự kiến <span class="required">*</span></label>
					<input type="number" id="customer-capacity" th:field="*{capacityExpected}" required 
					       th:classappend="${#fields.hasErrors('capacityExpected')} ? 'is-invalid' : ''"
					       class="form-control">
					<div class="invalid-feedback" th:if="${#fields.hasErrors('capacityExpected')}" th:errors="*{capacityExpected}"></div>
				</div>
				
				<div class="form-row">
					<div class="form-group half">
						<label for="start-time">Thời gian bắt đầu <span class="required">*</span></label>
						<input type="datetime-local" id="start-time" th:field="*{startTime}" required 
						       th:classappend="${#fields.hasErrors('startTime')} ? 'is-invalid' : ''"
						       class="form-control">
						<div class="invalid-feedback" th:if="${#fields.hasErrors('startTime')}" th:errors="*{startTime}"></div>
					</div>
				</div>
				
				<div class="form-group">
					<label for="note">Ghi chú (tùy chọn)</label>
					<textarea id="note" th:field="*{note}" 
					          th:classappend="${#fields.hasErrors('note')} ? 'is-invalid' : ''"
					          class="form-control" rows="3"
					          placeholder="Nhập ghi chú nếu có..."></textarea>
					<div class="invalid-feedback" th:if="${#fields.hasErrors('note')}" th:errors="*{note}"></div>
				</div>
			</form>
		</div>
		<div class="modal-footer">
			<button type="button" class="btn btn-secondary" onclick="closeReservationModal()">Hủy</button>
			<button type="submit" form="reservation-form" class="btn btn-primary">Xác nhận đặt bàn</button>
		</div>
	</div>
</div>

<!-- Modal cập nhật đặt bàn -->
<div id="update-reservation-modal" class="modal" th:if="${reservationUpdateDTO != null}">
	<div class="modal-content">
		<div class="modal-header">
			<h2>Cập nhật đặt bàn</h2>
			<span class="modal-close" onclick="closeUpdateModal()">&times;</span>
		</div>
		<div class="modal-body">
			<form id="update-reservation-form" 
			      th:action="@{/cashier/reservations/{id}/update(id=${reservationUpdateDTO.id})}" 
			      method="post" 
			      th:object="${reservationUpdateDTO}">
				<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
				<input type="hidden" name="returnUrl" th:value="${returnUrl}"/>
				
				<!-- Hiển thị lỗi chung (global errors) -->
				<div th:if="${#fields.hasGlobalErrors()}" class="form-alert-error">
					<span class="alert-icon">⚠️</span>
					<div th:each="error : ${#fields.globalErrors()}" th:text="${error}" class="error-message"></div>
				</div>
				
				<div class="form-group">
					<label for="update-table-id">Bàn số</label>
					<input type="text" id="update-table-id" readonly class="form-control" th:value="'Bàn ' + ${reservationUpdateDTO.tableId}">
				</div>
				
				<div class="form-group">
					<label for="update-customer-name">Tên khách hàng <span class="required">*</span></label>
					<input type="text" id="update-customer-name" th:field="*{customerName}" required 
					       th:classappend="${#fields.hasErrors('customerName')} ? 'is-invalid' : ''"
					       class="form-control">
					<div class="invalid-feedback" th:if="${#fields.hasErrors('customerName')}" th:errors="*{customerName}"></div>
				</div>
				
				<div class="form-group">
					<label for="update-customer-phone">Số điện thoại <span class="required">*</span></label>
					<input type="tel" id="update-customer-phone" th:field="*{customerPhone}" required 
					       th:classappend="${#fields.hasErrors('customerPhone')} ? 'is-invalid' : ''"
					       class="form-control">
					<div class="invalid-feedback" th:if="${#fields.hasErrors('customerPhone')}" th:errors="*{customerPhone}"></div>
				</div>
				
				<div class="form-group">
					<label for="update-customer-capacity">Số lượng dự kiến <span class="required">*</span></label>
					<input type="number" id="update-customer-capacity" th:field="*{capacityExpected}" required 
					       th:classappend="${#fields.hasErrors('capacityExpected')} ? 'is-invalid' : ''"
					       class="form-control">
					<div class="invalid-feedback" th:if="${#fields.hasErrors('capacityExpected')}" th:errors="*{capacityExpected}"></div>
				</div>
				
				<div class="form-row">
					<div class="form-group half">
						<label for="update-start-time">Thời gian bắt đầu <span class="required">*</span></label>
						<input type="datetime-local" id="update-start-time" th:field="*{startTime}" required 
						       th:classappend="${#fields.hasErrors('startTime')} ? 'is-invalid' : ''"
						       class="form-control">
						<div class="invalid-feedback" th:if="${#fields.hasErrors('startTime')}" th:errors="*{startTime}"></div>
					</div>
				</div>
				
				<div class="form-group">
					<label for="update-note">Ghi chú (tùy chọn)</label>
					<textarea id="update-note" th:field="*{note}" 
					          th:classappend="${#fields.hasErrors('note')} ? 'is-invalid' : ''"
					          class="form-control" rows="3"
					          placeholder="Nhập ghi chú nếu có..."></textarea>
					<div class="invalid-feedback" th:if="${#fields.hasErrors('note')}" th:errors="*{note}"></div>
				</div>
			</form>
		</div>
		<div class="modal-footer">
			<button type="button" class="btn btn-secondary" onclick="closeUpdateModal()">Hủy</button>
			<button type="submit" form="update-reservation-form" class="btn btn-primary">Cập nhật</button>
		</div>
	</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script th:src="@{/js/cashier/utils.js}"></script>
<script th:src="@{/js/cashier/reservation.js}"></script>
<script>
    const $clock = document.getElementById('clock');
    const $date = document.getElementById('date');

    function render() {
        const now = new Date();
        $clock.textContent = now.toLocaleTimeString('vi-VN', {hour12: false});
        $date.textContent = now.toLocaleDateString('vi-VN',
            {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
    }
    
    render();
    setInterval(render, 1000);

    document.addEventListener('DOMContentLoaded', function() {
        const toasts = document.querySelectorAll('.toast-container .toast');
        toasts.forEach(toast => {
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 5000);
        });
    });
    
    // Custom logout confirmation
    function confirmLogout() {
        return confirm('Bạn có muốn đăng xuất không?');
    }
</script>

<script th:src="@{/js/cashier/cashier-dashboard.js}"></script>
<script th:src="@{/js/cashier/utils.js}"></script>
<script th:src="@{/js/cashier/websocket.js}"></script>
<script th:src="@{/js/cashier/table.js}"></script>
<script th:src="@{/js/cashier/reservation.js}"></script>

<script th:inline="javascript">
    window.addEventListener('DOMContentLoaded', function() {
        var showModal = /*[[${showReservationModal}]]*/ false;
        var showUpdateModal = /*[[${showUpdateModal}]]*/ false;
        
        if (showModal) {
            setTimeout(function() {
                var modal = document.getElementById('reservation-modal');
                if (modal) {
                    modal.classList.add('show');
                }
            }, 100);
        }
        
        if (showUpdateModal) {
            setTimeout(function() {
                var modal = document.getElementById('update-reservation-modal');
                if (modal) {
                    modal.classList.add('show');
                    // Đảm bảo modal hiển thị đúng cách
                    document.body.style.overflow = 'hidden';
                    
                    // Format datetime-local input
                    var startTimeInput = document.getElementById('update-start-time');
                    if (startTimeInput && startTimeInput.value) {
                        // Convert the datetime value to proper format for datetime-local input
                        var dateValue = new Date(startTimeInput.value);
                        if (!isNaN(dateValue.getTime())) {
                            startTimeInput.value = formatDateTimeLocal(dateValue);
                        }
                    }
                }
            }, 100);
        }
    });
    
    function closeUpdateModal() {
        var modal = document.getElementById('update-reservation-modal');
        if (modal) {
            modal.classList.remove('show');
            // Đảm bảo không có blur effect nào còn lại
            document.body.style.overflow = '';
            document.body.style.filter = '';
        }
    }
    
    // Xử lý khi click ra ngoài modal để đóng
    document.addEventListener('click', function(event) {
        var updateModal = document.getElementById('update-reservation-modal');
        if (updateModal && event.target === updateModal) {
            closeUpdateModal();
        }
    });
    
    // Xử lý khi nhấn ESC để đóng modal
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            var updateModal = document.getElementById('update-reservation-modal');
            if (updateModal && updateModal.classList.contains('show')) {
                closeUpdateModal();
            }
        }
    });
</script>

</body>
</html>


