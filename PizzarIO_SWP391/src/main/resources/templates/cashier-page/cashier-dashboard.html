<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cashier Dashboard - Table Management</title>
    <link rel="stylesheet" th:href="@{/css/cashier-dashboard.css}" />
    <style>
      .order-status.preparing {
        background: #fff3cd;
        color: #856404;
      }
      .order-status.served {
        background: #d1ecf1;
        color: #0c5460;
      }
      .order-status.completed {
        background: #d4edda;
        color: #155724;
      }
      .payment-status.paid {
        background: #d4edda;
        color: #155724;
      }
      .payment-status.unpaid {
        background: #f8d7da;
        color: #721c24;
      }
      .payment-status.pending {
        background: #fff3cd;
        color: #856404;
      }
      .order-status.cancelled {
        background: #f8d7da;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Top bar -->
      <header class="topbar">
        <div class="brand">üçï PizzarIO</div>
        <div class="staff-info">
          <span>T√™n: <strong th:text="${staff.name}"></strong></span>
        </div>
        <div class="datetime-info">
          <div id="clock" class="clock">--:--:--</div>
          <div id="date" class="date">--/--/----</div>
        </div>
        <div class="actions">
          <!-- Notification Bell -->
          <button class="btn btn-notification" type="button" onclick="openNotificationModal()">
            <span class="notification-icon">üîî</span>
            <span class="notification-badge" id="notification-badge" style="display: none;">0</span>
          </button>

          <button class="btn btn-secondary">
            <a
              th:href="@{/cashier/reservations/upcoming}"
              style="text-decoration: none"
              >üìÖ B√†n ƒë√£ ƒë·∫∑t tr∆∞·ªõc</a
            >
          </button>
          <a
            class="btn btn-primary"
            th:href="@{/cashier/takeaway}"
            style="text-decoration: none; display: inline-block"
            target="_blank"
          >‚ûï T·∫°o ƒë∆°n h√†ng</a
          >
          <button class="btn btn-secondary" type="button">
            <a th:href="@{/cashier/history}" style="text-decoration: none"
              >üìã L·ªãch s·ª≠</a
            >
          </button>
          <form th:action="@{/logout}" method="post">
            <input
              type="hidden"
              th:if="${_csrf != null}"
              th:name="${_csrf.parameterName}"
              th:value="${_csrf.token}"
            />
            <button
              type="submit"
              class="btn-logout"
              onclick="return confirmLogout()"
            >
              üö™ ƒêƒÉng xu·∫•t
            </button>
          </form>
        </div>
      </header>

      <div class="layout">
        <!-- Left: Table Management -->
        <section class="panel left" id="left-panel">
          <div class="section-title">Qu·∫£n l√Ω b√†n</div>

          <!-- Legend -->
          <div class="legend">
            <div class="legend-items">
              <div class="legend-item">
                <span class="legend-dot available"></span>
                <span>B√†n ƒëang tr·ªëng</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot occupied"></span>
                <span>B√†n ƒëang c√≥ kh√°ch</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot paid"></span>
                <span>B√†n ƒëang ch·ªù thanh to√°n</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot reserved"></span>
                <span>B√†n ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t tr∆∞·ªõc</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot locked"></span>
                <span>B√†n b·ªã kh√≥a (g·ªôp b√†n)</span>
              </div>
            </div>
          </div>

          <!-- Table Grid -->
          <div class="table-grid" id="table-grid">
            <a
              th:each="table : ${tables}"
              th:id="'table-' + ${table.id}"
              th:class="'table-card ' + ${table.tableStatus.toString().toLowerCase()} + ${selectedTableId != null && selectedTableId == table.id ? ' selected' : ''}"
              th:href="@{/cashier/tables/{id}/order(id=${table.id})}"
              th:attr="data-id=${table.id},
				            data-status=${table.tableStatus},
				            data-capacity=${table.capacity}"
              style="text-decoration: none; color: inherit; cursor: pointer"
            >
              <div class="table-icon">
                <span th:if="${table.tableStatus == 'AVAILABLE'}">ü™ë</span>
                <span th:if="${table.tableStatus == 'OCCUPIED'}">üë•</span>
                <span th:if="${table.tableStatus == 'WAITING_PAYMENT'}"
                  >‚úÖ</span
                >
                <span th:if="${table.tableStatus == 'RESERVED'}">üïê</span>
                <span th:if="${table.tableStatus == 'LOCKED'}">üîí</span>
              </div>
              <div class="table-number">B√†n [[${table.id}]]</div>
              <div class="table-info">
                <!-- Hi·ªÉn th·ªã s·ªë ng∆∞·ªùi -->
                <div
                  class="party-size"
                  th:if="${table.tableStatus != 'AVAILABLE'}"
                >
                  S·ªë ng∆∞·ªùi t·ªëi ƒëa:
                  <span
                    th:text="${table.capacity != null ? table.capacity : 'N/A'}"
                    >N/A</span
                  >
                </div>

                <!-- Hi·ªÉn th·ªã tr·∫°ng th√°i -->
                <div class="table-status-text">
                  <span th:if="${table.tableStatus == 'AVAILABLE'}"
                    >Available</span
                  >
                  <span th:if="${table.tableStatus == 'OCCUPIED'}"
                    >Occupied</span
                  >
                  <span th:if="${table.tableStatus == 'WAITING_PAYMENT'}"
                    >Paid</span
                  >
                  <span th:if="${table.tableStatus == 'RESERVED'}"
                    >Reserved</span
                  >
                  <span th:if="${table.tableStatus == 'LOCKED'}"
                    >Locked</span
                  >
                </div>

                <!-- Hi·ªÉn th·ªã th√¥ng tin b·ªï sung -->
                <div
                  class="table-extra-info"
                  th:if="${table.tableStatus == 'WAITING_PAYMENT'}"
                >
                  <span>Payment</span>
                </div>
                <div
                  class="table-extra-info"
                  th:if="${table.tableStatus == 'RESERVED'}"
                >
                  <span>Reserved</span>
                </div>
                <div
                  class="table-extra-info"
                  th:if="${table.tableStatus == 'LOCKED'}"
                >
                  <span>Merged</span>
                </div>
              </div>
            </a>
          </div>
        </section>

        <!-- Resizable Divider -->
        <div class="resize-handle" id="resize-handle"></div>

        <!-- Right: Table details -->
        <section class="panel right" id="right-panel">
          <div
            class="section-title"
            id="right-panel-title"
            th:if="${showHistory == null || !showHistory}"
          >
            <span
              th:text="${upcomingReservations != null ? 'Danh s√°ch ƒë·∫∑t b√†n s·∫Øp t·ªõi' : (tableReservations != null ? 'ƒê∆°n ƒë·∫∑t tr∆∞·ªõc - B√†n ' + selectedTableId : 'ƒê∆°n b√†n chi ti·∫øt')}"
              >ƒê∆°n b√†n chi ti·∫øt</span
            >
          </div>

          <!-- Table Detail View (default - no table selected) -->
          <div
            id="table-detail"
            class="table-detail"
            th:if="${orderDetail == null && selectedTableId == null && upcomingReservations == null && tableReservations == null && (showHistory == null || !showHistory)}"
          >
            <div class="placeholder">Ch·ªçn 1 b√†n ƒë·ªÉ xem chi ti·∫øt</div>
          </div>

          <!-- Empty Table View (table selected but no order) -->
          <div
            th:if="${selectedTableId != null && orderDetail == null && upcomingReservations == null && tableReservations == null && (showHistory == null || !showHistory)}"
            class="table-detail"
          >
            <div class="detail-card">
              <!-- Th√¥ng tin b√†n -->
              <div class="detail-row">
                <strong>B√†n s·ªë:</strong>
                <span th:text="${selectedTableId}">‚Äî</span>
              </div>
              <div class="detail-row">
                <strong>S·ª©c ch·ª©a:</strong>
                <span><span th:text="${tableCapacity}">‚Äî</span> ng∆∞·ªùi</span>
              </div>
              <div class="detail-row">
                <strong>Tr·∫°ng th√°i:</strong>
                <span
                  th:text="${tableStatus.toString() == 'AVAILABLE' ? 'B√†n ƒëang tr·ªëng' :
                            (tableStatus.toString() == 'OCCUPIED' ? 'B√†n c√≥ kh√°ch' :
                            (tableStatus.toString() == 'RESERVED' ? 'ƒê√£ ƒë·∫∑t tr∆∞·ªõc' :
                            (tableStatus.toString() == 'WAITING_PAYMENT' ? 'Ch·ªù thanh to√°n' :
                            (tableStatus.toString() == 'LOCKED' ? 'ƒêang kh√≥a' : '‚Äî'))))}"
                  th:style="${tableStatus.toString() == 'AVAILABLE' ? 'color: #28a745; font-weight: 600;' :
                             (tableStatus.toString() == 'OCCUPIED' ? 'color: #dc3545; font-weight: 600;' :
                             (tableStatus.toString() == 'RESERVED' ? 'color: #ffc107; font-weight: 600;' :
                             (tableStatus.toString() == 'WAITING_PAYMENT' ? 'color: #17a2b8; font-weight: 600;' :
                             (tableStatus.toString() == 'LOCKED' ? 'color: #795548; font-weight: 600;' : ''))))}"
                >‚Äî</span>
              </div>

              <!-- N√∫t actions ·ªü d∆∞·ªõi -->
              <div class="table-actions">
                <!-- N√∫t m·ªü kh√≥a b√†n (ch·ªâ hi·ªÉn th·ªã khi b√†n LOCKED) -->
                <form
                  th:if="${tableStatus != null && tableStatus.toString() == 'LOCKED'}"
                  th:action="@{/cashier/tables/{tableId}/unlock(tableId=${selectedTableId})}"
                  method="post"
                  onsubmit="return confirm('X√°c nh·∫≠n m·ªü kh√≥a b√†n n√†y?');"
                >
                  <input
                    type="hidden"
                    th:name="${_csrf.parameterName}"
                    th:value="${_csrf.token}"
                  />
                  <button
                    type="submit"
                    class="btn-action btn-unlock"
                  >
                    üîì M·ªü kh√≥a b√†n
                  </button>
                </form>

                <!-- C√°c n√∫t kh√°c (ch·ªâ hi·ªÉn th·ªã khi b√†n KH√îNG LOCKED) -->
                <div
                  th:if="${tableStatus == null || tableStatus.toString() != 'LOCKED'}"
                  class="action-buttons-group"
                >
                  <button
                    class="btn-action btn-reserve"
                    th:onclick="'openReservationModal(' + ${selectedTableId} + ')'"
                  >
                    üìÖ ƒê·∫∑t tr∆∞·ªõc b√†n n√†y
                  </button>
                  <a
                    th:href="@{/cashier/tables/{tableId}/reservations(tableId=${selectedTableId})}"
                    class="btn-action btn-view-reservations"
                  >
                    üìã Xem ƒë∆°n ƒë·∫∑t tr∆∞·ªõc
                  </a>

                  <form
                    th:if="${tableStatus != null && tableStatus.toString() == 'AVAILABLE'}"
                    th:action="@{/cashier/tables/{tableId}/lock(tableId=${selectedTableId})}"
                    method="post"
                    onsubmit="return confirm('X√°c nh·∫≠n kh√≥a b√†n n√†y ƒë·ªÉ g·ªôp b√†n?');"
                  >
                    <input
                      type="hidden"
                      th:name="${_csrf.parameterName}"
                      th:value="${_csrf.token}"
                    />
                    <button
                      type="submit"
                      class="btn-action btn-lock"
                    >
                      üîí Kh√≥a b√†n
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Order Detail View (when table is selected and has order) -->
          <div
            th:if="${orderDetail != null && (showHistory == null || !showHistory)}"
            class="table-detail"
          >
            <div class="detail-card">
              <!-- Th√¥ng tin b√†n -->
              <div class="detail-row">
                <strong>B√†n s·ªë:</strong>
                <span th:text="${selectedTableId}">‚Äî</span>
              </div>
              <div class="detail-row">
                <strong>S·ª©c ch·ª©a:</strong>
                <span><span th:text="${tableCapacity}">‚Äî</span> ng∆∞·ªùi</span>
              </div>
              <div class="detail-row">
                <strong>Tr·∫°ng th√°i:</strong>
                <span
                  th:text="${tableStatus.toString() == 'AVAILABLE' ? 'B√†n ƒëang tr·ªëng' :
                            (tableStatus.toString() == 'OCCUPIED' ? 'B√†n c√≥ kh√°ch' :
                            (tableStatus.toString() == 'RESERVED' ? 'ƒê√£ ƒë·∫∑t tr∆∞·ªõc' :
                            (tableStatus.toString() == 'WAITING_PAYMENT' ? 'Ch·ªù thanh to√°n' :
                            (tableStatus.toString() == 'LOCKED' ? 'ƒêang kh√≥a' : '‚Äî'))))}"
                  th:style="${tableStatus.toString() == 'AVAILABLE' ? 'color: #28a745; font-weight: 600;' :
                             (tableStatus.toString() == 'OCCUPIED' ? 'color: #dc3545; font-weight: 600;' :
                             (tableStatus.toString() == 'RESERVED' ? 'color: #ffc107; font-weight: 600;' :
                             (tableStatus.toString() == 'WAITING_PAYMENT' ? 'color: #17a2b8; font-weight: 600;' :
                             (tableStatus.toString() == 'LOCKED' ? 'color: #795548; font-weight: 600;' : ''))))}"
                >‚Äî</span>
              </div>
            </div>
            <div class="order-detail-card">
              <div class="order-header">
                <span
                  th:class="'order-status ' + ${orderDetail.orderStatus.toString().toLowerCase()}"
                  th:text="${orderDetail.orderStatus == 'PREPARING' ? 'ƒêang chu·∫©n b·ªã' : (orderDetail.orderStatus == 'COMPLETED' ? 'Ho√†n th√†nh' : orderDetail.orderStatus)}"
                >
                </span>
                <button
                  th:if="${orderDetail != null && tableStatus.toString() == 'OCCUPIED'}"
                  class="btn-edit-order"
                  onclick="openEditOrderPanel()"
                  type="button">
                  ‚úèÔ∏è Th√™m m√≥n
                </button>
              </div>

              <div class="order-meta">
                <div class="meta-row">
                  <span class="meta-label">M√£ ƒë∆°n:</span>
                  <span class="meta-value"
                    >#<span th:text="${orderDetail.orderId}">‚Äî</span></span
                  >
                </div>
                <div class="meta-row">
                  <span class="meta-label">Kh√°ch h√†ng:</span>
                  <span
                    class="meta-value"
                    th:text="${orderDetail.customerName ?: 'Kh√°ch v√£ng lai'}"
                    >‚Äî</span
                  >
                </div>
                <div class="meta-row">
                  <span class="meta-label">Tr·∫°ng th√°i thanh to√°n:</span>
                  <span
                    th:class="'meta-value payment-' + ${orderDetail.paymentStatus.toString().toLowerCase()}"
                    th:text="${orderDetail.paymentStatus.toString() == 'UNPAID' ? 'Ch∆∞a thanh to√°n' : (orderDetail.paymentStatus.toString() == 'PAID' ? 'ƒê√£ thanh to√°n' : 'ƒêang x·ª≠ l√Ω')}"
                  >
                  </span>
                </div>
                <div
                  class="meta-row"
                  th:if="${orderDetail.paymentMethod != null}"
                >
                  <span class="meta-label">Ph∆∞∆°ng th·ª©c:</span>
                  <span
                    class="meta-value"
                    th:text="${orderDetail.paymentMethod.toString() == 'CASH' ? 'Ti·ªÅn m·∫∑t' : (orderDetail.paymentMethod.toString() == 'QR_BANKING' ? 'QR Code' : 'Th·∫ª t√≠n d·ª•ng')}"
                  ></span>
                </div>
              </div>

              <div class="order-items-section">
                <div class="section-header-small">
                  <span>M√≥n ƒë√£ g·ªçi</span>
                  <span
                    class="item-count"
                    th:text="${#lists.isEmpty(orderDetail.items) ? '0 m√≥n' : #lists.size(orderDetail.items) + ' m√≥n'}"
                    >0 m√≥n</span
                  >
                </div>
                <div class="order-items-list">
                  <div
                    th:if="${#lists.isEmpty(orderDetail.items)}"
                    class="no-items"
                  >
                    Ch∆∞a c√≥ m√≥n n√†o
                  </div>
                  <div th:each="item : ${orderDetail.items}" class="order-item">
                    <div class="order-item-info">
                      <div class="item-name" th:text="${item.productName}">
                        ‚Äî
                      </div>
                      <div
                        th:if="${item.sizeName != null && !#strings.isEmpty(item.sizeName)}"
                        class="item-size"
                        style="color: #6c757d; font-size: 13px; margin-top: 2px;"
                      >
                        Size: <span th:text="${item.sizeName}"></span>
                      </div>
                      <div class="item-detail">
                        <span class="item-quantity"
                          >x<span th:text="${item.quantity}">1</span></span
                        >
                        <span
                          class="item-price"
                          th:text="${#numbers.formatCurrency(item.unitPrice)}"
                          >0ƒë</span
                        >
                      </div>
                      <div
                        th:if="${item.note != null && !#strings.isEmpty(item.note)}"
                        class="item-note"
                      >
                        üìù <span th:text="${item.note}"></span>
                      </div>
                    </div>
                    <div
                      class="item-total"
                      th:text="${#numbers.formatCurrency(item.totalPrice)}"
                    >
                      0ƒë
                    </div>
                  </div>
                </div>
              </div>

              <div class="order-summary">
                <div
                  th:if="${orderDetail.voucherCode != null}"
                  class="summary-row"
                  style="background: #fff3cd; padding: 8px; border-radius: 4px; margin-bottom: 8px;"
                >
                  <span style="font-weight: 600;">Voucher:</span>
                  <span
                    class="voucher-code"
                    th:text="${orderDetail.voucherCode}"
                    style="color: #856404; font-weight: 600;"
                    >‚Äî</span
                  >
                </div>
                <div class="summary-row">
                  <span>T·∫°m t√≠nh:</span>
                  <span
                    th:text="${#numbers.formatCurrency(orderDetail.totalPrice)}"
                    >0ƒë</span
                  >
                </div>
                <div
                  th:if="${orderDetail.discountAmount != null && orderDetail.discountAmount > 0}"
                  class="summary-row discount"
                >
                  <span>Gi·∫£m gi√°:</span>
                  <span
                    th:text="'-' + ${#numbers.formatCurrency(orderDetail.discountAmount)}"
                    >-0ƒë</span
                  >
                </div>
                <div class="summary-row">
                  <span>Thu·∫ø (10%):</span>
                  <span
                    th:text="'+' + ${#numbers.formatCurrency((orderDetail.totalPrice - (orderDetail.discountAmount != null ? orderDetail.discountAmount : 0)) * 0.1)}"
                    >0ƒë</span
                  >
                </div>
                <div class="summary-row total">
                  <span>T·ªïng c·ªông:</span>
                  <span
                    class="total-amount"
                    th:text="${#numbers.formatCurrency((orderDetail.totalPrice - (orderDetail.discountAmount != null ? orderDetail.discountAmount : 0)) * 1.1)}"
                    >0ƒë</span
                  >
                </div>

                <!-- N√∫t x√°c nh·∫≠n thanh to√°n ngay d∆∞·ªõi T·ªïng c·ªông -->
                <form id="payment-confirm-form" th:action="@{/cashier/payment/confirm}" method="post" style="display:none">
                  <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                  <input type="hidden" id="payment-session-id" name="sessionId" th:value="${orderDetail != null ? orderDetail.sessionId : null}" />
                  <input type="hidden" id="payment-method" name="paymentMethod" value="CASH" />
                </form>

                <div th:if="${tableStatus.toString() == 'WAITING_PAYMENT' && orderDetail != null && orderDetail.sessionId != null}" style="margin-top: 16px;">
                  <button type="button" class="btn-action btn-confirm-payment btn-confirm-cash"
                          th:if="${orderDetail.paymentMethod != null and orderDetail.paymentMethod.toString() == 'CASH'}"
                          onclick="(function(){
                            if(confirm('X√°c nh·∫≠n kh√°ch ƒë√£ thanh to√°n b·∫±ng ti·ªÅn m·∫∑t?')) {
                              document.getElementById('payment-method').value='CASH';
                              document.getElementById('payment-confirm-form').submit();
                            }
                          })()">
                    üíµ X√°c nh·∫≠n thanh to√°n ti·ªÅn m·∫∑t
                  </button>
                  <button type="button" class="btn-action btn-confirm-payment btn-confirm-qr"
                          th:if="${orderDetail.paymentMethod != null and orderDetail.paymentMethod.toString() == 'QR_BANKING'}"
                          onclick="(function(){
                            if(confirm('X√°c nh·∫≠n kh√°ch ƒë√£ thanh to√°n qua QR Banking?')) {
                              document.getElementById('payment-method').value='QR_BANKING';
                              document.getElementById('payment-confirm-form').submit();
                            }
                          })()">
                    üì± X√°c nh·∫≠n thanh to√°n QR Banking
                  </button>
                </div>
              </div>

              <div
                th:if="${orderDetail.note != null && !#strings.isEmpty(orderDetail.note)}"
                class="order-note"
              >
                <strong>Ghi ch√∫:</strong>
                <span th:text="${orderDetail.note}"></span>
              </div>
            </div>

            <!-- ƒê∆∞·ªùng ph√¢n c√°ch v√† n√∫t actions cho b√†n -->
            <div class="table-actions">
              <div class="action-buttons-group">
                <button
                  class="btn-action btn-reserve"
                  th:onclick="'openReservationModal(' + ${selectedTableId} + ')'"
                >
                  üìÖ ƒê·∫∑t tr∆∞·ªõc
                </button>
                <a
                  th:href="@{/cashier/tables/{tableId}/reservations(tableId=${selectedTableId})}"
                  class="btn-action btn-view-reservations"
                >
                  üìã Xem ƒë∆°n ƒë·∫∑t tr∆∞·ªõc
                </a>
              </div>
            </div>

          </div>

          <!-- Upcoming Reservations View -->
          <div th:if="${upcomingReservations != null}" class="reservation-list">
            <div class="reservation-header">
              <a th:href="@{/cashier}" class="btn-back-styled">‚Üê Quay l·∫°i</a>
            </div>

            <!-- Search Form - ch·ªâ hi·ªán trong upcoming reservations -->
            <div class="search-container" style="margin: 16px 0">
              <form
                th:action="@{/cashier/reservations/upcoming}"
                method="get"
                style="display: flex; gap: 8px"
              >
                <input
                  type="text"
                  name="search"
                  th:value="${searchKeyword}"
                  placeholder="T√¨m theo t√™n, SƒêT, ho·∫∑c s·ªë b√†n..."
                  class="search-input"
                  style="
                    flex: 1;
                    padding: 10px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                    font-size: 14px;
                  "
                />
                <button
                  type="submit"
                  class="btn btn-primary"
                  style="padding: 10px 20px; white-space: nowrap"
                >
                  üîç T√¨m ki·∫øm
                </button>
                <a
                  th:href="@{/cashier/reservations/upcoming}"
                  class="btn btn-secondary"
                  style="
                    padding: 10px 20px;
                    text-decoration: none;
                    display: inline-block;
                  "
                  >‚Üª X√≥a l·ªçc</a
                >
              </form>
            </div>

            <div class="reservation-items">
              <div
                th:if="${#lists.isEmpty(upcomingReservations)}"
                class="no-reservations-card"
              >
                <div class="no-reservations-content">
                  <div class="no-reservations-icon">üìÖ</div>
                  <div class="no-reservations-text">
                    Ch∆∞a c√≥ ƒë∆°n ƒë·∫∑t b√†n n√†o
                  </div>
                </div>
              </div>

              <div
                th:each="reservation : ${upcomingReservations}"
                class="reservation-card"
              >
                <div class="reservation-card-header">
                  <div class="reservation-table-name">
                    <span
                      style="font-weight: 700; color: #2c3e50"
                      th:text="${reservation.tableName}"
                      >B√†n #</span
                    >
                    <span
                      style="font-size: 12px; color: #6c757d; margin-left: 8px"
                      >| ƒê∆°n #<span th:text="${reservation.id}">‚Äî</span></span
                    >
                  </div>
                  <span
                    th:class="'reservation-status ' + ${reservation.status.toString().toLowerCase()}"
                    th:text="${reservation.status == 'CONFIRMED' ? 'ƒê√£ x√°c nh·∫≠n' :
						                (reservation.status == 'ARRIVED' ? 'ƒê√£ ƒë·∫øn' : 
						                (reservation.status == 'CANCELED' ? 'ƒê√£ h·ªßy' : 'Kh√¥ng ƒë·∫øn'))}"
                  >
                  </span>
                </div>

                <div class="reservation-time">
                  üïê Th·ªùi gian:
                  <span
                    th:text="${#temporals.format(reservation.startTime, 'EEE, dd MMM yyyy HH:mm')}"
                    >‚Äî</span
                  >
                </div>

                <div class="reservation-info">
                  <div class="reservation-info-row">
                    <span class="reservation-info-label">üë§ Kh√°ch h√†ng:</span>
                    <span
                      class="reservation-info-value"
                      th:text="${reservation.customerName}"
                      >‚Äî</span
                    >
                  </div>
                  <div class="reservation-info-row">
                    <span class="reservation-info-label"
                      >üìû S·ªë ƒëi·ªán tho·∫°i:</span
                    >
                    <span
                      class="reservation-info-value"
                      th:text="${reservation.customerPhone}"
                      >‚Äî</span
                    >
                  </div>
                  <div class="reservation-info-row">
                    <span class="reservation-info-label">üë• S·ªë kh√°ch:</span>
                    <span
                      class="reservation-info-value"
                      th:text="${reservation.capacityExpected + ' ng∆∞·ªùi'}"
                      >‚Äî ng∆∞·ªùi</span
                    >
                  </div>
                  <div
                    th:if="${reservation.note != null && !#strings.isEmpty(reservation.note)}"
                    class="reservation-info-row"
                  >
                    <span class="reservation-info-label">üìù Ghi ch√∫:</span>
                    <span
                      class="reservation-info-value"
                      th:text="${reservation.note}"
                      >‚Äî</span
                    >
                  </div>
                </div>

                <div
                  th:if="${reservation.status.toString() == 'CONFIRMED'}"
                  class="reservation-actions"
                  style="display: flex; flex-direction: column; gap: 8px"
                >
                  <!-- N√∫t m·ªü b√†n cho kh√°ch (n√∫t ch√≠nh) -->
                  <form
                    th:action="@{/cashier/reservations/{id}/open(id=${reservation.id})}"
                    method="post"
                    onsubmit="return confirm('X√°c nh·∫≠n kh√°ch ƒë√£ ƒë·∫øn v√† m·ªü b√†n?');"
                  >
                    <input
                      type="hidden"
                      th:name="${_csrf.parameterName}"
                      th:value="${_csrf.token}"
                    />
                    <input
                      type="hidden"
                      name="returnUrl"
                      value="/cashier/reservations/upcoming"
                    />
                    <button
                      type="submit"
                      class="btn-open-table"
                      style="
                        width: 100%;
                        padding: 12px;
                        background-color: #2196f3;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                        font-weight: bold;
                        font-size: 15px;
                      "
                    >
                      üîì M·ªü b√†n cho kh√°ch
                    </button>
                  </form>

                  <!-- C√°c n√∫t ph·ª• -->
                  <div style="display: flex; gap: 8px">
                    <a
                      th:href="@{/cashier/reservations/{id}/edit(id=${reservation.id}, returnUrl='/cashier/reservations/upcoming')}"
                      class="btn-edit-reservation"
                      style="
                        flex: 1;
                        text-align: center;
                        padding: 10px;
                        background-color: #4caf50;
                        color: white;
                        border-radius: 4px;
                        text-decoration: none;
                        border: none;
                        cursor: pointer;
                      "
                    >
                      ‚úèÔ∏è S·ª≠a
                    </a>
                    <form
                      th:action="@{/cashier/reservations/{id}/delete(id=${reservation.id})}"
                      method="post"
                      onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë·∫∑t b√†n n√†y?');"
                      style="flex: 1"
                    >
                      <input
                        type="hidden"
                        th:name="${_csrf.parameterName}"
                        th:value="${_csrf.token}"
                      />
                      <input
                        type="hidden"
                        name="returnUrl"
                        value="/cashier/reservations/upcoming"
                      />
                      <button
                        type="submit"
                        class="btn-cancel-reservation"
                        style="width: 100%"
                      >
                        ‚ùå H·ªßy ƒë·∫∑t b√†n
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Payment History View -->
          <div
            th:if="${paymentHistory != null && showHistory == true}"
            class="reservation-list"
          >
            <div class="reservation-header">
              <a th:href="@{/cashier}" class="btn-back-styled">‚Üê Quay l·∫°i</a>
            </div>

            <h2
              style="
                font-size: 24px;
                font-weight: 700;
                color: #2c3e50;
                margin-bottom: 20px;
                padding: 20px 0;
              "
            >
              üìã L·ªãch s·ª≠ h√≥a ƒë∆°n
            </h2>

            <div
              th:if="${#lists.isEmpty(paymentHistory)}"
              class="no-reservations-card"
            >
              <div class="no-reservations-content">
                <div class="no-reservations-icon">üìÑ</div>
                <div class="no-reservations-text">Ch∆∞a c√≥ h√≥a ƒë∆°n n√†o</div>
              </div>
            </div>

            <div
              th:each="order : ${paymentHistory}"
              class="reservation-card"
              style="max-width: 100%"
            >
              <!-- Order Header -->
              <div class="reservation-card-header" style="margin-bottom: 16px">
                <div>
                  <div
                    style="
                      font-size: 18px;
                      font-weight: 700;
                      color: #2c3e50;
                      margin-bottom: 4px;
                    "
                  >
                    ƒê∆°n h√†ng #<span th:text="${order.orderId}">‚Äî</span>
                  </div>
                  <div style="font-size: 12px; color: #6c757d">
                    üìÖ
                    <span
                      th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm')}"
                      >‚Äî</span
                    >
                  </div>
                </div>
                <span
                  th:style="${order.orderStatus != null && order.orderStatus.toString() == 'PREPARING' ? 'background: #fff3cd; color: #856404;' : (order.orderStatus != null && order.orderStatus.toString() == 'COMPLETED' ? 'background: #d4edda; color: #155724;' : (order.orderStatus != null && order.orderStatus.toString() == 'CANCELLED' ? 'background: #f8d7da; color: #721c24;' : 'background: #d1ecf1; color: #0c5460;'))}"
                  style="
                    padding: 4px 12px;
                    border-radius: 20px;
                    font-size: 12px;
                    font-weight: 600;
                    text-transform: uppercase;
                  "
                >
                  <span
                    th:text="${order.orderStatus != null && order.orderStatus.toString() == 'PREPARING' ? 'ƒêang chu·∫©n b·ªã' : (order.orderStatus != null && order.orderStatus.toString() == 'COMPLETED' ? 'Ho√†n th√†nh' : (order.orderStatus != null && order.orderStatus.toString() == 'CANCELLED' ? 'ƒê√£ h·ªßy' : 'ƒêang x·ª≠ l√Ω'))}"
                    >‚Äî</span
                  >
                </span>
                <span
                  th:if="${order.paymentStatus != null}"
                  th:style="${order.paymentStatus.toString() == 'PAID' ? 'background: #d4edda; color: #155724;' : (order.paymentStatus.toString() == 'PENDING' ? 'background: #fff3cd; color: #856404;' : 'background: #f8d7da; color: #721c24;')}"
                  style="
                    padding: 4px 12px;
                    border-radius: 20px;
                    font-size: 12px;
                    font-weight: 600;
                    text-transform: uppercase;
                    margin-left: 8px;
                  "
                >
                  <span
                    th:text="${order.paymentStatus.toString() == 'PAID' ? 'ƒê√£ thanh to√°n' : (order.paymentStatus.toString() == 'PENDING' ? 'ƒêang x·ª≠ l√Ω' : 'Ch∆∞a thanh to√°n')}"
                    >‚Äî</span
                  >
                </span>
              </div>

              <!-- Order Details Section -->
              <div
                class="reservation-info"
                style="
                  background: #f8f9fa;
                  padding: 12px;
                  border-radius: 8px;
                  margin-bottom: 12px;
                "
              >
                <div class="reservation-info-row">
                  <span class="reservation-info-label">ü™ë B√†n:</span>
                  <span
                    class="reservation-info-value"
                    th:text="${order.tableName ?: 'Take-away'}"
                    >‚Äî</span
                  >
                </div>
                <div class="reservation-info-row">
                  <span class="reservation-info-label">üçΩÔ∏è Lo·∫°i ƒë∆°n:</span>
                  <span
                    class="reservation-info-value"
                    th:text="${order.orderType != null && order.orderType.toString() == 'DINE_IN' ? 'T·∫°i c·ª≠a h√†ng' : 'Take-away'}"
                    >‚Äî</span
                  >
                </div>
                <div class="reservation-info-row">
                  <span class="reservation-info-label"
                    >üí≥ Ph∆∞∆°ng th·ª©c Thanh To√°n:</span
                  >
                  <span
                    class="reservation-info-value"
                    th:text="${order.paymentMethod != null ? (order.paymentMethod.toString() == 'CASH' ? 'Ti·ªÅn m·∫∑t' : (order.paymentMethod.toString() == 'QR_BANKING' ? 'QR Code' : (order.paymentMethod.toString() == 'CREDIT_CARD' ? 'Th·∫ª t√≠n d·ª•ng' : order.paymentMethod.toString()))) : 'Ch∆∞a ch·ªçn'}"
                    >‚Äî</span
                  >
                </div>
                <div class="reservation-info-row">
                  <span class="reservation-info-label"
                    >üí∞ Tr·∫°ng th√°i Thanh To√°n:</span
                  >
                  <span
                    class="reservation-info-value"
                    th:class="${order.paymentStatus != null && order.paymentStatus.toString() == 'PAID' ? 'payment-status paid' : (order.paymentStatus != null && order.paymentStatus.toString() == 'PENDING' ? 'payment-status pending' : 'payment-status unpaid')}"
                    th:text="${order.paymentStatus != null ? (order.paymentStatus.toString() == 'PAID' ? 'ƒê√£ thanh to√°n' : (order.paymentStatus.toString() == 'PENDING' ? 'ƒêang x·ª≠ l√Ω' : 'Ch∆∞a thanh to√°n')) : 'Ch∆∞a thanh to√°n'}"
                    >‚Äî</span
                  >
                </div>
              </div>

              <!-- Order Summary -->
              <div
                style="
                  margin-top: 16px;
                  padding-top: 12px;
                  border-top: 2px solid #e8e8e8;
                "
              >
                <div
                  class="summary-row total"
                  style="
                    display: flex;
                    justify-content: space-between;
                    font-weight: 700;
                    font-size: 16px;
                    color: #2c3e50;
                  "
                >
                  <span>T·ªïng c·ªông:</span>
                  <span
                    style="color: #e74c3c; font-size: 18px"
                    th:text="${#numbers.formatCurrency(order.totalPrice)}"
                    >0ƒë</span
                  >
                </div>
              </div>

              <!-- Action Button -->
              <div style="margin-top: 12px; text-align: center">
                <button
                  th:onclick="'toggleOrderDetail(' + ${order.orderId} + ')'"
                  th:id="'toggle-btn-' + ${order.orderId}"
                  class="btn-detail-order"
                  style="
                    padding: 8px 16px;
                    background-color: #007bff;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    font-size: 14px;
                    font-weight: 500;
                    cursor: pointer;
                    transition: background-color 0.2s;
                  "
                  onmouseover="this.style.backgroundColor='#0056b3'"
                  onmouseout="this.style.backgroundColor='#007bff'"
                >
                  üìã Xem chi ti·∫øt
                </button>
              </div>

              <!-- Order Detail Section (Hidden by default) -->
              <div
                th:id="'order-detail-' + ${order.orderId}"
                class="order-detail-section"
                style="
                  display: none;
                  margin-top: 16px;
                  padding: 16px;
                  background: #f8f9fa;
                  border-radius: 8px;
                  border: 1px solid #e9ecef;
                "
              >
                <!-- Receipt Header -->
                <div style="text-align: center; margin-bottom: 20px">
                  <div
                    style="
                      font-size: 18px;
                      font-weight: bold;
                      margin-bottom: 8px;
                      text-transform: uppercase;
                    "
                  >
                    CHI TI·∫æT ƒê∆†N H√ÄNG
                  </div>
                  <div
                    style="
                      font-size: 16px;
                      font-weight: bold;
                      margin-bottom: 4px;
                    "
                  >
                    PizzarIO
                  </div>
                  <div style="font-size: 12px; margin-bottom: 4px">
                    KM29 - ƒêL. ThƒÉng Long
                  </div>
                  <div style="font-size: 12px; margin-bottom: 10px">
                    ƒêT: 0123456678-0987654321
                  </div>
                  <div
                    style="text-align: center; margin: 10px 0; font-size: 12px"
                  >
                    *****************
                  </div>
                </div>

                <!-- Order Status -->
                <div style="text-align: center; margin-bottom: 15px">
                  <span
                    th:class="'order-status ' + ${order.orderStatus != null ? order.orderStatus.toString().toLowerCase() : ''}"
                    th:text="${order.orderStatus != null && order.orderStatus.toString() == 'PREPARING' ? 'ƒêang chu·∫©n b·ªã' : (order.orderStatus != null && order.orderStatus.toString() == 'COMPLETED' ? 'Ho√†n th√†nh' : (order.orderStatus != null && order.orderStatus.toString() == 'CANCELLED' ? 'ƒê√£ h·ªßy' : 'ƒêang x·ª≠ l√Ω'))}"
                    style="
                      padding: 4px 12px;
                      border-radius: 20px;
                      font-size: 12px;
                      font-weight: 600;
                      text-transform: uppercase;
                      margin-right: 8px;
                    "
                  >
                  </span>
                  <span
                    th:class="'payment-status ' + ${order.paymentStatus.toString().toLowerCase()}"
                    th:text="${order.paymentStatus.toString() == 'PAID' ? 'ƒê√£ thanh to√°n' : (order.paymentStatus.toString() == 'PENDING' ? 'ƒêang x·ª≠ l√Ω' : 'Ch∆∞a thanh to√°n')}"
                    style="
                      padding: 4px 12px;
                      border-radius: 20px;
                      font-size: 12px;
                      font-weight: 600;
                      text-transform: uppercase;
                    "
                  >
                  </span>
                </div>

                <!-- Transaction Information -->
                <div style="margin-bottom: 15px; font-size: 12px">
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      margin-bottom: 4px;
                    "
                  >
                    <span
                      th:text="${#temporals.format(order.createdAt, 'dd-MM-yyyy')}"
                      >20-09-2025</span
                    >
                    <span
                      th:text="${#temporals.format(order.createdAt, 'HH:mm:ss')}"
                      >11:02:37</span
                    >
                  </div>
                  <div style="margin-bottom: 4px">
                    M√£ ƒë∆°n h√†ng:
                    <strong>#<span th:text="${order.orderId}">‚Äî</span></strong>
                  </div>
                  <div style="margin-bottom: 4px">
                    Kh√°ch h√†ng:
                    <span th:text="${order.customerName ?: 'Kh√°ch v√£ng lai'}"
                      >Kh√°ch v√£ng lai</span
                    >
                    <span
                      th:if="${order.customerPhone != null}"
                      style="color: #6c757d"
                    >
                      (SƒêT: <span th:text="${order.customerPhone}">‚Äî</span>)
                    </span>
                  </div>
                  <div style="margin-bottom: 4px">
                    <span th:if="${order.tableName != null}">
                      B√†n: <span th:text="${order.tableName}">05</span>
                    </span>
                    <span th:if="${order.tableName == null}">
                      Lo·∫°i ƒë∆°n: Take-away
                    </span>
                  </div>
                  <div
                    th:if="${order.createdByStaffName != null}"
                    style="margin-bottom: 10px"
                  >
                    Nh√¢n vi√™n ph·ª•c v·ª•:
                    <span th:text="${order.createdByStaffName}">‚Äî</span>
                  </div>
                </div>

                <!-- Items Header -->
                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 70px 1fr;
                    column-gap: 8px;
                    font-size: 12px;
                    font-weight: bold;
                    margin-bottom: 8px;
                    border-bottom: 1px solid #000;
                    padding-bottom: 4px;
                  "
                >
                  <div>T√™n m√≥n</div>
                  <div style="text-align: center">S·ªë l∆∞·ª£ng</div>
                  <div style="text-align: right">Th√†nh ti·ªÅn</div>
                </div>

                <!-- Order Items -->
                <div
                  th:each="item : ${order.items}"
                  style="
                    display: grid;
                    grid-template-columns: 1fr 70px 1fr;
                    column-gap: 8px;
                    font-size: 12px;
                    margin-bottom: 4px;
                  "
                >
                  <div th:text="${item.productName}">Pizza B√≤</div>
                  <div style="text-align: center" th:text="${item.quantity}">
                    1
                  </div>
                  <div
                    style="text-align: right"
                    th:text="${#numbers.formatDecimal(item.totalPrice, 0, 'COMMA', 0, 'POINT')}"
                  >
                    245,000
                  </div>
                </div>

                <!-- Discount Information -->
                <div
                  th:if="${order.discountAmount != null && order.discountAmount > 0}"
                  style="
                    display: grid;
                    grid-template-columns: 1fr 70px 1fr;
                    column-gap: 8px;
                    font-size: 12px;
                    margin-bottom: 4px;
                  "
                >
                  <div>Gi·∫£m gi√°:</div>
                  <div style="text-align: center">-</div>
                  <div
                    style="text-align: right"
                    th:text="'-' + ${#numbers.formatDecimal(order.discountAmount, 0, 'COMMA', 0, 'POINT')}"
                  >
                    -0
                  </div>
                </div>

                <!-- Tax Information -->
                <div
                  style="
                    display: grid;
                    grid-template-columns: 1fr 70px 1fr;
                    column-gap: 8px;
                    font-size: 12px;
                    margin-bottom: 4px;
                  "
                >
                  <div>Thu·∫ø (10%):</div>
                  <div style="text-align: center">-</div>
                  <div
                    style="text-align: right"
                    th:text="${#numbers.formatDecimal(order.totalPrice * 0.1 / 1.1, 0, 'COMMA', 0, 'POINT')}"
                  >
                    0
                  </div>
                </div>

                <!-- Total Section -->
                <div
                  style="
                    margin-top: 15px;
                    border-top: 1px solid #000;
                    padding-top: 8px;
                  "
                >
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      font-size: 14px;
                      font-weight: bold;
                      margin-bottom: 4px;
                    "
                  >
                    <span>T·∫°m t√≠nh:</span>
                    <span
                      th:text="${#numbers.formatDecimal(order.totalPrice / 1.1, 0, 'COMMA', 0, 'POINT')}"
                      >745,000</span
                    >
                  </div>
                  <div
                    th:if="${order.discountAmount != null && order.discountAmount > 0}"
                    style="
                      display: flex;
                      justify-content: space-between;
                      font-size: 14px;
                      font-weight: bold;
                      margin-bottom: 4px;
                    "
                  >
                    <span>Gi·∫£m gi√°:</span>
                    <span
                      th:text="'-' + ${#numbers.formatDecimal(order.discountAmount, 0, 'COMMA', 0, 'POINT')}"
                      >-0</span
                    >
                  </div>
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      font-size: 14px;
                      font-weight: bold;
                      margin-bottom: 4px;
                    "
                  >
                    <span>Thu·∫ø (10%):</span>
                    <span
                      th:text="${#numbers.formatDecimal(order.totalPrice * 0.1 / 1.1, 0, 'COMMA', 0, 'POINT')}"
                      >0</span
                    >
                  </div>
                  <div
                    style="
                      display: flex;
                      justify-content: space-between;
                      font-size: 16px;
                      font-weight: bold;
                      border-top: 1px solid #000;
                      padding-top: 8px;
                    "
                  >
                    <span>T·ªïng c·ªông:</span>
                    <span
                      th:text="${#numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT')}"
                      >745,000</span
                    >
                  </div>
                </div>

                <!-- Payment Method Section -->
                <div
                  style="
                    text-align: center;
                    margin: 20px 0;
                    padding: 15px;
                    background: #f9f9f9;
                    border-radius: 8px;
                  "
                >
                  <div
                    style="
                      font-size: 14px;
                      font-weight: bold;
                      margin-bottom: 10px;
                    "
                  >
                    Ph∆∞∆°ng th·ª©c thanh to√°n
                  </div>
                  <div
                    th:if="${order.paymentMethod != null && order.paymentMethod.toString() == 'QR_BANKING'}"
                  >
                    <div
                      style="
                        color: #007bff;
                        font-size: 16px;
                        margin-bottom: 10px;
                      "
                    >
                      <strong>Thanh to√°n b·∫±ng QR Banking</strong><br />
                      <span
                        style="font-size: 12px"
                        th:text="${order.paymentStatus != null && order.paymentStatus.toString() == 'PAID' ? 'ƒê√£ thanh to√°n th√†nh c√¥ng' : (order.paymentStatus != null && order.paymentStatus.toString() == 'PENDING' ? 'ƒêang x·ª≠ l√Ω thanh to√°n' : 'Ch∆∞a thanh to√°n')}"
                        >ƒê√£ thanh to√°n th√†nh c√¥ng</span
                      >
                    </div>
                  </div>
                  <div
                    th:if="${order.paymentMethod != null && order.paymentMethod.toString() == 'CASH'}"
                  >
                    <div
                      style="
                        color: #2e7d32;
                        font-size: 16px;
                        margin-bottom: 10px;
                      "
                    >
                      <strong>Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t</strong><br />
                      <span
                        style="font-size: 12px"
                        th:text="${order.paymentStatus != null && order.paymentStatus.toString() == 'PAID' ? 'ƒê√£ thanh to√°n th√†nh c√¥ng' : (order.paymentStatus != null && order.paymentStatus.toString() == 'PENDING' ? 'ƒêang x·ª≠ l√Ω thanh to√°n' : 'Ch∆∞a thanh to√°n')}"
                        >ƒê√£ thanh to√°n th√†nh c√¥ng</span
                      >
                    </div>
                  </div>
                  <div
                    th:if="${order.paymentMethod != null && order.paymentMethod.toString() == 'CREDIT_CARD'}"
                  >
                    <div
                      style="
                        color: #6f42c1;
                        font-size: 16px;
                        margin-bottom: 10px;
                      "
                    >
                      <strong>Thanh to√°n b·∫±ng th·∫ª t√≠n d·ª•ng</strong><br />
                      <span
                        style="font-size: 12px"
                        th:text="${order.paymentStatus != null && order.paymentStatus.toString() == 'PAID' ? 'ƒê√£ thanh to√°n th√†nh c√¥ng' : (order.paymentStatus != null && order.paymentStatus.toString() == 'PENDING' ? 'ƒêang x·ª≠ l√Ω thanh to√°n' : 'Ch∆∞a thanh to√°n')}"
                        >ƒê√£ thanh to√°n th√†nh c√¥ng</span
                      >
                    </div>
                  </div>
                  <div th:if="${order.paymentMethod == null}">
                    <div
                      style="
                        color: #6c757d;
                        font-size: 16px;
                        margin-bottom: 10px;
                      "
                    >
                      <strong>Ch∆∞a ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n</strong><br />
                      <span
                        style="font-size: 12px"
                        th:text="${order.paymentStatus != null && order.paymentStatus.toString() == 'PAID' ? 'ƒê√£ thanh to√°n' : (order.paymentStatus != null && order.paymentStatus.toString() == 'PENDING' ? 'ƒêang x·ª≠ l√Ω thanh to√°n' : 'Ch∆∞a thanh to√°n')}"
                        >Ch∆∞a thanh to√°n</span
                      >
                    </div>
                  </div>
                </div>

                <!-- Order Note -->
                <div
                  th:if="${order.note != null && !#strings.isEmpty(order.note)}"
                  style="
                    margin: 15px 0;
                    padding: 10px;
                    background: #f8f9fa;
                    border-radius: 4px;
                  "
                >
                  <strong>Ghi ch√∫ ƒë∆°n h√†ng:</strong><br />
                  <span th:text="${order.note}"></span>
                </div>

                <!-- Action Buttons -->
                <div style="text-align: center; margin-top: 20px">
                  <button
                    onclick="printReceipt()"
                    style="
                      padding: 10px 20px;
                      margin: 5px;
                      background-color: #007bff;
                      color: white;
                      border: none;
                      border-radius: 4px;
                      cursor: pointer;
                      font-size: 14px;
                      font-weight: bold;
                    "
                  >
                    In h√≥a ƒë∆°n
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Table Reservations View -->
          <div th:if="${tableReservations != null}" class="reservation-list">
            <div
              class="detail-card"
              style="margin-bottom: 16px; box-shadow: none"
            >
              <div class="reservation-header">
                <a
                  th:href="@{/cashier/tables/{id}/order(id=${selectedTableId})}"
                  class="btn-back-styled"
                >
                  ‚Üê Quay l·∫°i b√†n <span th:text="${selectedTableId}">‚Äî</span>
                </a>
              </div>
            </div>
            <div class="reservation-items">
              <div
                th:if="${#lists.isEmpty(tableReservations)}"
                class="no-reservations-card"
              >
                <div class="no-reservations-content">
                  <div class="no-reservations-icon">üìÖ</div>
                  <div class="no-reservations-text">
                    Ch∆∞a c√≥ ƒë∆°n ƒë·∫∑t b√†n n√†o
                  </div>
                </div>
              </div>

              <div
                th:each="reservation : ${tableReservations}"
                class="reservation-card"
              >
                <div class="reservation-card-header">
                  <div class="reservation-table-name">
                    <span style="font-weight: 700; color: #2c3e50"
                      >B√†n <span th:text="${reservation.tableId}">#</span></span
                    >
                    <span
                      style="font-size: 12px; color: #6c757d; margin-left: 8px"
                      >| ƒê∆°n #<span th:text="${reservation.id}">‚Äî</span></span
                    >
                  </div>
                  <span
                    th:class="'reservation-status ' + ${reservation.status.toString().toLowerCase()}"
                    th:text="${reservation.status == 'CONFIRMED' ? 'ƒê√£ x√°c nh·∫≠n' :
							                (reservation.status == 'ARRIVED' ? 'ƒê√£ ƒë·∫øn' : 
							                (reservation.status == 'CANCELED' ? 'ƒê√£ h·ªßy' : 'Kh√¥ng ƒë·∫øn'))}"
                  >
                  </span>
                </div>

                <div class="reservation-time">
                  üïê
                  <span
                    th:text="${#temporals.format(reservation.startTime, 'EEE, dd MMM yyyy HH:mm')}"
                    >‚Äî</span
                  >
                </div>

                <div class="reservation-info">
                  <div class="reservation-info-row">
                    <span class="reservation-info-label">üë§ Kh√°ch h√†ng:</span>
                    <span
                      class="reservation-info-value"
                      th:text="${reservation.customerName}"
                      >‚Äî</span
                    >
                  </div>
                  <div class="reservation-info-row">
                    <span class="reservation-info-label"
                      >üìû S·ªë ƒëi·ªán tho·∫°i:</span
                    >
                    <span
                      class="reservation-info-value"
                      th:text="${reservation.customerPhone}"
                      >‚Äî</span
                    >
                  </div>
                  <div class="reservation-info-row">
                    <span class="reservation-info-label">üë• S·ªë kh√°ch:</span>
                    <span
                      class="reservation-info-value"
                      th:text="${reservation.capacityExpected + ' ng∆∞·ªùi'}"
                      >‚Äî ng∆∞·ªùi</span
                    >
                  </div>
                  <div
                    th:if="${reservation.note != null && !#strings.isEmpty(reservation.note)}"
                    class="reservation-info-row"
                  >
                    <span class="reservation-info-label">üìù Ghi ch√∫:</span>
                    <span
                      class="reservation-info-value"
                      th:text="${reservation.note}"
                      >‚Äî</span
                    >
                  </div>
                </div>

                <div
                  th:if="${reservation.status.toString() == 'CONFIRMED'}"
                  class="reservation-actions"
                >
                  <!-- N√∫t m·ªü b√†n cho kh√°ch (n√∫t ch√≠nh) -->
                  <form
                    th:action="@{/cashier/reservations/{id}/open(id=${reservation.id})}"
                    method="post"
                    onsubmit="return confirm('X√°c nh·∫≠n kh√°ch ƒë√£ ƒë·∫øn v√† m·ªü b√†n?');"
                  >
                    <input
                      type="hidden"
                      th:name="${_csrf.parameterName}"
                      th:value="${_csrf.token}"
                    />
                    <input
                      type="hidden"
                      name="returnUrl"
                      th:value="'/cashier/tables/' + ${selectedTableId} + '/reservations'"
                    />
                    <button type="submit" class="btn-open-table">
                      üîì M·ªü b√†n cho kh√°ch
                    </button>
                  </form>

                  <!-- C√°c n√∫t ph·ª• -->
                  <div class="reservation-secondary-actions">
                    <a
                      th:href="@{/cashier/reservations/{id}/edit(id=${reservation.id}, returnUrl='/cashier/tables/' + ${selectedTableId} + '/reservations')}"
                      class="btn-edit-reservation"
                    >
                      ‚úèÔ∏è S·ª≠a
                    </a>
                    <form
                      th:action="@{/cashier/reservations/{id}/delete(id=${reservation.id})}"
                      method="post"
                      onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë·∫∑t b√†n n√†y?');"
                    >
                      <input
                        type="hidden"
                        th:name="${_csrf.parameterName}"
                        th:value="${_csrf.token}"
                      />
                      <input
                        type="hidden"
                        name="returnUrl"
                        th:value="'/cashier/tables/' + ${selectedTableId} + '/reservations'"
                      />
                      <button type="submit" class="btn-cancel-reservation">
                        ‚ùå H·ªßy ƒë·∫∑t b√†n
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <div class="toast-container" id="toast-container">
      <!-- Flash messages t·ª´ redirect (ch·ªâ hi·ªÉn th·ªã n·∫øu kh√¥ng ph·∫£i l·ªói validation modal) -->
      <div
        th:if="${successMessage}"
        class="toast success"
        style="display: block"
        th:attr="data-message=${successMessage},
                 data-type='success',
                 data-table-id=${selectedTableId != null ? selectedTableId : ''},
                 data-reservation-id=${lastReservationId != null ? lastReservationId : ''}"
      >
        <span th:text="${successMessage}"></span>
      </div>
      <div
        th:if="${errorMessage != null and (showReservationModal == null or !showReservationModal)}"
        class="toast error"
        style="display: block"
        th:attr="data-message=${errorMessage},
                 data-type='error',
                 data-table-id=${selectedTableId != null ? selectedTableId : ''},
                 data-reservation-id=${lastReservationId != null ? lastReservationId : ''}"
      >
        <span th:text="${errorMessage}"></span>
      </div>
    </div>

    <!-- Modal Toast Container cho errors trong modal -->
    <div class="modal-toast-container" id="modal-toast-container"></div>

    <!-- Modal ƒë·∫∑t b√†n -->
    <div id="reservation-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ƒê·∫∑t tr∆∞·ªõc b√†n</h2>
          <span class="modal-close" onclick="closeReservationModal()"
            >&times;</span
          >
        </div>
        <div class="modal-body">
          <form
            id="reservation-form"
            th:action="@{/cashier/reservations}"
            method="post"
            th:object="${reservationCreateDTO}"
          >
            <input
              type="hidden"
              th:name="${_csrf.parameterName}"
              th:value="${_csrf.token}"
            />
            <input type="hidden" id="table-id-hidden" th:field="*{tableId}" />

            <!-- Hi·ªÉn th·ªã l·ªói chung (global errors) -->
            <div th:if="${#fields.hasGlobalErrors()}" class="form-alert-error">
              <span class="alert-icon">‚ö†Ô∏è</span>
              <div
                th:each="error : ${#fields.globalErrors()}"
                th:text="${error}"
                class="error-message"
              ></div>
            </div>

            <div class="form-group">
              <label for="table-id-display">B√†n s·ªë</label>
              <input
                type="text"
                id="table-id-display"
                readonly
                class="form-control"
                th:field="*{tableId}"
              />
            </div>

            <div class="form-group">
              <label for="customer-name"
                >T√™n kh√°ch h√†ng <span class="required">*</span></label
              >
              <input
                type="text"
                id="customer-name"
                th:field="*{customerName}"
                required
                th:classappend="${#fields.hasErrors('customerName')} ? 'is-invalid' : ''"
                class="form-control"
              />
              <div
                class="invalid-feedback"
                th:if="${#fields.hasErrors('customerName')}"
                th:errors="*{customerName}"
              ></div>
            </div>

            <div class="form-group">
              <label for="customer-phone"
                >S·ªë ƒëi·ªán tho·∫°i <span class="required">*</span></label
              >
              <input
                type="tel"
                id="customer-phone"
                th:field="*{customerPhone}"
                required
                th:classappend="${#fields.hasErrors('customerPhone')} ? 'is-invalid' : ''"
                class="form-control"
              />
              <div
                class="invalid-feedback"
                th:if="${#fields.hasErrors('customerPhone')}"
                th:errors="*{customerPhone}"
              ></div>
            </div>

            <div class="form-group">
              <label for="customer-capacity"
                >S·ªë l∆∞·ª£ng d·ª± ki·∫øn <span class="required">*</span></label
              >
              <input
                type="number"
                id="customer-capacity"
                th:field="*{capacityExpected}"
                required
                th:classappend="${#fields.hasErrors('capacityExpected')} ? 'is-invalid' : ''"
                class="form-control"
              />
              <div
                class="invalid-feedback"
                th:if="${#fields.hasErrors('capacityExpected')}"
                th:errors="*{capacityExpected}"
              ></div>
            </div>

            <div class="form-row">
              <div class="form-group half">
                <label for="start-time"
                  >Th·ªùi gian b·∫Øt ƒë·∫ßu <span class="required">*</span></label
                >
                <input
                  type="datetime-local"
                  id="start-time"
                  th:field="*{startTime}"
                  required
                  th:classappend="${#fields.hasErrors('startTime')} ? 'is-invalid' : ''"
                  class="form-control"
                />
                <div
                  class="invalid-feedback"
                  th:if="${#fields.hasErrors('startTime')}"
                  th:errors="*{startTime}"
                ></div>
              </div>
            </div>

            <div class="form-group">
              <label for="note">Ghi ch√∫ (t√πy ch·ªçn)</label>
              <textarea
                id="note"
                th:field="*{note}"
                th:classappend="${#fields.hasErrors('note')} ? 'is-invalid' : ''"
                class="form-control"
                rows="3"
                placeholder="Nh·∫≠p ghi ch√∫ n·∫øu c√≥..."
              ></textarea>
              <div
                class="invalid-feedback"
                th:if="${#fields.hasErrors('note')}"
                th:errors="*{note}"
              ></div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            onclick="closeReservationModal()"
          >
            H·ªßy
          </button>
          <button type="submit" form="reservation-form" class="btn btn-primary">
            X√°c nh·∫≠n ƒë·∫∑t b√†n
          </button>
        </div>
      </div>
    </div>

    <!-- Modal c·∫≠p nh·∫≠t ƒë·∫∑t b√†n -->
    <div
      id="update-reservation-modal"
      class="modal"
      th:if="${reservationUpdateDTO != null}"
    >
      <div class="modal-content">
        <div class="modal-header">
          <h2>C·∫≠p nh·∫≠t ƒë·∫∑t b√†n</h2>
          <span class="modal-close" onclick="closeUpdateModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form
            id="update-reservation-form"
            th:action="@{/cashier/reservations/{id}/update(id=${reservationUpdateDTO.id})}"
            method="post"
            th:object="${reservationUpdateDTO}"
          >
            <input
              type="hidden"
              th:name="${_csrf.parameterName}"
              th:value="${_csrf.token}"
            />
            <input type="hidden" name="returnUrl" th:value="${returnUrl}" />

            <!-- Hi·ªÉn th·ªã l·ªói chung (global errors) -->
            <div th:if="${#fields.hasGlobalErrors()}" class="form-alert-error">
              <span class="alert-icon">‚ö†Ô∏è</span>
              <div
                th:each="error : ${#fields.globalErrors()}"
                th:text="${error}"
                class="error-message"
              ></div>
            </div>

            <div class="form-group">
              <label for="update-table-id">B√†n s·ªë</label>
              <input
                type="text"
                id="update-table-id"
                readonly
                class="form-control"
                th:value="'B√†n ' + ${reservationUpdateDTO.tableId}"
              />
            </div>

            <div class="form-group">
              <label for="update-customer-name"
                >T√™n kh√°ch h√†ng <span class="required">*</span></label
              >
              <input
                type="text"
                id="update-customer-name"
                th:field="*{customerName}"
                required
                th:classappend="${#fields.hasErrors('customerName')} ? 'is-invalid' : ''"
                class="form-control"
              />
              <div
                class="invalid-feedback"
                th:if="${#fields.hasErrors('customerName')}"
                th:errors="*{customerName}"
              ></div>
            </div>

            <div class="form-group">
              <label for="update-customer-phone"
                >S·ªë ƒëi·ªán tho·∫°i <span class="required">*</span></label
              >
              <input
                type="tel"
                id="update-customer-phone"
                th:field="*{customerPhone}"
                required
                th:classappend="${#fields.hasErrors('customerPhone')} ? 'is-invalid' : ''"
                class="form-control"
              />
              <div
                class="invalid-feedback"
                th:if="${#fields.hasErrors('customerPhone')}"
                th:errors="*{customerPhone}"
              ></div>
            </div>

            <div class="form-group">
              <label for="update-customer-capacity"
                >S·ªë l∆∞·ª£ng d·ª± ki·∫øn <span class="required">*</span></label
              >
              <input
                type="number"
                id="update-customer-capacity"
                th:field="*{capacityExpected}"
                required
                th:classappend="${#fields.hasErrors('capacityExpected')} ? 'is-invalid' : ''"
                class="form-control"
              />
              <div
                class="invalid-feedback"
                th:if="${#fields.hasErrors('capacityExpected')}"
                th:errors="*{capacityExpected}"
              ></div>
            </div>

            <div class="form-row">
              <div class="form-group half">
                <label for="update-start-time"
                  >Th·ªùi gian b·∫Øt ƒë·∫ßu <span class="required">*</span></label
                >
                <input
                  type="datetime-local"
                  id="update-start-time"
                  th:field="*{startTime}"
                  required
                  th:classappend="${#fields.hasErrors('startTime')} ? 'is-invalid' : ''"
                  class="form-control"
                />
                <div
                  class="invalid-feedback"
                  th:if="${#fields.hasErrors('startTime')}"
                  th:errors="*{startTime}"
                ></div>
              </div>
            </div>

            <div class="form-group">
              <label for="update-note">Ghi ch√∫ (t√πy ch·ªçn)</label>
              <textarea
                id="update-note"
                th:field="*{note}"
                th:classappend="${#fields.hasErrors('note')} ? 'is-invalid' : ''"
                class="form-control"
                rows="3"
                placeholder="Nh·∫≠p ghi ch√∫ n·∫øu c√≥..."
              ></textarea>
              <div
                class="invalid-feedback"
                th:if="${#fields.hasErrors('note')}"
                th:errors="*{note}"
              ></div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            onclick="closeUpdateModal()"
          >
            H·ªßy
          </button>
          <button
            type="submit"
            form="update-reservation-form"
            class="btn btn-primary"
          >
            C·∫≠p nh·∫≠t
          </button>
        </div>
      </div>
    </div>

    <!-- Notification History Modal -->
    <div id="notification-modal" class="modal">
      <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
          <h2>üîî L·ªãch s·ª≠ th√¥ng b√°o</h2>
          <span class="modal-close" onclick="closeNotificationModal()">&times;</span>
        </div>
        <div class="modal-body" style="max-height: 60vh;">
          <div class="notification-filters" style="margin-bottom: 16px; display: flex; gap: 8px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="clearAllNotifications()" style="font-size: 12px; padding: 6px 12px;">
              üóëÔ∏è X√≥a t·∫•t c·∫£
            </button>
          </div>
          <div id="notification-list" class="notification-list">
            <!-- Notifications will be inserted here by JavaScript -->
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Order Sliding Panel -->
    <div id="edit-order-overlay" class="edit-order-overlay" onclick="closeEditOrderPanel()"></div>
    <div id="edit-order-panel" class="edit-order-panel">
      <div class="panel-header">
        <h2>‚úèÔ∏è Ch·ªânh s·ª≠a order - B√†n <span id="edit-table-number">2</span></h2>
        <button class="panel-close" onclick="closeEditOrderPanel()" type="button">&times;</button>
      </div>

      <div class="panel-body">
        <!-- Menu Section -->
        <div class="menu-section">
          <h3>üçï Menu m√≥n ƒÉn</h3>
          <div class="menu-tabs">
            <button class="menu-tab active" onclick="filterMenu(0)">T·∫•t c·∫£</button>
            <th:block th:each="cat : ${categories}">
              <button class="menu-tab"
                      th:text="${cat.name}"
                      th:onclick="'filterMenu(' + ${cat.id} + ')'"
                      th:attr="data-category-id=${cat.id}">
              </button>
            </th:block>
          </div>

          <div class="menu-items" id="menu-items-list">
            <!-- Menu items loaded from database -->
            <div class="menu-item"
                 th:each="p : ${products}"
                 th:if="${p.active}"
                 th:attr="data-category-id=${p.categoryId},
                          data-product-id=${p.id},
                          data-product-name=${p.name},
                          data-product-price=${p.basePrice}">
              <div class="menu-item-info">
                <div class="menu-item-name" th:text="${p.name}">Product Name</div>
                <div class="menu-item-price">
                  <span th:if="${p.basePrice > 0}"
                        th:text="${#numbers.formatDecimal(p.basePrice, 0, 'COMMA', 0, 'POINT')} + '‚Ç´'">0‚Ç´</span>
                  <span th:if="${p.basePrice == 0}" style="color: #999; font-size: 12px;">Ch·ªçn size</span>
                </div>
              </div>
              <button class="btn-add-item" onclick="openSizeModal(this)">
                <span>+</span>
              </button>
              <!-- Hidden div to store sizes data as JSON -->
              <div class="product-sizes-data" style="display: none;">
                <th:block th:if="${p.sizes != null && !p.sizes.isEmpty()}">
                  <span th:each="size, iterStat : ${p.sizes}"
                        th:attr="data-size-id=${size.id},
                                 data-size-name=${size.sizeName},
                                 data-size-price=${size.currentPrice}">
                  </span>
                </th:block>
              </div>
            </div>
          </div>
        </div>

        <!-- Current Order Section -->
        <div class="current-order-section">
          <h3>üìã ƒê∆°n hi·ªán t·∫°i</h3>
          <div class="current-order-items" id="current-order-items">
            <!-- Order items will be added here dynamically -->
            <th:block th:if="${orderDetail != null && orderDetail.items != null && !orderDetail.items.isEmpty()}">
              <div class="order-edit-item"
                   th:each="item : ${orderDetail.items}"
                   th:attr="data-item-id=${item.id},
                            data-product-id=${item.id},
                            data-size-id=${item.productSize.id},
                            data-price=${item.totalPrice}">
                <div class="order-edit-item-info">
                  <div class="order-edit-item-name" th:text="${item.productName}">Product Name</div>
                  <div class="order-edit-item-size" th:if="${item.sizeName != null}"
                       th:text="'Size: ' + ${item.sizeName}">Size</div>
                </div>
                <div class="order-edit-item-controls">
                  <button class="btn-quantity" onclick="updateQuantityInPanel(this, -1)">‚àí</button>
                  <span class="quantity" th:text="${item.quantity}">1</span>
                  <button class="btn-quantity" onclick="updateQuantityInPanel(this, 1)">+</button>
                  <button class="btn-remove-item" onclick="removeItemFromPanel(this)">üóëÔ∏è</button>
                </div>
                <div class="order-edit-item-price"
                     th:text="${#numbers.formatCurrency(item.unitPrice)}">
                </div>
              </div>
            </th:block>
            <div th:if="${orderDetail == null || orderDetail.items == null || orderDetail.items.isEmpty()}"
                 style="text-align: center; padding: 40px; color: #999;">
              <p>Ch∆∞a c√≥ m√≥n n√†o trong order</p>
              <p style="font-size: 14px;">Nh·∫•n n√∫t + ƒë·ªÉ th√™m m√≥n</p>
            </div>
          </div>

          <div class="order-summary-edit">
            <div class="summary-row-edit total">
              <span>T·ªïng c·ªông:</span>
              <span id="edit-total"
                    th:text="${orderDetail != null && orderDetail.totalPrice != null ? #numbers.formatCurrency(orderDetail.totalPrice) : '0ƒë'}">0ƒë</span>
            </div>
          </div>
        </div>
      </div>

      <div class="panel-footer">
        <button class="btn btn-secondary" onclick="closeEditOrderPanel()" type="button">H·ªßy</button>
        <button class="btn btn-primary" onclick="saveOrderChanges()" type="button" th:method="POST">üíæ C·∫≠p nh·∫≠t order</button>
      </div>
    </div>

    <!-- Size Selection Modal -->
    <div id="size-modal-overlay" class="size-modal-overlay" onclick="closeSizeModal()"></div>
    <div id="size-modal" class="size-modal">
      <div class="size-modal-header">
        <h3 id="size-modal-product-name">Ch·ªçn size</h3>
        <button class="size-modal-close" onclick="closeSizeModal()" type="button">&times;</button>
      </div>
      <div class="size-modal-body" id="size-modal-body">
        <!-- Size options will be dynamically populated here -->
      </div>
      <div class="size-modal-footer">
        <button class="btn btn-secondary" onclick="closeSizeModal()" type="button">ƒê√≥ng</button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script th:src="@{/js/cashier/utils.js}"></script>
    <script th:src="@{/js/cashier/reservation.js}"></script>
    <script>
      // Initialize clock
      function initializeClock() {
        const $clock = document.getElementById("clock");
        const $date = document.getElementById("date");

        if (!$clock || !$date) {
          console.warn('Clock elements not found');
          return;
        }

        function render() {
          const now = new Date();
          $clock.textContent = now.toLocaleTimeString("vi-VN", { hour12: false });
          $date.textContent = now.toLocaleDateString("vi-VN", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          });
        }

        render();
        setInterval(render, 1000);
      }

      // Initialize clock when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeClock);
      } else {
        initializeClock();
      }

      document.addEventListener("DOMContentLoaded", function () {
        const toasts = document.querySelectorAll(".toast-container .toast");
        toasts.forEach((toast) => {
          setTimeout(() => {
            toast.style.animation = "slideInRight 0.3s ease reverse";
            setTimeout(() => {
              toast.remove();
            }, 300);
          }, 5000);
        });
      });

      // Custom logout confirmation
      function confirmLogout() {
        return confirm("B·∫°n c√≥ mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?");
      }

      // Toggle order detail functionality
      function toggleOrderDetail(orderId) {
        const detailSection = document.getElementById(
          "order-detail-" + orderId
        );
        const toggleBtn = document.getElementById("toggle-btn-" + orderId);

        if (
          detailSection.style.display === "none" ||
          detailSection.style.display === ""
        ) {
          // Show detail
          detailSection.style.display = "block";
          toggleBtn.textContent = "üôà ·∫®n";
          toggleBtn.style.backgroundColor = "#6c757d";
        } else {
          // Hide detail
          detailSection.style.display = "none";
          toggleBtn.textContent = "üìã Xem chi ti·∫øt";
          toggleBtn.style.backgroundColor = "#007bff";
        }
      }

      // Print receipt functionality
      function printReceipt() {
        window.print();
      }
    </script>

    <script th:src="@{/js/cashier/cashier-dashboard.js}"></script>
    <script th:src="@{/js/cashier/utils.js}"></script>
    <script th:src="@{/js/cashier/websocket.js}"></script>
    <script th:src="@{/js/cashier/table.js}"></script>
    <script th:src="@{/js/cashier/reservation.js}"></script>

    <!-- Resizable Panel Script -->
    <script>
      (function () {
        const resizeHandle = document.getElementById("resize-handle");
        const leftPanel = document.getElementById("left-panel");
        const rightPanel = document.getElementById("right-panel");
        const layout = document.querySelector(".layout");

        let isResizing = false;
        let startX = 0;
        let startWidth = 0;

        if (resizeHandle && leftPanel && rightPanel) {
          resizeHandle.addEventListener("mousedown", function (e) {
            isResizing = true;
            startX = e.clientX;
            startWidth = leftPanel.offsetWidth;

            document.body.classList.add("resizing");
            resizeHandle.classList.add("dragging");

            e.preventDefault();
          });

          document.addEventListener("mousemove", function (e) {
            if (!isResizing) return;

            const deltaX = e.clientX - startX;
            const newWidth = startWidth + deltaX;
            const layoutWidth = layout.offsetWidth;

            // Calculate min and max widths
            const minWidth = 300;
            const maxWidth = layoutWidth - minWidth - 8; // 8px for divider

            // Apply constraints
            if (newWidth >= minWidth && newWidth <= maxWidth) {
              const widthPercent = (newWidth / layoutWidth) * 100;
              leftPanel.style.width = widthPercent + "%";
            }

            e.preventDefault();
          });

          document.addEventListener("mouseup", function () {
            if (isResizing) {
              isResizing = false;
              document.body.classList.remove("resizing");
              resizeHandle.classList.remove("dragging");

              // Save the panel width to localStorage
              const widthPercent =
                (leftPanel.offsetWidth / layout.offsetWidth) * 100;
              localStorage.setItem("cashier-left-panel-width", widthPercent);
            }
          });

          // Restore saved width on page load
          const savedWidth = localStorage.getItem("cashier-left-panel-width");
          if (savedWidth) {
            leftPanel.style.width = savedWidth + "%";
          }
        }
      })();
    </script>

    <script th:inline="javascript">
      window.addEventListener("DOMContentLoaded", function () {
        var showModal = /*[[${showReservationModal}]]*/ false;
        var showUpdateModal = /*[[${showUpdateModal}]]*/ false;

        if (showModal) {
          setTimeout(function () {
            var modal = document.getElementById("reservation-modal");
            if (modal) {
              modal.classList.add("show");
            }
          }, 100);
        }

        if (showUpdateModal) {
          setTimeout(function () {
            var modal = document.getElementById("update-reservation-modal");
            if (modal) {
              modal.classList.add("show");
              // ƒê·∫£m b·∫£o modal hi·ªÉn th·ªã ƒë√∫ng c√°ch
              document.body.style.overflow = "hidden";

              // Format datetime-local input
              var startTimeInput = document.getElementById("update-start-time");
              if (startTimeInput && startTimeInput.value) {
                // Convert the datetime value to proper format for datetime-local input
                var dateValue = new Date(startTimeInput.value);
                if (!isNaN(dateValue.getTime())) {
                  startTimeInput.value = formatDateTimeLocal(dateValue);
                }
              }
            }
          }, 100);
        }
      });

      function closeUpdateModal() {
        var modal = document.getElementById("update-reservation-modal");
        if (modal) {
          modal.classList.remove("show");
          // ƒê·∫£m b·∫£o kh√¥ng c√≥ blur effect n√†o c√≤n l·∫°i
          document.body.style.overflow = "";
          document.body.style.filter = "";
        }
      }

      // X·ª≠ l√Ω khi click ra ngo√†i modal ƒë·ªÉ ƒë√≥ng
      document.addEventListener("click", function (event) {
        var updateModal = document.getElementById("update-reservation-modal");
        if (updateModal && event.target === updateModal) {
          closeUpdateModal();
        }
      });

      // X·ª≠ l√Ω khi nh·∫•n ESC ƒë·ªÉ ƒë√≥ng modal
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          var updateModal = document.getElementById("update-reservation-modal");
          if (updateModal && updateModal.classList.contains("show")) {
            closeUpdateModal();
          }
        }
      });

      // ==================== KH·ªûI T·∫†O NOTIFICATION SYSTEM ====================
      document.addEventListener('DOMContentLoaded', function() {
        initNotificationSystem();

        // L∆∞u c√°c server-side flash messages v√†o notification history v·ªõi metadata
        const toastContainer = document.getElementById('toast-container');
        if (toastContainer) {
          const serverToasts = toastContainer.querySelectorAll('.toast[data-message]');
          serverToasts.forEach(function(toast) {
            const message = toast.getAttribute('data-message');
            const type = toast.getAttribute('data-type') || 'info';

            // L·∫•y metadata t·ª´ data attributes
            const metadata = {};
            const tableId = toast.getAttribute('data-table-id');
            const reservationId = toast.getAttribute('data-reservation-id');

            if (tableId && tableId !== '') metadata.tableId = tableId;
            if (reservationId && reservationId !== '') metadata.reservationId = reservationId;

            if (message) {
              saveNotification(message, type, metadata);
            }
          });
        }
      });

      function openEditOrderPanel() {
        const overlay = document.getElementById('edit-order-overlay');
        const panel = document.getElementById('edit-order-panel');

        if (overlay && panel) {
          overlay.classList.add('show');
          panel.classList.add('show');
          document.body.style.overflow = 'hidden';
        }
      }

      function closeEditOrderPanel() {
        const overlay = document.getElementById('edit-order-overlay');
        const panel = document.getElementById('edit-order-panel');

        if (overlay && panel) {
          overlay.classList.remove('show');
          panel.classList.remove('show');
          document.body.style.overflow = '';
        }
      }

      // Menu filtering
      function filterMenu(categoryId) {
        const menuItems = document.querySelectorAll('.menu-item');
        const tabs = document.querySelectorAll('.menu-tab');

        // Update active tab
        tabs.forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');

        // Filter items
        menuItems.forEach(item => {
          const itemCategoryId = item.getAttribute('data-category-id');
          if (categoryId === 0 || parseInt(itemCategoryId) === categoryId) {
            item.style.display = 'flex';
          } else {
            item.style.display = 'none';
          }
        });
      }

      // Add item to order from button
      function addItemToOrderFromButton(button) {
        const menuItem = button.closest('.menu-item');
        const itemId = menuItem.getAttribute('data-product-id');
        const itemName = menuItem.getAttribute('data-product-name');
        const itemPrice = parseFloat(menuItem.getAttribute('data-product-price'));

        addItemToOrder(itemId, itemName, itemPrice);
      }

      // Add item to order
      function addItemToOrder(itemId, itemName, itemPrice, sizeId, sizeName) {
        const orderItemsContainer = document.getElementById('current-order-items');

        // Remove empty message if exists
        const emptyMessage = orderItemsContainer.querySelector('div[style*="text-align: center"]');
        if (emptyMessage) {
          emptyMessage.remove();
        }

        // Create unique key for item (product + size)
        const itemKey = itemId + (sizeId ? '_' + sizeId : '');

        // Check if item already exists (same product and size)
        let existingItem = null;
        const existingItems = orderItemsContainer.querySelectorAll('.order-edit-item');
        existingItems.forEach(item => {
          const existingProductId = item.getAttribute('data-product-id');
          const existingSizeId = item.getAttribute('data-size-id');
          const existingKey = existingProductId + (existingSizeId ? '_' + existingSizeId : '');
          if (existingKey === itemKey) {
            existingItem = item;
          }
        });

        if (existingItem) {
          // Increase quantity
          const quantityEl = existingItem.querySelector('.quantity');
          const currentQty = parseInt(quantityEl.textContent);
          quantityEl.textContent = currentQty + 1;

          // Update price
          const priceEl = existingItem.querySelector('.order-edit-item-price');
          const newPrice = (currentQty + 1) * itemPrice;
          priceEl.textContent = formatCurrency(newPrice);
        } else {
          // Add new item
          const newItem = document.createElement('div');
          newItem.className = 'order-edit-item';
          newItem.setAttribute('data-temp-id', 'new-' + Date.now());
          newItem.setAttribute('data-product-id', itemId);
          newItem.setAttribute('data-price', itemPrice);
          if (sizeId) {
            newItem.setAttribute('data-size-id', sizeId);
          }

          const sizeDisplay = sizeName ? `<div class="order-edit-item-size">Size: ${sizeName}</div>` : '';

          newItem.innerHTML = `
            <div class="order-edit-item-info">
              <div class="order-edit-item-name">${itemName}</div>
              ${sizeDisplay}
            </div>
            <div class="order-edit-item-controls">
              <button class="btn-quantity" onclick="updateQuantityNew(this, -1)">‚àí</button>
              <span class="quantity">1</span>
              <button class="btn-quantity" onclick="updateQuantityNew(this, 1)">+</button>
              <button class="btn-remove-item" onclick="removeItemNew(this)">üóëÔ∏è</button>
            </div>
            <div class="order-edit-item-price">${formatCurrency(itemPrice)}</div>
          `;

          orderItemsContainer.appendChild(newItem);
        }

        updateTotalPrice();
        const displayName = itemName + (sizeName ? ' (' + sizeName + ')' : '');
        showToast('ƒê√£ th√™m ' + displayName + ' v√†o order', 'success');
      }

      // Update quantity for new items
      function updateQuantityNew(button, change) {
        const item = button.closest('.order-edit-item');
        const quantityEl = item.querySelector('.quantity');
        let currentQty = parseInt(quantityEl.textContent);
        currentQty += change;

        if (currentQty < 1) {
          currentQty = 1;
        }

        quantityEl.textContent = currentQty;

        // Update price
        const itemPrice = parseFloat(item.getAttribute('data-price'));
        const priceEl = item.querySelector('.order-edit-item-price');
        priceEl.textContent = formatCurrency(itemPrice * currentQty);

        updateTotalPrice();
      }

      // Remove new item
      function removeItemNew(button) {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√≥n n√†y?')) {
          const item = button.closest('.order-edit-item');
          item.remove();

          // Check if order is empty
          const orderItemsContainer = document.getElementById('current-order-items');
          if (orderItemsContainer.querySelectorAll('.order-edit-item').length === 0) {
            orderItemsContainer.innerHTML = `
              <div style="text-align: center; padding: 40px; color: #999;">
                <p>Ch∆∞a c√≥ m√≥n n√†o trong order</p>
                <p style="font-size: 14px;">Nh·∫•n n√∫t + ƒë·ªÉ th√™m m√≥n</p>
              </div>
            `;
          }

          updateTotalPrice();
          showToast('ƒê√£ x√≥a m√≥n kh·ªèi order', 'info');
        }
      }

      // Update quantity for existing items from DB (in panel)
      function updateQuantityInPanel(button, change) {
        const item = button.closest('.order-edit-item');
        const quantityEl = item.querySelector('.quantity');
        let currentQty = parseInt(quantityEl.textContent);
        currentQty += change;

        if (currentQty < 1) {
          currentQty = 1;
        }

        quantityEl.textContent = currentQty;

        // Update price
        const itemPrice = parseFloat(item.getAttribute('data-price'));
        const priceEl = item.querySelector('.order-edit-item-price');
        priceEl.textContent = formatCurrency(itemPrice * currentQty);

        updateTotalPrice();
      }

      // Remove existing item from panel
      function removeItemFromPanel(button) {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m√≥n n√†y?')) {
          const item = button.closest('.order-edit-item');
          item.remove();

          // Check if order is empty
          const orderItemsContainer = document.getElementById('current-order-items');
          if (orderItemsContainer.querySelectorAll('.order-edit-item').length === 0) {
            orderItemsContainer.innerHTML = `
              <div style="text-align: center; padding: 40px; color: #999;">
                <p>Ch∆∞a c√≥ m√≥n n√†o trong order</p>
                <p style="font-size: 14px;">Nh·∫•n n√∫t + ƒë·ªÉ th√™m m√≥n</p>
              </div>
            `;
          }

          updateTotalPrice();
          showToast('ƒê√£ x√≥a m√≥n kh·ªèi order', 'info');
        }
      }

      // Update total price
      function updateTotalPrice() {
        const orderItems = document.querySelectorAll('.order-edit-item');
        let total = 0;

        orderItems.forEach(item => {
          const quantity = parseInt(item.querySelector('.quantity').textContent);
          const price = parseFloat(item.getAttribute('data-price'));
          total += quantity * price;
        });

        document.getElementById('edit-total').textContent = formatCurrency(total);
      }

      // Format currency helper
      function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', {
          style: 'currency',
          currency: 'VND'
        }).format(amount);
      }

      // Open size selection modal
      function openSizeModal(button) {
        const menuItem = button.closest('.menu-item');
        const productId = menuItem.getAttribute('data-product-id');
        const productName = menuItem.getAttribute('data-product-name');

        // Get sizes from hidden div
        const sizesDataDiv = menuItem.querySelector('.product-sizes-data');
        const sizeSpans = sizesDataDiv ? sizesDataDiv.querySelectorAll('span[data-size-id]') : [];

        if (sizeSpans.length === 0) {
          // No sizes available, use default price
          const productPrice = parseFloat(menuItem.getAttribute('data-product-price'));
          addItemToOrder(productId, productName, productPrice, null, null);
          return;
        }

        // Populate modal with sizes
        const modal = document.getElementById('size-modal');
        const overlay = document.getElementById('size-modal-overlay');
        const modalBody = document.getElementById('size-modal-body');
        const modalTitle = document.getElementById('size-modal-product-name');

        modalTitle.textContent = 'Ch·ªçn size - ' + productName;
        modalBody.innerHTML = '';

        sizeSpans.forEach(sizeSpan => {
          const sizeId = sizeSpan.getAttribute('data-size-id');
          const sizeName = sizeSpan.getAttribute('data-size-name');
          const sizePrice = parseFloat(sizeSpan.getAttribute('data-size-price'));

          const sizeOption = document.createElement('div');
          sizeOption.className = 'size-option';
          sizeOption.innerHTML = `
            <div class="size-option-info">
              <div class="size-option-name">${sizeName}</div>
              <div class="size-option-price">${formatCurrency(sizePrice)}</div>
            </div>
            <button class="btn-select-size" onclick="selectSize('${productId}', '${productName}', ${sizePrice}, '${sizeId}', '${sizeName}')">
              Ch·ªçn
            </button>
          `;
          modalBody.appendChild(sizeOption);
        });

        // Show modal
        overlay.classList.add('show');
        modal.classList.add('show');
      }

      // Close size modal
      function closeSizeModal() {
        const modal = document.getElementById('size-modal');
        const overlay = document.getElementById('size-modal-overlay');
        overlay.classList.remove('show');
        modal.classList.remove('show');
      }

      // Select size and add to order
      function selectSize(productId, productName, price, sizeId, sizeName) {
        addItemToOrder(productId, productName, price, sizeId, sizeName);
        closeSizeModal();
      }

      // Update quantity
      function updateQuantity(itemId, change) {
        const quantityElement = event.target.parentElement.querySelector('.quantity');
        let currentQty = parseInt(quantityElement.textContent);
        currentQty += change;

        if (currentQty < 1) {
          currentQty = 1;
        }

        quantityElement.textContent = currentQty;
        // TODO: Update total calculation
        console.log('Updated quantity for item:', itemId, 'to:', currentQty);
      }

      // Save order changes
      function saveOrderChanges() {
        if (!confirm('X√°c nh·∫≠n c·∫≠p nh·∫≠t order?')) {
          return;
        }

        // Get all order items
        const orderItems = [];
        const items = document.querySelectorAll('.order-edit-item');

        items.forEach(item => {
          const productId = item.getAttribute('data-product-id');
          const productName = item.querySelector('.order-edit-item-name').textContent;
          const quantity = parseInt(item.querySelector('.quantity').textContent);
          const price = parseFloat(item.getAttribute('data-price'));
          const sizeId = item.getAttribute('data-size-id');

          if (productId && quantity > 0) {
            const orderItem = {
              productId: productId,
              productName: productName,
              quantity: quantity,
              price: price
            };
            if (sizeId) {
              orderItem.sizeId = sizeId;
            }
            orderItems.push(orderItem);
          }
        });

        // Get table ID from URL or hidden field
        const tableId = [[${selectedTableId}]];

        if (!tableId) {
          showToast('L·ªói: Kh√¥ng t√¨m th·∫•y th√¥ng tin b√†n', 'error');
          return;
        }

        // Create form and submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/pizzario/cashier/tables/' + tableId + '/order/update';
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = /*[[@{${_csrf.parameterName}}]]*/ '_csrf';
        csrfInput.value = /*[[@{${_csrf.token}}]]*/ '';
        
        form.appendChild(csrfInput);

        // Add items as JSON
        const itemsInput = document.createElement('input');
        itemsInput.type = 'hidden';
        itemsInput.name = 'items';
        itemsInput.value = JSON.stringify(orderItems);
        form.appendChild(itemsInput);

        document.body.appendChild(form);
        showToast('ƒêang c·∫≠p nh·∫≠t order...', 'info');
        form.submit();
      }

      // Close panel on ESC key
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
          const panel = document.getElementById('edit-order-panel');
          if (panel && panel.classList.contains('show')) {
            closeEditOrderPanel();
          }
        }
      });
    </script>
  </body>
</html>
