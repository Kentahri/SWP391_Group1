<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cashier - Take-away</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Cashier Takeaway CSS - Pizza Theme üçï -->
    <link rel="stylesheet" th:href="@{/css/cashier-takeaway.css}" />
  </head>
  <body>
    <div id="toast-container" class="toast-container"></div>

    <div class="container">
      <main class="menu-section">
        <header class="menu-header">
          <h1>T·∫°o ƒë∆°n Take-away</h1>
          <input
            id="searchBox"
            class="search-box"
            type="text"
            placeholder="T√¨m m√≥n..."
          />
        </header>

        <nav class="category-nav" id="categoryBar">
          <button class="cat-chip active" data-category-id="0">T·∫•t c·∫£</button>
          <button
            th:each="cat : ${categories}"
            class="cat-chip"
            th:text="${cat.name}"
            th:attr="data-category-id=${cat.id}"
          ></button>
        </nav>

        <div id="productModal" class="modal">
          <div class="modal-content" id="productModalContent"></div>
        </div>

        <section class="product-grid" id="productGrid">
          <div
            class="product-card"
            th:each="p : ${products}"
            th:attr="data-category-id=${p.categoryId} , data-product-id=${p.id}"
            th:classappend="${!p.active ? 'inactive' : ''}"
            th:onclick="'showProductDetail(' + ${p.id} + ')'"
            style="cursor: pointer"
          >
            <div class="thumb">
              <img
                th:alt="${p.name}"
                th:src="${p.imageURL ?: 'https://via.placeholder.com/160?text=Product'}"
              />
            </div>
            <div class="name" th:text="${p.name}">Product Name</div>
            <form
              class="ajax-form"
              method="post"
              th:action="@{'/cashier/takeaway/cart/add'}"
              style="width: 100%; margin-top: 10px"
              onclick="event.stopPropagation();"
            >
              <input type="hidden" name="productId" th:value="${p.id}" />
              <input type="hidden" name="quantity" value="1" />
              <input type="hidden" name="note" value="" />
              <input type="hidden" name="productSizeId" value="" />
              <button type="submit" class="add-btn">Th√™m v√†o gi·ªè</button>
            </form>
          </div>
        </section>
      </main>

      <aside class="sidebar" id="sidebar">
        <h2>Gi·ªè h√†ng üõí</h2>
        <div class="items-list" id="cartList">
          <th:block th:if="${#lists.isEmpty(cartItems)}">
            <p class="empty-message">Ch∆∞a c√≥ m√≥n n√†o trong gi·ªè.</p>
          </th:block>
          <div class="cart-item" th:each="item : ${cartItems}">
            <div class="item-details">
              <div class="name" th:text="${item.productName}">Product Name</div>
              <div
                class="price"
                th:text="${#numbers.formatCurrency(item.totalPrice)}"
              >
                0ƒë
              </div>
              <form
                class="ajax-form"
                th:action="@{/cashier/takeaway/cart/update}"
                method="post"
              >
                <input
                  type="hidden"
                  name="productId"
                  th:value="${item.productId}"
                />
                <input
                  type="hidden"
                  name="quantity"
                  th:value="${item.quantity}"
                />
                <input type="hidden" name="note" th:value="${item.note}" />
                <input
                  type="hidden"
                  name="oldProductSizeId"
                  th:value="${item.productSize.id}"
                />

                <select
                  name="newProductSizeId"
                  style="
                    display: block;
                    margin-top: 6px;
                    padding: 6px;
                    border-radius: 4px;
                    width: 100%;
                  "
                  onchange="this.form.requestSubmit()"
                >
                  <option
                    th:each="ps : ${item.productSizes}"
                    th:value="${ps.id}"
                    th:selected="${ps.id == item.productSize.id}"
                    th:text="${ps.size.sizeName}"
                  ></option>
                </select>
              </form>

              <form
                class="ajax-form"
                th:action="@{/cashier/takeaway/cart/update}"
                method="post"
              >
                <input
                  type="hidden"
                  name="productId"
                  th:value="${item.productId}"
                />
                <input
                  type="hidden"
                  name="quantity"
                  th:value="${item.quantity}"
                />
                <input
                  type="hidden"
                  name="newProductSizeId"
                  th:value="${item.productSize.id}"
                />
                <input
                  type="hidden"
                  name="oldProductSizeId"
                  th:value="${item.productSize.id}"
                />

                <div class="note-section">
                  <input
                    type="text"
                    name="note"
                    th:value="${item.note}"
                    placeholder="Th√™m ghi ch√∫..."
                    onblur="this.form.requestSubmit()"
                    style="
                      width: 100%;
                      padding: 6px;
                      border-radius: 4px;
                      border: 1px solid #ccc;
                      margin-top: 5px;
                    "
                  />
                </div>
              </form>
            </div>
            <div class="item-qty">
              <form
                class="ajax-form"
                th:action="@{/cashier/takeaway/cart/update}"
                method="post"
              >
                <input
                  type="hidden"
                  name="productId"
                  th:value="${item.productId}"
                />
                <input
                  type="hidden"
                  name="quantity"
                  th:value="${item.quantity - 1}"
                />
                <input type="hidden" name="note" th:value="${item.note}" />
                <input
                  type="hidden"
                  name="newProductSizeId"
                  th:value="${item.productSize.id}"
                />
                <input
                  type="hidden"
                  name="oldProductSizeId"
                  th:value="${item.productSize.id}"
                />

                <button type="submit">-</button>
              </form>
              <span th:text="${item.quantity}">1</span>
              <form
                class="ajax-form"
                th:action="@{/cashier/takeaway/cart/update}"
                method="post"
              >
                <input
                  type="hidden"
                  name="productId"
                  th:value="${item.productId}"
                />
                <input
                  type="hidden"
                  name="quantity"
                  th:value="${item.quantity + 1}"
                />
                <input type="hidden" name="note" th:value="${item.note}" />
                <input
                  type="hidden"
                  name="newProductSizeId"
                  th:value="${item.productSize.id}"
                />
                <input
                  type="hidden"
                  name="oldProductSizeId"
                  th:value="${item.productSize.id}"
                />

                <button type="submit">+</button>
              </form>
            </div>
            <form
              class="ajax-form"
              th:action="@{/cashier/takeaway/cart/remove}"
              method="post"
            >
              <input
                type="hidden"
                name="productId"
                th:value="${item.productId}"
              />
              <input
                type="hidden"
                name="quantity"
                th:value="${item.quantity + 1}"
              />
              <input type="hidden" name="note" th:value="${item.note}" />
              <input
                type="hidden"
                name="productSizeId"
                th:value="${item.productSize.id}"
              />
              <button class="remove-btn" type="submit">‚úï</button>
            </form>
          </div>
        </div>
        <div class="summary">
          <th:block
            th:with="cartTotalSum=${#aggregates.sum(cartItems.![totalPrice])}"
          >
            <div class="row" th:if="${!#lists.isEmpty(cartItems)}">
              <span>T·ªïng</span>
              <span
                class="total"
                id="cartTotal"
                th:text="${#numbers.formatCurrency(cartTotalSum)}"
                >0‚Ç´</span
              >
            </div>
          </th:block>
        </div>
        <form
          id="paymentForm"
          th:action="@{/cashier/takeaway/order/place-and-payment}"
          method="post"
          data-normal-submit="true"
          onsubmit="console.log('Form submit triggered'); return true;"
        >
          <input
            type="hidden"
            th:if="${_csrf != null}"
            th:name="${_csrf.parameterName}"
            th:value="${_csrf.token}"
          />
          <button
            class="btn btn-secondary"
            type="submit"
            th:disabled="${#lists.isEmpty(cartItems)}"
            onclick="console.log('Button clicked'); return true;"
          >
            üí≥ Thanh to√°n
          </button>
        </form>
        <form
          th:action="@{'/cashier/takeaway/rollback'}"
          method="post"
          id="backToDashboardForm"
        >
          <input
            type="hidden"
            th:if="${_csrf != null}"
            th:name="${_csrf.parameterName}"
            th:value="${_csrf.token}"
          />
          <button
            type="button"
            class="btn btn-secondary"
            style="margin-top: 12px"
            onclick="backToDashboard(event)"
          >
            ‚Üê Quay l·∫°i Dashboard
          </button>
        </form>
      </aside>
    </div>

    <script th:inline="javascript">
      function backToDashboard(event) {
        if (event) {
          event.preventDefault();
        }

        const form = document.getElementById("backToDashboardForm");
        if (form) {
          const formData = new FormData(form);
          const params = new URLSearchParams();
          formData.forEach((value, key) => {
            params.append(key, value);
          });

          try {
            fetch(form.action, {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-Requested-With": "XMLHttpRequest",
              },
              body: params,
              keepalive: true,
            }).catch((error) => {
              console.error(
                "Failed to rollback take-away session before closing tab:",
                error
              );
            });
          } catch (error) {
            console.error("Failed to initiate rollback request:", error);
          }
        }

        attemptCloseTab();
      }

      function attemptCloseTab() {
        window.open("", "_self");
        window.close();
        setTimeout(function () {
          if (!document.hidden && !window.closed) {
            window.location.href = "about:blank";
          }
        }, 200);
      }
    </script>

    <!-- WebSocket Libraries (SockJS + Stomp) -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <!-- Application Scripts -->
    <script th:src="@{/js/cashier/view-menu-takeaway.js}"></script>
    <script th:src="@{/js/cashier/menu-takeaway-websocket.js}"></script>
  </body>
</html>
