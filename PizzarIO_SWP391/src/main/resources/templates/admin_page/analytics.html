<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Analytics • Admin Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/admin_page/styles.css}" />
    <link rel="stylesheet" th:href="@{/css/admin_page/analytics.css}" />
  </head>
  <body>
    <div class="app">
      <!-- SIDEBAR -->
      <div th:insert="~{fragments/sidebar :: sidebar('analytics')}"></div>

      <!-- MAIN -->
      <main class="main">
        <header class="page-header">
          <div>
            <h1>Admin Dashboard</h1>
            <p class="muted">Quản lý nhà hàng</p>
          </div>
          <div class="userbox">
            <div class="avatar">M</div>
            <div class="who">
              <!-- TODO bind: tên người đăng nhập -->
              <strong id="currentUser">—</strong>
              <!-- TODO bind: vai trò -->
              <span id="currentRole" class="muted"></span>
            </div>
          </div>
        </header>

        <section>
          <div class="analytics-header">
            <div>
              <h2>Số liệu phân tích về kênh</h2>
              <p class="muted">
                Chỉ số thời gian •
                <span id="rangeLabel" th:text="${dateRangeLabel} ?: '28 ngày qua'">28 ngày qua</span>
              </p>
            </div>

            <!-- Dropdown chọn khoảng thời gian -->
            <div class="time-range-wrapper">
              <select id="timeRangeSelect">
                <option value="7" th:selected="${selectedDays != null && selectedDays == 7}">7 ngày qua</option>
                <option value="28" th:selected="${selectedDays == null || selectedDays == 28}">28 ngày qua</option>
                <option value="custom" th:selected="${isCustomRange}"> Tùy chỉnh </option>
              </select>

              <!-- Date pickers cho tùy chỉnh -->
              <div id="customDateRange">
                <div class="date-field">
                  <label>Từ ngày:</label>
                  <input type="date" id="startDate" />
                </div>
                <div class="date-field">
                  <label>Đến ngày:</label>
                  <input type="date" id="endDate" />
                </div>
                <button id="applyCustomDate">Áp dụng</button>
              </div>
            </div>
          </div>

          <!-- KPI (4 thẻ) -->
          <div class="grid four">
            <article class="card">
              <div class="card-title">Doanh thu</div>
              <p
                class="kpi-value"
                th:text="${#numbers.formatDecimal(analytics.totalRevenue, 0, 'COMMA', 0, 'POINT')} + ' đ'"
              >
                0 đ
              </p>
              <p
                class="kpi-delta"
                th:classappend="${analytics.revenueDelta >= 0 ? 'positive' : 'negative'}"
              >
                <span
                  th:text="${analytics.revenueDelta >= 0 ? '↑' : '↓'}"
                ></span>
                <span
                  th:text="${#numbers.formatDecimal(analytics.revenueDelta, 1, 2)}"
                  >0</span
                >%
                <span
                  class="comparison-text"
                  th:text="${selectedDays != null ? 'so với ' + selectedDays + ' ngày trước' : 'so với 28 ngày trước'}"
                  >so với 28 ngày trước</span
                >
              </p>
            </article>

            <article class="card">
              <div class="card-title">Đơn hàng</div>
              <p class="kpi-value" th:text="${analytics.totalOrders()}">0đ</p>
              <p
                class="kpi-delta"
                th:classappend="${analytics.totalOrders() >= 0 ? 'positive' : 'negative'}"
              >
                <span
                  th:text="${analytics.ordersDelta() >= 0 ? '↑' : '↓'}"
                ></span>
                <span
                  th:text="${#numbers.formatDecimal(analytics.ordersDelta(), 1, 2)}"
                  >0</span
                >%
                <span
                  class="comparison-text"
                  th:text="${selectedDays != null ? 'so với ' + selectedDays + ' ngày trước' : 'so với 28 ngày trước'}"
                  >so với 28 ngày trước</span
                >
              </p>
            </article>

            <article class="card">
              <div class="card-title">Khách mới</div>
              <p class="kpi-value" th:text="${analytics.newCustomers()}">0đ</p>
              <p
                class="kpi-delta"
                th:classappend="${analytics.newCustomersDelta() >= 0 ? 'positive' : 'negative'}"
              >
                <span
                  th:text="${analytics.newCustomersDelta >= 0 ? '↑' : '↓'}"
                ></span>
                <span
                  th:text="${#numbers.formatDecimal(analytics.newCustomersDelta, 1, 2)}"
                  >0</span
                >%
                <span
                  class="comparison-text"
                  th:text="${selectedDays != null ? 'so với ' + selectedDays + ' ngày trước' : 'so với 28 ngày trước'}"
                  >so với 28 ngày trước</span
                >
              </p>
            </article>

            <article class="card">
              <div class="card-title">Giá trị TB</div>
              <p
                class="kpi-value"
                th:text="${#numbers.formatDecimal(analytics.aov(), 0, 'COMMA', 0, 'POINT')} + ' đ'"
              >
                0 đ
              </p>
              <p
                class="kpi-delta"
                th:classappend="${analytics.aovDelta() >= 0 ? 'positive' : 'negative'}"
              >
                <span th:text="${analytics.aovDelta >= 0 ? '↑' : '↓'}"></span>
                <span
                  th:text="${#numbers.formatDecimal(analytics.aovDelta, 1, 2)}"
                  >0</span
                >%
                <span
                  class="comparison-text"
                  th:text="${selectedDays != null ? 'so với ' + selectedDays + ' ngày trước' : 'so với 28 ngày trước'}"
                  >so với 28 ngày trước</span
                >
              </p>
            </article>
          </div>

          <div class="main-analytics">
            <!-- Biểu đồ đường -->
            <article class="card">
              <div class="card-title">Doanh thu theo thời gian</div>
              <div class="chartCard">
                <div class="chartBox">
                  <canvas id="myChartLine"></canvas>
                </div>
              </div>
            </article>

            <!-- Cột phải -->
            <aside class="analytics-sidebar">
              <article class="card">
                <div class="card-title">Thời gian thực</div>
                <div class="list">
                  <!-- TODO bind: đơn hôm nay -->
                  <div class="row">
                    <span class="muted">Đơn hàng hôm nay</span
                    ><strong class="big" id="todayOrders">—</strong>
                  </div>
                  <!-- TODO bind: doanh thu hôm nay -->
                  <div class="row">
                    <span class="muted">Doanh thu hôm nay</span
                    ><strong class="big green revenue-amount" id="todayRevenue"
                      >—</strong
                    >
                  </div>
                </div>
              </article>

              <article class="card">
                <div class="card-title">Xem chi tiết khách hàng</div>
                <div class="list">
                  <!-- TODO bind: KH mới hôm nay -->
                  <div class="row">
                    <span class="muted">Khách hàng mới</span
                    ><strong
                      id="todayNewCustomers"
                      th:text="${analytics.newCustomers()}"
                    ></strong>
                  </div>
                  <!-- TODO bind: KH quay lại -->
                  <div class="row">
                    <span class="muted">Khách hàng quay lại</span
                    ><strong
                      id="todayReturning"
                      th:text="${analytics.oldCustomers()}"
                    ></strong>
                  </div>
                  <!-- TODO bind: tỷ lệ giữ chân -->
                  <div class="row">
                    <span class="muted">Tỷ lệ giữ chân</span
                    ><strong
                      id="retentionRate"
                      th:text="${analytics.retentionRate()}"
                    ></strong>
                  </div>
                </div>
              </article>
            </aside>
          </div>

          <div class="grid two bottom-grid">
            <article class="card">
              <div class="card-title">Top sản phẩm bán chạy</div>
              <table class="table" id="tableTopProducts">
                <thead>
                  <tr>
                    <th>Top</th>
                    <th>Sản phẩm</th>
                    <th>Đơn</th>
                    <th>Số lượng</th>
                    <th>Doanh thu</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:if="${topProducts == null || topProducts.isEmpty()}">
                    <td colspan="5" style="text-align: center">
                      Chưa có dữ liệu
                    </td>
                  </tr>

                  <tr th:each="product : ${topProducts}">
                    <td th:text="${product.topId}">1</td>
                    <td class="product-name" th:text="${product.productName}">
                      Pizza Margherita
                    </td>
                    <td class="text-center" th:text="${product.orderCount}">
                      0
                    </td>
                    <td class="text-center" th:text="${product.quantitySold}">
                      0
                    </td>
                    <td
                      class="revenue-cell"
                      th:text="${#numbers.formatDecimal(product.totalRevenue, 0, 'COMMA', 0, 'POINT')} + ' đ'"
                    >
                      0 đ
                    </td>
                  </tr>
                </tbody>
              </table>
            </article>

            <article class="card">
              <div class="card-title">Doanh thu 7 ngày gần nhất</div>
              <!-- TODO bind: data-series(JSON) để vẽ chart cột -->
              <div class="chartCard">
                <div class="chartBox">
                  <canvas id="myChartBar"></canvas>
                </div>
              </div>
            </article>
          </div>
        </section>
      </main>
    </div>

    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"
    ></script>

    <script th:inline="javascript">
      /*<![CDATA[*/
      window.CHART_DATA = {
        // Bar Chart Data
        labels_bar: /*[[${labels_bar}]]*/ [],
        data_bar: /*[[${data_bar}]]*/ [],

        // Line Chart Data
        labels_Line: /*[[${labels_Line}]]*/ [],
        data_Line: /*[[${data_Line}]]*/ [],
      };
      /*]]>*/
    </script>

    <script th:src="@{/js/admin/analytics-date-filter.js}"></script>
    <script th:src="@{/js/admin/analytics-charts.js}" defer></script>
  </body>
</html>
