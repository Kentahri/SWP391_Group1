<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω Voucher</title>
    <link rel="stylesheet" th:href="@{/css/admin_page/styles.css}" />
    <link rel="stylesheet" th:href="@{/css/admin_page/voucher.css}" />
  </head>
  <body>
    <div class="app">
      <!-- SIDEBAR -->
      <div th:insert="~{fragments/sidebar :: sidebar('vouchers')}"></div>

      <!-- MAIN -->
      <main class="main">
        <header class="page-header">
          <div>
            <h1>Qu·∫£n l√Ω Voucher</h1>
            <p class="muted">T·∫°o v√† qu·∫£n l√Ω c√°c m√£ gi·∫£m gi√° cho kh√°ch h√†ng</p>
          </div>
          <div class="userbox">
            <div class="avatar">M</div>
            <div class="who">
              <strong>Manager</strong>
              <span class="muted">Qu·∫£n l√Ω</span>
            </div>
          </div>
        </header>

        <div class="voucher-container">
          <!-- Header with Create Button -->
          <div class="voucher-header">
            <h2>Qu·∫£n l√Ω Voucher</h2>
            <!-- TODO BACKEND: C√≥ th·ªÉ t·∫°o form create ri√™ng ho·∫∑c d√πng modal popup -->
            <button
              class="btn-create"
              onclick="alert('TODO: Implement create voucher form')"
            >
              <span>+</span>
              <span>T·∫°o voucher</span>
            </button>
          </div>

          <!-- 
            ==================== BACKEND TODO #1: STATISTICS ====================
            Controller method c·∫ßn truy·ªÅn v√†o Model:
            
            @ModelAttribute("stats") VoucherStatisticsDTO stats
            
            VoucherStatisticsDTO c·∫ßn c√≥:
            - totalVouchers (Integer): count t·∫•t c·∫£ vouchers trong DB
            - activeVouchers (Integer): count vouchers c√≥ active=true v√† validTo > now()
            - totalUsages (Integer): sum c·ªßa timesUsed t·ª´ t·∫•t c·∫£ vouchers
            - totalSavings (Double): t·ªïng ti·ªÅn ƒë√£ gi·∫£m cho kh√°ch (t·ª´ orders history)
            
            V√≠ d·ª•:
            VoucherStatisticsDTO stats = new VoucherStatisticsDTO();
            stats.setTotalVouchers(voucherRepository.count());
            stats.setActiveVouchers(voucherRepository.countByActiveAndValidToAfter(true, LocalDateTime.now()));
            stats.setTotalUsages(voucherRepository.sumTimesUsed());
            stats.setTotalSavings(orderRepository.sumDiscountAmountFromVouchers());
            model.addAttribute("stats", stats);
            ====================================================================
          -->
          <div class="stats-grid">
            <div class="stat-card">
              <h3>T·ªïng voucher</h3>
              <p
                class="value"
                th:text="${stats != null ? stats.totalVouchers : 0}"
              ></p>
              <p class="subtitle">voucher ƒë√£ t·∫°o</p>
            </div>
            <div class="stat-card">
              <h3>ƒêang ho·∫°t ƒë·ªông</h3>
              <p
                class="value"
                th:text="${stats != null ? stats.activeVouchers : 0}"
              ></p>
              <p class="subtitle">voucher c√≥ th·ªÉ s·ª≠ d·ª•ng</p>
            </div>
            <div class="stat-card">
              <h3>L∆∞·ª£t s·ª≠ d·ª•ng</h3>
              <p
                class="value"
                th:text="${stats != null ? stats.totalUsages : 0}"
              ></p>
              <p class="subtitle">l·∫ßn ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng</p>
            </div>
            <div class="stat-card">
              <h3>T·ªïng ti·∫øt ki·ªám</h3>
              <p
                class="value"
                th:text="${stats != null ? #numbers.formatDecimal(stats.totalSavings/1000000, 1, 'POINT', 1, 'COMMA') + 'M' : '0M'}"
              ></p>
              <p class="subtitle">VND ƒë√£ gi·∫£m cho kh√°ch</p>
            </div>
          </div>

          <!-- 
            ==================== BACKEND TODO #2: VOUCHERS LIST ====================
            Controller method c·∫ßn truy·ªÅn v√†o Model:
            
            @ModelAttribute("vouchers") List<Voucher> vouchers
            
            L·∫•y t·∫•t c·∫£ vouchers t·ª´ DB, s·∫Øp x·∫øp theo createdDate DESC:
            List<Voucher> vouchers = voucherRepository.findAllByOrderByCreatedDateDesc();
            model.addAttribute("vouchers", vouchers);
            
            C√°c field trong Voucher entity c·∫ßn c√≥:
            - id (Long)
            - code (String): m√£ voucher VD: "WELCOME20"
            - description (String): m√¥ t·∫£ voucher
            - type (VoucherType enum): "PERCENTAGE" ho·∫∑c "FIXED_AMOUNT"
            - value (Double): gi√° tr·ªã gi·∫£m (20 cho 20% ho·∫∑c 50000 cho 50k VND)
            - minOrderAmount (Double): gi√° tr·ªã ƒë∆°n h√†ng t·ªëi thi·ªÉu
            - maxUses (Integer): s·ªë l·∫ßn s·ª≠ d·ª•ng t·ªëi ƒëa
            - timesUsed (Integer): s·ªë l·∫ßn ƒë√£ s·ª≠ d·ª•ng
            - validFrom (LocalDateTime): ng√†y b·∫Øt ƒë·∫ßu
            - validTo (LocalDateTime): ng√†y k·∫øt th√∫c
            - active (Boolean): tr·∫°ng th√°i k√≠ch ho·∫°t
            
            L∆ØU √ù:
            - N·∫øu mu·ªën hi·ªÉn th·ªã status "ƒê√£ h·∫øt h·∫°n", c√≥ th·ªÉ:
              1. T·∫°o VoucherDisplayDTO v·ªõi computed field getStatus()
              2. Ho·∫∑c d√πng JavaScript ƒë·ªÉ check validTo < now() ·ªü frontend
            - Progress bar t·ª± ƒë·ªông t√≠nh t·ª´ timesUsed/maxUses
            ====================================================================
          -->
          <div class="vouchers-grid">
            <div th:each="voucher : ${vouchers}" class="voucher-card">
              <div class="voucher-card-header">
                <div class="voucher-icon">üéüÔ∏è</div>
                <div class="voucher-info">
                  <h3 class="voucher-title">
                    <span th:text="${voucher.description ?: 'Voucher'}"></span>
                    <!-- Badge status: active=true ‚Üí "K√≠ch ho·∫°t" (xanh), active=false ‚Üí "T·∫°m d·ª´ng" (v√†ng) -->
                    <span
                      class="badge-status"
                      th:classappend="${voucher.active ? 'badge-active' : 'badge-paused'}"
                      th:text="${voucher.active ? 'K√≠ch ho·∫°t' : 'T·∫°m d·ª´ng'}"
                    ></span>
                  </h3>
                  <div class="voucher-code" th:text="${voucher.code}"></div>
                </div>
                <div class="voucher-actions">
                  <button class="btn-action" title="T·∫°m d·ª´ng">‚è∏Ô∏è</button>
                </div>
              </div>

              <p
                class="voucher-description"
                th:text="${voucher.description ?: 'Kh√¥ng c√≥ m√¥ t·∫£'}"
              ></p>

              <div class="voucher-details">
                <div class="detail-item">
                  <span class="detail-label">Gi·∫£m gi√°:</span>
                  <!-- Format theo type: PERCENTAGE ‚Üí "20%", FIXED_AMOUNT ‚Üí "50,000 VND" -->
                  <span
                    class="detail-value"
                    th:text="${voucher.type == 'PERCENTAGE' ? voucher.value + '%' : #numbers.formatDecimal(voucher.value, 0, 'POINT', 3, 'COMMA') + ' VND'}"
                  ></span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">ƒê∆°n t·ªëi thi·ªÉu:</span>
                  <span
                    class="detail-value"
                    th:text="${#numbers.formatDecimal(voucher.minOrderAmount, 0, 'POINT', 3, 'COMMA') + ' VND'}"
                  ></span>
                </div>
              </div>

              <!-- Progress bar t·ª± ƒë·ªông t√≠nh % t·ª´ timesUsed/maxUses -->
              <div class="usage-progress">
                <div class="progress-label">
                  <span>ƒê√£ s·ª≠ d·ª•ng:</span>
                  <span
                    ><span th:text="${voucher.timesUsed}"></span>/<span
                      th:text="${voucher.maxUses}"
                    ></span
                  ></span>
                </div>
                <div class="progress-bar-container">
                  <div
                    class="progress-bar-fill"
                    th:style="'width: ' + ${voucher.maxUses > 0 ? (voucher.timesUsed * 100.0 / voucher.maxUses) : 0} + '%'"
                  ></div>
                </div>
              </div>

              <!-- Date range: format d/M/yyyy -->
              <div class="date-range">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                  ></path>
                </svg>
                <span
                  th:text="${#temporals.format(voucher.validFrom, 'd/M/yyyy')} + ' - ' + ${#temporals.format(voucher.validTo, 'd/M/yyyy')}"
                ></span>
              </div>

              <!-- Action buttons -->
              <div class="card-footer">
                <a
                  th:href="@{'/manager/vouchers/edit/' + ${voucher.id}}"
                  class="btn-edit"
                  >S·ª≠a</a
                >
                <form
                  th:action="@{'/manager/vouchers/delete/' + ${voucher.id}}"
                  method="post"
                  style="display: inline"
                  onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a voucher n√†y?')"
                >
                  <button type="submit" class="btn-delete">X√≥a</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </body>
</html>
