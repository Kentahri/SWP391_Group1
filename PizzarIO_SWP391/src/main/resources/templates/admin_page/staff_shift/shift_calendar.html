<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω ca l√†m vi·ªác</title>
    <link rel="stylesheet" th:href="@{/css/admin_page/styles.css}" />
    <link rel="stylesheet" th:href="@{/css/admin_page/shift-management.css}" />
    <!-- ƒê·∫£m b·∫£o trong <head> c√≥ 3 meta n√†y -->
    <meta name="_csrf" content="[[${_csrf.token}]]" />
    <meta name="_csrf_parameter" content="[[${_csrf.parameterName}]]" />
    <meta name="_csrf_header" content="[[${_csrf.headerName}]]" />
  </head>
  <body>
    <div class="app">
      <!-- SIDEBAR -->
      <div th:insert="~{fragments/sidebar :: sidebar('staff_shifts')}"></div>

      <!-- MAIN -->
      <main class="main">
        <header class="page-header">
          <div>
            <h1>Qu·∫£n l√Ω ca l√†m vi·ªác</h1>
            <p class="muted">Ph√¢n ca v√† theo d√µi th·ªùi gian l√†m vi·ªác</p>
          </div>
          <div class="userbox">
            <div class="avatar">M</div>
            <div class="who">
              <strong>Manager</strong>
              <span class="muted">Qu·∫£n l√Ω</span>
            </div>
          </div>
        </header>

        <div class="container">
          <!-- Success/Error Messages -->
          <div
            th:if="${message}"
            class="alert alert-success"
            th:text="${message}"
          ></div>
          <div
            th:if="${error}"
            class="alert alert-error"
            th:text="${error}"
          ></div>

          <!-- Tabs Navigation -->
          <div class="tabs-nav">
            <a th:href="@{/manager/staff_shifts}" class="tab-btn active">
              üìÖ L·ªãch ph√¢n c√¥ng ca
            </a>
            <a th:href="@{/manager/shifts}" class="tab-btn">
              ‚öôÔ∏è Qu·∫£n l√Ω lo·∫°i ca
            </a>
          </div>

          <!-- Tab: Calendar View -->
          <div id="tab-calendar" class="tab-content active">
            <div class="stats-grid">
              <div class="stat-card blue">
                <div class="stat-content">
                  <h3>T·ªïng ca l√†m vi·ªác</h3>
                  <div
                    class="stat-value"
                    th:text="${stats != null ? stats.totalShifts : 0}"
                  >
                    14
                  </div>
                </div>
                <div class="stat-icon blue">üìÖ</div>
              </div>

              <div class="stat-card green">
                <div class="stat-content">
                  <h3>T·ªïng gi·ªù l√†m</h3>
                  <div
                    class="stat-value"
                    th:text="${stats != null ? stats.totalHours + 'h' : '0h'}"
                  >
                    109h
                  </div>
                </div>
                <div class="stat-icon green">üïê</div>
              </div>

              <div class="stat-card purple">
                <div class="stat-content">
                  <h3>T·ªïng l∆∞∆°ng</h3>
                  <div
                    class="stat-value"
                    th:text="${stats != null ? #numbers.formatDecimal(stats.totalWage, 1, 'COMMA', 0, 'COMMA') + 'ƒë' : '0ƒë'}"
                  >
                    4.180.000ƒë
                  </div>
                </div>
                <div class="stat-icon purple">üë•</div>
              </div>

              <div class="stat-card orange">
                <div class="stat-content">
                  <h3>Ca ho√†n th√†nh</h3>
                  <div class="stat-value">
                    <span th:text="${stats != null ? stats.completedShifts : 0}"
                      >11</span
                    >/<span th:text="${stats != null ? stats.totalShifts : 0}"
                      >14</span
                    >
                  </div>
                </div>
                <div class="stat-icon orange">‚ö†Ô∏è</div>
              </div>
            </div>

            <!-- Main Calendar Card -->
            <div class="main-card">
              <!-- Calendar Header with Filters -->
              <div class="calendar-header">
                <div class="calendar-title">
                  <span>üìÖ</span>
                  <span>L·ªãch ca l√†m vi·ªác</span>
                </div>

                <div class="calendar-controls">
                  <div class="filter-group">
                    <span class="filter-label">üîç</span>
                    <select
                      class="filter-select"
                      id="staffFilter"
                      onchange="filterByStaff()"
                    >
                      <option value="">T·∫•t c·∫£ nh√¢n vi√™n</option>
                      <option
                        th:each="staff : ${allStaff}"
                        th:value="${staff.id}"
                        th:text="${staff.name}"
                        th:selected="${selectedStaffId != null && selectedStaffId == staff.id}"
                      ></option>
                    </select>
                  </div>

                  <div class="filter-group">
                    <select
                      class="filter-select"
                      id="shiftFilter"
                      onchange="filterByShift()"
                    >
                      <option value="">T·∫•t c·∫£ ca</option>
                      <option
                        th:each="shift : ${allShifts}"
                        th:value="${shift.id}"
                        th:text="${shift.shiftName}"
                        th:selected="${selectedShiftId != null && selectedShiftId == shift.id}"
                      ></option>
                    </select>
                  </div>

                  <button class="add-btn" onclick="openStaffShiftModal()">
                    + Th√™m ca l√†m vi·ªác
                  </button>
                </div>
              </div>

              <!-- Staff Shift Assignment Modal -->
              <div id="staffShiftModal" class="modal">
                <div class="modal-content">
                  <div class="modal-header">
                    <h2 id="staffShiftModalTitle">Th√™m ca l√†m vi·ªác</h2>
                    <span class="close" onclick="closeStaffShiftModal()"
                      >&times;</span
                    >
                  </div>

                  <form
                    id="staffShiftForm"
                    method="post"
                    th:object="${staffShiftForm}"
                    th:action="@{/manager/staff_shifts/save}"
                  >
                    <input type="hidden" th:field="*{id}" />
                    <input
                      type="hidden"
                      th:if="${_csrf != null}"
                      th:name="${_csrf.parameterName}"
                      th:value="${_csrf.token}"
                    />

                    <!-- Preserve URL parameters when submitting form (use different names to avoid conflict) -->
                    <input
                      type="hidden"
                      name="weekOffset"
                      th:value="${param.weekOffset}"
                    />
                    <input
                      type="hidden"
                      name="filterStaffId"
                      th:value="${selectedStaffId}"
                    />
                    <input
                      type="hidden"
                      name="filterShiftId"
                      th:value="${selectedShiftId}"
                    />

                    <!-- Display validation errors -->
                    <div
                      th:if="${#fields.hasErrors('*')}"
                      class="alert alert-error"
                      style="
                        margin-bottom: 15px;
                        padding: 10px;
                        background-color: #fee;
                        border: 1px solid #fcc;
                        border-radius: 4px;
                      "
                    >
                      <strong>‚ö†Ô∏è L·ªói nh·∫≠p li·ªáu:</strong>
                      <ul style="margin: 5px 0 0 20px">
                        <li
                          th:each="err : ${#fields.errors('*')}"
                          th:text="${err}"
                        ></li>
                      </ul>
                    </div>

                    <div class="mb-3">
                      <label for="workDate">Ng√†y l√†m</label>
                      <input
                        id="workDate"
                        type="date"
                        th:field="*{workDate}"
                        th:readonly="${staffShiftForm.id != null && staffShiftForm.id > 0}"
                      />
                      <span
                        class="error-message"
                        th:if="${#fields.hasErrors('workDate')}"
                        th:errors="*{workDate}"
                      ></span>
                    </div>

                    <div class="mb-3">
                      <label for="ssShiftId">Lo·∫°i ca</label>
                      <select
                        id="ssShiftId"
                        th:field="*{shiftId}"
                        onchange="updateSalaryFromShift()"
                      >
                        <option value="" disabled>-- Ch·ªçn ca --</option>
                        <option
                          th:each="sh : ${allShifts}"
                          th:value="${sh.id}"
                          th:text="${sh.shiftName + ' (' + #temporals.format(sh.startTime,'HH:mm') + '-' + #temporals.format(sh.endTime,'HH:mm') + ')'}"
                          th:data-salary="${sh.salaryPerShift}"
                        ></option>
                      </select>
                      <span
                        class="error-message"
                        th:if="${#fields.hasErrors('shiftId')}"
                        th:errors="*{shiftId}"
                      ></span>
                    </div>

                    <div class="mb-3">
                      <label for="ssStaffId">Nh√¢n vi√™n</label>
                      <select id="ssStaffId" th:field="*{staffId}">
                        <option value="" disabled>-- Ch·ªçn nh√¢n vi√™n --</option>
                        <option
                          th:each="s : ${allStaff}"
                          th:value="${s.id}"
                          th:text="${s.name}"
                        ></option>
                      </select>
                      <span
                        class="error-message"
                        th:if="${#fields.hasErrors('staffId')}"
                        th:errors="*{staffId}"
                      ></span>
                    </div>

                    <div class="mb-3">
                      <label for="hourlyWage">L∆∞∆°ng/ca (VNƒê) - T·ª± ƒë·ªông</label>
                      <input
                        id="hourlyWage"
                        type="number"
                        step="1000"
                        th:field="*{hourlyWage}"
                        placeholder="L∆∞∆°ng s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t"
                        readonly
                        style="background-color: #f5f5f5"
                      />
                      <small class="text-muted"
                        >L∆∞∆°ng ƒë∆∞·ª£c t·ª± ƒë·ªông t√≠nh t·ª´ lo·∫°i ca ƒë√£ ch·ªçn</small
                      >
                    </div>

                    <div class="mb-3">
                      <label for="ssStatus">Tr·∫°ng th√°i</label>
                      <select id="ssStatus" th:field="*{status}" disabled>
                        <option value="SCHEDULED" selected>SCHEDULED</option>
                      </select>
                      <small class="text-muted"
                        >Tr·∫°ng th√°i m·∫∑c ƒë·ªãnh l√† SCHEDULED</small
                      >
                    </div>

                    <div class="mb-3">
                      <label for="ssNote">Ghi ch√∫</label>
                      <textarea
                        id="ssNote"
                        th:field="*{note}"
                        rows="3"
                        maxlength="500"
                        style="
                          width: 100%;
                          padding: 8px;
                          border: 1px solid #ddd;
                          border-radius: 4px;
                        "
                        readonly
                      ></textarea>
                      <span
                        class="error-message"
                        th:if="${#fields.hasErrors('note')}"
                        th:errors="*{note}"
                      ></span>
                    </div>

                    <div class="modal-footer">
                      <button type="submit" class="btn btn-primary">L∆∞u</button>
                      <button
                        type="button"
                        class="btn btn-secondary"
                        onclick="closeStaffShiftModal()"
                      >
                        H·ªßy
                      </button>
                    </div>
                  </form>
                </div>
              </div>

              <!-- Week Navigation -->
              <div class="week-navigation">
                <button class="week-nav-btn" onclick="navigateWeek(-1)">
                  ‚óÄ Tu·∫ßn tr∆∞·ªõc
                </button>

                <div style="text-align: center">
                  <div class="week-range">
                    <span
                      th:text="${#temporals.format(weekStartDate, 'dd/MM/yyyy')}"
                      >5/10/2025</span
                    >
                    -
                    <span
                      th:text="${#temporals.format(weekEndDate, 'dd/MM/yyyy')}"
                      >11/10/2025</span
                    >
                  </div>
                  <div class="week-current">Tu·∫ßn hi·ªán t·∫°i</div>
                </div>

                <button class="week-nav-btn" onclick="navigateWeek(1)">
                  Tu·∫ßn sau ‚ñ∂
                </button>
              </div>

              <!-- Calendar Grid -->
              <div class="calendar-grid">
                <!-- Loop qua 7 ng√†y trong tu·∫ßn -->
                <div
                  class="day-column"
                  th:each="day : ${weekDays}"
                  th:classappend="${day.isToday} ? 'today' : ''"
                >
                  <div class="day-header">
                    <div class="day-name" th:text="${day.dayName}">CN</div>
                    <div
                      class="day-number"
                      th:text="${#temporals.format(day.date, 'dd')}"
                    >
                      5
                    </div>
                  </div>

                  <div class="shift-cards">
                    <!-- Loop qua c√°c ca trong ng√†y -->
                    <div
                      class="shift-card"
                      th:each="shift : ${day.shifts}"
                      th:classappend="${shift.shiftType}"
                      th:onclick="|editShift(${shift.id})|"
                      style="cursor: pointer"
                    >
                      <div class="shift-type">
                        <span class="icon">‚úèÔ∏è</span>
                        <span th:text="${shift.shiftName}">S√°ng</span>
                      </div>

                      <div
                        class="shift-staff"
                        th:text="${shift.staffName}"
                      ></div>

                      <div
                        class="shift-time"
                        th:text="${shift.timeRange}"
                      ></div>

                      <div
                        class="shift-status"
                        th:classappend="${shift.statusClass}"
                        th:text="${shift.statusText}"
                      ></div>

                      <div
                        class="shift-wage"
                        th:text="${#numbers.formatDecimal(shift.totalWage, 0, 'POINT', 0, 'COMMA') + 'ƒë'}"
                      ></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- End Tab: Calendar View -->

        <!-- Tab: Shift Types Management -->
        <div id="tab-shifts" class="tab-content">
          <div class="shift-management-card">
            <div class="shift-header">
              <h2>Qu·∫£n l√Ω lo·∫°i ca l√†m vi·ªác</h2>
              <button class="add-btn" onclick="openShiftModal()">
                + Th√™m lo·∫°i ca m·ªõi
              </button>
            </div>

            <table class="shift-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>T√™n ca l√†m vi·ªác</th>
                  <th>Gi·ªù b·∫Øt ƒë·∫ßu</th>
                  <th>Gi·ªù k·∫øt th√∫c</th>
                  <th>H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="shift : ${shifts}">
                  <td th:text="${shift.id}">1</td>
                  <td th:text="${shift.shiftName}">Ca s√°ng</td>
                  <td th:text="${shift.startTime}">08:00</td>
                  <td th:text="${shift.endTime}">12:00</td>
                  <td class="actions">
                    <button
                      type="button"
                      class="primary-btn"
                      th:onclick="|editShiftType(${shift.id})|"
                    >
                      S·ª≠a
                    </button>
                    <a
                      class="delete-btn"
                      th:href="@{'/manager/shift/delete/' + ${shift.id}}"
                      th:onclick="|return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ca #${shift.id}?');|"
                      >X√≥a</a
                    >
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <!-- End Tab: Shift Types Management -->
      </main>
    </div>

    <script th:inline="javascript">
      window.openShiftModalFlag = /*[[${openShiftModal}]]*/ null;
      window.openStaffShiftModalFlag = /*[[${openStaffShiftModal}]]*/ null;
      window.shiftTypes = /*[[${shiftTypes}]]*/ [];
    </script>
    <script th:src="@{/js/admin/shift-calendar.js}"></script>
  </body>
</html>
