<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n l√Ω ca l√†m vi·ªác</title>

  <link rel="stylesheet" th:href="@{/css/admin_page/styles.css}" />
  <link rel="stylesheet" th:href="@{/css/admin_page/shift-management.css}" />

  <!-- CSRF meta -->
  <meta name="_csrf" content="[[${_csrf.token}]]" />
  <meta name="_csrf_parameter" content="[[${_csrf.parameterName}]]" />
  <meta name="_csrf_header" content="[[${_csrf.headerName}]]" />
</head>
<body>
<div class="app">
  <!-- SIDEBAR -->
  <div th:insert="~{fragments/sidebar :: sidebar('staff_shifts')}"></div>

  <!-- MAIN -->
  <main class="main">
    <header class="page-header">
      <div>
        <h1>Qu·∫£n l√Ω ca l√†m vi·ªác</h1>
        <p class="muted">Ph√¢n ca v√† theo d√µi th·ªùi gian l√†m vi·ªác</p>
      </div>
      <div class="userbox">
        <div class="avatar">M</div>
        <div class="who">
          <strong>Manager</strong>
          <span class="muted">Qu·∫£n l√Ω</span>
        </div>
      </div>
    </header>

    <div class="container">
      <!-- Toast Messages -->
      <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
      <div th:if="${error}"   class="alert alert-error"   th:text="${error}"></div>

      <!-- Tabs -->
      <div class="tabs-nav">
        <a th:href="@{/manager/staff_shifts}" class="tab-btn active">üìÖ L·ªãch ph√¢n c√¥ng ca</a>
        <a th:href="@{/manager/shifts}" class="tab-btn">‚öôÔ∏è Qu·∫£n l√Ω lo·∫°i ca</a>
      </div>

      <!-- Calendar Tab -->
      <div id="tab-calendar" class="tab-content active">

        <!-- Stats -->
        <div class="stats-grid">
          <div class="stat-card blue">
            <div class="stat-content">
              <h3>T·ªïng ca l√†m vi·ªác</h3>
              <div class="stat-value" th:text="${stats != null ? stats.totalShifts : 0}">0</div>
            </div>
            <div class="stat-icon blue">üìÖ</div>
          </div>

          <div class="stat-card green">
            <div class="stat-content">
              <h3>T·ªïng gi·ªù l√†m</h3>
              <div class="stat-value" th:text="${stats != null ? stats.totalHours + 'h' : '0h'}">0h</div>
            </div>
            <div class="stat-icon green">üïê</div>
          </div>

          <div class="stat-card purple">
            <div class="stat-content">
              <h3>T·ªïng l∆∞∆°ng</h3>
              <div class="stat-value"
                   th:text="${stats != null ? #numbers.formatDecimal(stats.totalWage, 1, 'COMMA', 0, 'COMMA') + 'ƒë' : '0ƒë'}">
                0ƒë
              </div>
            </div>
            <div class="stat-icon purple">üë•</div>
          </div>

          <div class="stat-card orange">
            <div class="stat-content">
              <h3>Ca ho√†n th√†nh</h3>
              <div class="stat-value">
                <span th:text="${stats != null ? stats.completedShifts : 0}">0</span> /
                <span th:text="${stats != null ? stats.totalShifts : 0}">0</span>
              </div>
            </div>
            <div class="stat-icon orange">‚ö†Ô∏è</div>
          </div>
        </div>

        <!-- Main Card -->
        <div class="main-card">
          <!-- Header with Filters -->
          <div class="calendar-header">
            <div class="calendar-title">
              <span>üìÖ</span><span>L·ªãch ca l√†m vi·ªác</span>
            </div>

            <div class="calendar-controls">
              <div class="filter-group">
                <span class="filter-label">üîç</span>
                <select class="filter-select" id="staffFilter" onchange="filterByStaff()">
                  <option value="">T·∫•t c·∫£ nh√¢n vi√™n</option>
                  <option th:each="staff : ${allStaff}"
                          th:value="${staff.id}"
                          th:text="${staff.name}"
                          th:selected="${selectedStaffId != null && selectedStaffId == staff.id}">
                  </option>
                </select>
              </div>

              <div class="filter-group">
                <select class="filter-select" id="shiftFilter" onchange="filterByShift()">
                  <option value="">T·∫•t c·∫£ ca</option>
                  <option th:each="shift : ${allShifts}"
                          th:value="${shift.id}"
                          th:text="${shift.shiftName}"
                          th:selected="${selectedShiftId != null && selectedShiftId == shift.id}">
                  </option>
                </select>
              </div>

              <button class="add-btn" onclick="openStaffShiftModal()">+ Th√™m ca l√†m vi·ªác</button>
            </div>
          </div>

          <!-- Staff Shift Modal -->
          <div id="staffShiftModal" class="modal">
            <div class="modal-content">
              <div class="modal-header">
                <h2 id="staffShiftModalTitle">Th√™m ca l√†m vi·ªác</h2>
                <span class="close" onclick="closeStaffShiftModal()">&times;</span>
              </div>

              <form id="staffShiftForm" method="post" th:action="@{/manager/staff_shifts/save}">
                <!-- id -->
                <input type="hidden" name="id" />

                <!-- CSRF -->
                <input type="hidden"
                       th:if="${_csrf != null}"
                       th:name="${_csrf.parameterName}"
                       th:value="${_csrf.token}" />

                <!-- preserve filters -->
                <input type="hidden" name="weekOffset"   th:value="${param.weekOffset}" />
                <input type="hidden" name="filterStaffId" th:value="${selectedStaffId}" />
                <input type="hidden" name="filterShiftId" th:value="${selectedShiftId}" />

                <!-- Work date -->
                <div class="mb-3">
                  <label for="workDate">Ng√†y l√†m</label>
                  <input id="workDate" type="date" name="workDate" />
                  <span class="error-message" data-error="workDate"></span>
                </div>

                <!-- Shift -->
                <div class="mb-3">
                  <label for="ssShiftId">Lo·∫°i ca</label>
                  <select id="ssShiftId" name="shiftId" onchange="updateSalaryFromShift()">
                    <option value="" disabled selected>-- Ch·ªçn ca --</option>
                    <option th:each="sh : ${allShifts}"
                            th:value="${sh.id}"
                            th:text="${sh.shiftName + ' (' + #temporals.format(sh.startTime,'HH:mm') + '-' + #temporals.format(sh.endTime,'HH:mm') + ')'}"
                            th:attr="data-salary=${sh.salaryPerShift}">
                    </option>
                  </select>
                  <span class="error-message" data-error="shiftId"></span>
                </div>

                <!-- Staff -->
                <div class="mb-3">
                  <label for="ssStaffId">Nh√¢n vi√™n</label>
                  <select id="ssStaffId" name="staffId">
                    <option value="" disabled selected>-- Ch·ªçn nh√¢n vi√™n --</option>
                    <option th:each="s : ${allStaff}" th:value="${s.id}" th:text="${s.name}"></option>
                  </select>
                  <span class="error-message" data-error="staffId"></span>
                </div>

                <!-- Wage (auto) -->
                <div class="mb-3">
                  <label for="hourlyWage">L∆∞∆°ng/ca (VNƒê) - T·ª± ƒë·ªông</label>
                  <input id="hourlyWage" type="number" step="1000" name="hourlyWage"
                         placeholder="L∆∞∆°ng s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t" readonly style="background-color:#f5f5f5" />
                  <small class="text-muted">L∆∞∆°ng ƒë∆∞·ª£c t·ª± ƒë·ªông t√≠nh t·ª´ lo·∫°i ca ƒë√£ ch·ªçn</small>
                </div>

                <!-- Status (fixed) -->
                <div class="mb-3">
                  <label for="ssStatus">Tr·∫°ng th√°i</label>
                  <select id="ssStatus" disabled>
                    <option value="SCHEDULED" selected>SCHEDULED</option>
                  </select>
                  <input type="hidden" name="status" value="SCHEDULED" />
                  <small class="text-muted">Tr·∫°ng th√°i m·∫∑c ƒë·ªãnh l√† SCHEDULED</small>
                </div>

                <!-- Note -->
                <div class="mb-3">
                  <label for="ssNote">Ghi ch√∫</label>
                  <textarea id="ssNote" name="note" rows="3" maxlength="500"
                            style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;"></textarea>
                  <span class="error-message" data-error="note"></span>
                </div>

                <div class="modal-footer">
                  <button type="submit" class="btn btn-primary">L∆∞u</button>
                  <button type="button" class="btn btn-secondary" onclick="closeStaffShiftModal()">H·ªßy</button>
                </div>
              </form>
            </div>
          </div>

          <!-- Week Navigation -->
          <div class="week-navigation">
            <button class="week-nav-btn" onclick="navigateWeek(-1)">‚óÄ Tu·∫ßn tr∆∞·ªõc</button>
            <div style="text-align:center">
              <div class="week-range">
                <span th:text="${#temporals.format(weekStartDate, 'dd/MM/yyyy')}">--/--/----</span>
                -
                <span th:text="${#temporals.format(weekEndDate,   'dd/MM/yyyy')}">--/--/----</span>
              </div>
              <div class="week-current">Tu·∫ßn hi·ªán t·∫°i</div>
            </div>
            <button class="week-nav-btn" onclick="navigateWeek(1)">Tu·∫ßn sau ‚ñ∂</button>
          </div>

          <!-- Calendar Grid -->
          <div class="calendar-grid">
            <div class="day-column" th:each="day : ${weekDays}" th:classappend="${day.isToday} ? 'today' : ''">
              <div class="day-header">
                <div class="day-name"   th:text="${day.dayName}">CN</div>
                <div class="day-number" th:text="${#temporals.format(day.date, 'dd')}">--</div>
              </div>

              <div class="shift-cards">
                <div class="shift-card"
                     th:each="shift : ${day.shifts}"
                     th:classappend="${shift.shiftType}"
                     th:onclick="|editShift(${shift.id})|"
                     style="cursor:pointer">
                  <div class="shift-type">
                    <span class="icon">‚úèÔ∏è</span>
                    <span th:text="${shift.shiftName}">S√°ng</span>
                  </div>
                  <div class="shift-staff"  th:text="${shift.staffName}">NV</div>
                  <div class="shift-time"   th:text="${shift.timeRange}">08:00-12:00</div>
                  <div class="shift-status" th:classappend="${shift.statusClass}" th:text="${shift.statusText}"></div>
                  <div class="shift-wage"   th:text="${#numbers.formatDecimal(shift.totalWage, 0, 'POINT', 0, 'COMMA') + 'ƒë'}"></div>
                </div>
              </div>
            </div>
          </div>
          <!-- /Calendar Grid -->

        </div>
        <!-- /Main Card -->
      </div>
      <!-- /Calendar Tab -->

      <!-- Shift Types Tab -->
      <div id="tab-shifts" class="tab-content">
        <div class="shift-management-card">
          <div class="shift-header">
            <h2>Qu·∫£n l√Ω lo·∫°i ca l√†m vi·ªác</h2>
            <a class="add-btn" th:href="@{/manager/shifts}">+ Th√™m lo·∫°i ca m·ªõi</a>
          </div>

          <table class="shift-table">
            <thead>
            <tr>
              <th>ID</th>
              <th>T√™n ca</th>
              <th>Gi·ªù b·∫Øt ƒë·∫ßu</th>
              <th>Gi·ªù k·∫øt th√∫c</th>
              <th>S·ª≠a</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="shift : ${allShifts}">
              <td th:text="${shift.id}">1</td>
              <td th:text="${shift.shiftName}">S√ÅNG</td>
              <td th:text="${#temporals.format(shift.startTime,'HH:mm')}">08:00</td>
              <td th:text="${#temporals.format(shift.endTime,'HH:mm')}">12:00</td>
              <td class="actions">
                <a class="primary-btn" th:href="@{'/manager/shift/edit/' + ${shift.id}}">S·ª≠a</a>
                <!-- ‚ùå ƒê√É XO√Å button/x·ª≠ l√Ω X√ìA -->
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
    <!-- /container -->
  </main>
</div>

<script th:src="@{/js/admin/shift-calendar.js}"></script>
</body>
</html>
