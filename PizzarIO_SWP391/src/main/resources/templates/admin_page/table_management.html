<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Manage Tables</title>
	<link rel="stylesheet" th:href="@{/css/table-management.css}">
</head>

<body>
<div class="container">
	<div class="header">
		<div style="display:flex; align-items:center; gap:12px">
			<span class="badge">PizzarIO</span>
		</div>
		<button id="openAddTable" class="primary-btn" type="button">Th√™m m·ªõi 1 b√†n</button>
	</div>
	
	<div class="grid">
		<div class="card">
			<div class="pill">ü™ë Table map</div>
			<div class="inner-panel" style="margin-top:12px">
				<div class="map-grid">
					<div th:each="table: ${tables}" class="tile" style="border: 1px solid black"
					     th:attr="
                               data-id=${table.id},
                               data-type=${table.tableType.name()},
                               data-created-at=${#temporals.format(table.createdAt,'yyyy-MM-dd HH:mm')},
                               data-updated-at=${#temporals.format(table.updatedAt,'yyyy-MM-dd HH:mm')},
                               data-condition=${table.tableCondition != null ? table.tableCondition.name() : 'UNKNOWN'},
					           data-delete_url=@{'/table/delete/' + ${table.id}},
					           data-update_url=@{'/table/update/' + ${table.id}}"
					>
						<span class="status-dot"></span>
						<h4>B√†n <span th:text="${table.id}"></span></h4>
					</div>
				</div>
				
				<!-- Modal: Add Table -->
				<div id="addTableModal" class="modal-overlay" aria-hidden="true">
					<div class="modal" role="dialog" aria-modal="true">
						<header>Th√™m b√†n m·ªõi</header>
						<div class="content">
							<form id="addTableForm" th:action="@{/table/add}" method="post" th:object="${tableDTO}">
								<div class="form-row">
									<label>Table Type</label>
									<label>
										<select id="newTableType" name="tableType" th:field="*{tableType}" required>
											<option th:each="type : ${tableTypes}" th:value="${type}"
											        th:text="${type}"></option>
										</select>
									</label>
								</div>
								<div class="actions">
									<button type="button" class="btn-secondary" id="cancelAddTable">H·ªßy</button>
									<button type="submit" class="primary-btn">Th√™m</button>
								</div>
							</form>
						</div>
					</div>
				</div>
				
				<!-- Modal: Update Table -->
				<div id="updateTableModal" class="modal-overlay" aria-hidden="true">
					<div class="modal" role="dialog" aria-modal="true">
						<header>C·∫≠p nh·∫≠t b√†n</header>
						<div class="content">
							<form id="updateTableForm" method="post">
								<div class="form-row">
									<label>Table Type</label>
									<label>
										<select id="updateTableType" name="tableType" required>
											<option th:each="type : ${tableTypes}" th:value="${type}"
											        th:text="${type}"></option>
										</select>
									</label>
								</div>
								<div class="form-row">
									<label>Table Condition</label>
									<label>
										<select id="updateTableCondition" name="tableCondition" required>
											<option th:each="condition : ${tableConditions}" th:value="${condition}"
											        th:text="${condition}"></option>
										</select>
									</label>
								</div>
								<div class="actions">
									<button type="button" class="btn-secondary" id="cancelUpdateTable">H·ªßy</button>
									<button type="submit" class="primary-btn">C·∫≠p nh·∫≠t</button>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<div class="card">
			<div style="height:100%; display:flex; flex-direction:column; gap:12px">
				<div style="font-weight:700"><span id="tableName"></span></div>
				<div>Type: <span id="detailType"></span></div>
				<div>Created at: <span id="detailCreatedAt"></span></div>
				<div>Updated at: <span id="detailUpdatedAt"></span></div>
				<div>Condition: <span id="detailCondition"></span></div>
				
				
				<div style="margin-top:auto; display:flex; justify-content:space-between" id="tableActions"
				     th:if="${!tables.isEmpty()}">
					<form id="deleteForm" method="post">
						<button class="primary-btn" style="background:#ef4444">Delete</button>
					</form>
					<form>
						<button id="updateTableBtn" class="primary-btn">Update</button>
					</form>
				</div>
			</div>
		</div>
	</div>
</div>

<script th:inline="javascript">
    (function () {
        // Add Table Modal
        var openBtn = document.getElementById('openAddTable');
        var modal = document.getElementById('addTableModal');
        var cancelBtn = document.getElementById('cancelAddTable');
        if (openBtn) {
            openBtn.addEventListener('click', function () {
                modal.style.display = 'flex';
            });
        }
        if (cancelBtn) {
            cancelBtn.addEventListener('click', function () {
                modal.style.display = 'none';
            });
        }
        modal && modal.addEventListener('click', function (e) {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        // Update Table Modal
        var updateModal = document.getElementById('updateTableModal');
        var cancelUpdateBtn = document.getElementById('cancelUpdateTable');
        if (cancelUpdateBtn) {
            cancelUpdateBtn.addEventListener('click', function () {
                updateModal.style.display = 'none';
            });
        }
        updateModal && updateModal.addEventListener('click', function (e) {
            if (e.target === updateModal) {
                updateModal.style.display = 'none';
            }
        });
    })();

    document.addEventListener('DOMContentLoaded', function () {
        const tiles = document.querySelectorAll('.tile');
        const deleteForm = document.getElementById('deleteForm');
        const updateForm = document.getElementById('updateTableForm');
        const tableActions = document.getElementById('tableActions');

        let currentTableId = null;

        tiles.forEach(tile => {
            tile.addEventListener('click', function () {
                tiles.forEach(t => t.classList.remove('selected'));
                this.classList.add('selected');

                const ds = this.dataset;
                document.getElementById('detailType').textContent = ds.type || '';
                document.getElementById('detailCreatedAt').textContent = ds.createdAt || '';
                document.getElementById('detailUpdatedAt').textContent = ds.updatedAt || '';
                document.getElementById('detailCondition').textContent = ds.condition || '';
                document.getElementById('tableName').textContent = 'B√†n ' + (ds.id || '');

                console.log(ds);
                console.log(ds.delete_url);
                console.log(ds.update_url);
                
                currentTableId = ds.id;
                deleteForm.action = ds.delete_url;
                updateForm.action = ds.update_url;
	            
                document.getElementById('updateTableType').value = ds.type || '';
                document.getElementById('updateTableCondition').value = ds.condition || '';

                tableActions.style.display = 'flex';
            });
            tableActions.style.display = 'none';
        });

        // Delete form handler
        if (deleteForm) {
            deleteForm.addEventListener('submit', function (e) {
                if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†n n√†y?')) {
                    e.preventDefault();
                }
            });
        }

        // Update button handler
        const updateBtn = document.getElementById('updateTableBtn');
        if (updateBtn) {
            updateBtn.addEventListener('click', function (e) {
                e.preventDefault();
                if (currentTableId) {
                    document.getElementById('updateTableModal').style.display = 'flex';
                }
            });
        }
    });


</script>
</body>
</html>