<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitchen Dashboard - PizzarIO</title>
    <link rel="stylesheet" th:href="@{/css/kitchen.css}" />
    <link rel="stylesheet" th:href="@{/css/kitchen-dashboard.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Connection Status
    <div id="connectionStatus" class="connection-status disconnected">
        <i class="fas fa-circle"></i> ƒêang k·∫øt n·ªëi...
    </div> -->

    <!-- Top bar -->
    <header class="topbar">
        <div class="brand">üçï PizzarIO</div>
        <div class="staff-info">
            <span>T√™n: <strong th:text="${staff.name}">Kitchen Staff</strong></span>
        </div>
        <div class="datetime-info">
            <div id="clock" class="clock">--:--:--</div>
            <div id="date" class="date">--/--/----</div>
        </div>
        <div class="actions">
            <a th:href="@{/kitchen/dashboard}" class="btn btn-primary" style="text-decoration: none; display: inline-block">
                üìä Dashboard
            </a>
            <a th:href="@{/kitchen/order-list}" class="btn btn-secondary" style="text-decoration: none; display: inline-block">
                üìã Danh s√°ch ƒë∆°n h√†ng
            </a>
            <a th:href="@{/kitchen/outstock}" class="btn btn-secondary" style="text-decoration: none; display: inline-block">
                üçΩÔ∏è Qu·∫£n l√Ω Menu
            </a>
            <form th:action="@{/logout}" method="post" style="display: inline;">
                <input
                    type="hidden"
                    th:if="${_csrf != null}"
                    th:name="${_csrf.parameterName}"
                    th:value="${_csrf.token}"
                />
                <button
                    type="submit"
                    class="btn-logout"
                    onclick="return confirm('B·∫°n c√≥ mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?')"
                >
                    üö™ ƒêƒÉng xu·∫•t
                </button>
            </form>
        </div>
    </header>

    <!-- Main Content -->
    <main class="kitchen-main">
        <!-- Dashboard Title -->
        <div class="dashboard-title">
            <div class="title-left">
                <h1><i class="fas fa-tachometer-alt"></i> Kitchen Dashboard</h1>
                <p>Danh s√°ch m√≥n ƒÉn ƒë∆∞·ª£c s·∫Øp x·∫øp theo lo·∫°i v√† th·ªùi gian</p>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-utensils"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" th:text="${totalDishes}">0</div>
                    <div class="stat-label">T·ªïng m√≥n</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon new">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" th:text="${newDishes}">0</div>
                    <div class="stat-label">M√≥n m·ªõi</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon preparing">
                    <i class="fas fa-user-chef"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" th:text="${preparingDishes}">0</div>
                    <div class="stat-label">ƒêang l√†m</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon completed">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" th:text="${completedDishes}">0</div>
                    <div class="stat-label">Ho√†n th√†nh</div>
                </div>
            </div>
        </div>

        <!-- Category Filter Bar -->
        <div class="category-filter-container">
            <div class="category-filter" id="categoryFilter">
                <div class="category-item active" data-category="all">
                    <div class="category-name">T·∫•t c·∫£</div>
                    <div class="category-count" th:text="${totalDishes}">0</div>
                </div>
                <div th:each="category : ${categories}" class="category-item" th:data-category="${category.id}" th:data-category-name="${category.name}">
                    <div class="category-name" th:text="${category.name}">Category</div>
                    <div class="category-count" th:text="${groupedItems[category.name] != null ? #lists.size(groupedItems[category.name]) : 0}">0</div>
                </div>
            </div>
        </div>

        <!-- Order Items Display -->
        <div class="order-items-container" id="orderItemsContainer">
            <div th:if="${#maps.isEmpty(groupedItems)}" class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-utensils"></i>
                </div>
                <h3>Kh√¥ng c√≥ m√≥n ƒÉn n√†o</h3>
                <p>Hi·ªán t·∫°i kh√¥ng c√≥ m√≥n ƒÉn n√†o c·∫ßn ch·∫ø bi·∫øn</p>
            </div>

            <div th:each="categoryEntry : ${groupedItems}" th:if="${!#lists.isEmpty(categoryEntry.value)}" class="category-section" th:data-category-name="${categoryEntry.key}">
                <div class="category-header">
                    <div class="category-header-title" th:text="${categoryEntry.key + ' ' + #lists.size(categoryEntry.value) + ' m√≥n'}">Category</div>
                </div>
                <div class="order-items-list">
                    <div th:each="item : ${categoryEntry.value}"
                         th:class="${'order-item-card ' + (item.status == 'PENDING' ? 'new' : (item.status == 'PREPARING' ? 'preparing' : 'completed'))}">
                        <div class="order-item-info">
                            <h3 class="order-item-name">
                                <span th:text="${item.productName}">Product Name</span>
                            </h3>
                            <div th:if="${item.note != null and !item.note.isEmpty()}"
                                 class="order-item-note">
                                <i class="fas fa-sticky-note"></i>
                                <span th:text="${item.note}">Note</span>
                            </div>
                            <div class="order-item-meta">
                                <span class="order-item-quantity" th:text="'x' + ${item.quantity}">x1</span>
                                <span th:if="${item.sizeName != null and !item.sizeName.isEmpty()}"
                                      class="order-item-size"
                                      th:text="${item.sizeName}">(Size)</span>
                                <span th:class="${'order-item-status ' + (item.status == 'PENDING' ? 'new' : (item.status == 'PREPARING' ? 'preparing' : 'completed'))}"
                                      th:text="${item.status == 'PENDING' ? 'M·ªõi' : (item.status == 'PREPARING' ? 'ƒêang l√†m' : 'Ho√†n th√†nh')}">Status</span>
                                <span class="order-item-location">
                                    <i class="fas fa-utensils"></i>
                                    <span th:text="${item.orderInfo.orderType == 'TAKE_AWAY' ? 'Take away' : 'T·∫°i b√†n'}">T·∫°i b√†n</span>
                                </span>
                            </div>
                        </div>
                        <div class="order-item-details">
                            <div class="order-item-order" th:text="${item.orderInfo.code}">ORD-001</div>
                            <div class="order-item-table" th:text="${item.orderInfo.tableName}">B√†n 12</div>
                            <div class="order-item-time">
                                <i class="fas fa-clock"></i>
                                <span th:text="${#temporals.format(item.createdAt, 'HH:mm')}">16:30</span>
                            </div>
                        </div>
                        <div class="order-item-action">
                            <form th:action="@{/kitchen/update-item-status}" method="post" style="display: inline;" class="update-item-form" th:data-item-id="${item.id}">
                                <input type="hidden" th:name="itemId" th:value="${item.id}">
                                <button th:if="${item.status == 'PENDING'}"
                                        type="submit"
                                        name="action"
                                        value="start"
                                        class="action-btn start">B·∫Øt ƒë·∫ßu l√†m</button>
                                <button th:if="${item.status == 'PREPARING'}"
                                        type="submit"
                                        name="action"
                                        value="complete"
                                        class="action-btn complete">Ho√†n th√†nh</button>
                                <button th:if="${item.status == 'SERVED'}"
                                        type="submit"
                                        name="action"
                                        value="undo"
                                        class="action-btn undo">Ho√†n t√°c</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script th:src="@{/js/kitchen/websocket.js}"></script>
    <script>
        // Clock and Date Display
        const $clock = document.getElementById("clock");
        const $date = document.getElementById("date");

        function renderDateTime() {
            const now = new Date();
            if ($clock) {
                $clock.textContent = now.toLocaleTimeString("vi-VN", { hour12: false });
            }
            if ($date) {
                $date.textContent = now.toLocaleDateString("vi-VN", {
                    weekday: "long",
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                });
            }
        }

        renderDateTime();
        setInterval(renderDateTime, 1000);

        // Save scroll position before form submit
        document.addEventListener('submit', function(e) {
            const form = e.target;
            if (form && form.classList.contains('update-item-form')) {
                // L∆∞u scroll position
                const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
                sessionStorage.setItem('kitchenDashboardScrollPosition', scrollPosition);

                // L∆∞u item ID ƒë·ªÉ c√≥ th·ªÉ highlight sau khi reload
                const itemId = form.dataset.itemId;
                if (itemId) {
                    sessionStorage.setItem('kitchenDashboardUpdatedItemId', itemId);
                }
            }
        });

        // Restore scroll position after page load
        window.addEventListener('load', function() {
            // Restore scroll position
            const savedScrollPosition = sessionStorage.getItem('kitchenDashboardScrollPosition');
            if (savedScrollPosition !== null) {
                // S·ª≠ d·ª•ng setTimeout ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ render xong
                setTimeout(function() {
                    window.scrollTo(0, parseInt(savedScrollPosition, 10));
                    // X√≥a scroll position sau khi ƒë√£ restore
                    sessionStorage.removeItem('kitchenDashboardScrollPosition');
                }, 100);
            }

            // Highlight item v·ª´a ƒë∆∞·ª£c update (n·∫øu c√≥)
            const updatedItemId = sessionStorage.getItem('kitchenDashboardUpdatedItemId');
            if (updatedItemId) {
                setTimeout(function() {
                    // T√¨m form c√≥ data-item-id t∆∞∆°ng ·ª©ng
                    const updatedForm = document.querySelector(`form.update-item-form[data-item-id="${updatedItemId}"]`);
                    if (updatedForm) {
                        // T√¨m order item container (c√≥ th·ªÉ l√† .order-item-card ho·∫∑c .order-item)
                        const orderItem = updatedForm.closest('.order-item-card') || updatedForm.closest('.order-item');
                        if (orderItem) {
                            // Th√™m highlight class
                            orderItem.classList.add('just-updated');

                            // Scroll ƒë·∫øn item n·∫øu c·∫ßn (ƒë·∫£m b·∫£o item trong viewport)
                            const rect = orderItem.getBoundingClientRect();
                            const isVisible = rect.top >= 0 && rect.bottom <= window.innerHeight;
                            if (!isVisible) {
                                orderItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }

                            // X√≥a highlight sau 3 gi√¢y
                            setTimeout(function() {
                                orderItem.classList.remove('just-updated');
                            }, 3000);
                        }
                    }
                    // X√≥a item ID sau khi ƒë√£ highlight
                    sessionStorage.removeItem('kitchenDashboardUpdatedItemId');
                }, 200);
            }
        });

        // Navigation handling
        document.addEventListener('click', (e) => {
            // Handle navigation links
            if (e.target.closest('.nav-link')) {
                const navLink = e.target.closest('.nav-link');
                const page = navLink.dataset.page;
                const href = navLink.getAttribute('href');

                console.log('Navigation clicked:', page, href);

                // Update active navigation
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                navLink.classList.add('active');

                // Handle dashboard page (current page)
                if (page === 'dashboard') {
                    e.preventDefault();
                    // Already on dashboard, just update active state
                    return;
                }

                // For other pages, let the browser handle navigation
                // The href attribute will take care of the actual navigation
                console.log('Navigating to:', href);
            }

            // Category filter (client-side only for UI)
            if (e.target.closest('.category-item')) {
                e.preventDefault();
                const categoryItem = e.target.closest('.category-item');
                const categoryId = categoryItem.dataset.category;
                const categoryName = categoryItem.dataset.categoryName;

                // Update active category
                document.querySelectorAll('.category-item').forEach(item => {
                    item.classList.remove('active');
                });
                categoryItem.classList.add('active');

                // Filter items by category
                const allSections = document.querySelectorAll('.category-section');
                if (categoryId === 'all') {
                    // Show all sections
                    allSections.forEach(section => {
                        section.style.display = 'block';
                    });
                } else {
                    // Show only sections matching the selected category name
                    allSections.forEach(section => {
                        const sectionCategoryName = section.dataset.categoryName;
                        if (sectionCategoryName === categoryName) {
                            section.style.display = 'block';
                        } else {
                            section.style.display = 'none';
                        }
                    });
                }
            }
        });
    </script>
</body>
</html>
