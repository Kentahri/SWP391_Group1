@startuml reservation-state-machine
title Reservation Status State Machine & Scheduled Task Lifecycle

[*] --> CONFIRMED : createReservation()
state CONFIRMED {
    state "🔔 Scheduled Task EXISTS" as ScheduledActive
    
    note right of ScheduledActive
        **Scheduled Task đang active:**
        - Task đã được schedule
        - Sẽ tự động chạy vào startTime + 15 phút
        - Có thể bị cancel bất cứ lúc nào
    end note
}

CONFIRMED --> ARRIVED : openTableForGuestWithReservation()\n❌ Cancel scheduled task
state ARRIVED {
    state "✅ Task CANCELED" as TaskCanceled1
}

CONFIRMED --> CANCELED : cancelReservation()\n❌ Cancel scheduled task
state CANCELED {
    state "✅ Task CANCELED" as TaskCanceled2
}

CONFIRMED --> NO_SHOW : ⏰ Auto after 15 minutes\n(Scheduled task tự động chạy)
state NO_SHOW {
    state "✅ Task COMPLETED" as TaskCompleted
    
    note right of TaskCompleted
        **Task đã chạy xong:**
        - Đánh dấu NO_SHOW
        - Mở lại bàn (nếu không còn reservation)
        - Broadcast WebSocket
    end note
}

CONFIRMED --> CONFIRMED : updateReservation()\n🔄 Reschedule task\n(cancel old + schedule new)

note top of CONFIRMED : **CREATE:** Schedule task cho startTime + 15 phút
note bottom of ARRIVED : **Guest đã đến** → Không cần check NO_SHOW nữa
note bottom of CANCELED : **Cashier hủy** → Không cần check NO_SHOW nữa
note bottom of NO_SHOW : **Auto xử lý** → Task tự động xóa khỏi Map

@enduml


