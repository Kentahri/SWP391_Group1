@startuml reservation-state-machine
title Reservation Status State Machine & Scheduled Task Lifecycle

[*] --> CONFIRMED : createReservation()
state CONFIRMED {
    state "ğŸ”” Scheduled Task EXISTS" as ScheduledActive
    
    note right of ScheduledActive
        **Scheduled Task Ä‘ang active:**
        - Task Ä‘Ã£ Ä‘Æ°á»£c schedule
        - Sáº½ tá»± Ä‘á»™ng cháº¡y vÃ o startTime + 15 phÃºt
        - CÃ³ thá»ƒ bá»‹ cancel báº¥t cá»© lÃºc nÃ o
    end note
}

CONFIRMED --> ARRIVED : openTableForGuestWithReservation()\nâŒ Cancel scheduled task
state ARRIVED {
    state "âœ… Task CANCELED" as TaskCanceled1
}

CONFIRMED --> CANCELED : cancelReservation()\nâŒ Cancel scheduled task
state CANCELED {
    state "âœ… Task CANCELED" as TaskCanceled2
}

CONFIRMED --> NO_SHOW : â° Auto after 15 minutes\n(Scheduled task tá»± Ä‘á»™ng cháº¡y)
state NO_SHOW {
    state "âœ… Task COMPLETED" as TaskCompleted
    
    note right of TaskCompleted
        **Task Ä‘Ã£ cháº¡y xong:**
        - ÄÃ¡nh dáº¥u NO_SHOW
        - Má»Ÿ láº¡i bÃ n (náº¿u khÃ´ng cÃ²n reservation)
        - Broadcast WebSocket
    end note
}

CONFIRMED --> CONFIRMED : updateReservation()\nğŸ”„ Reschedule task\n(cancel old + schedule new)

note top of CONFIRMED : **CREATE:** Schedule task cho startTime + 15 phÃºt
note bottom of ARRIVED : **Guest Ä‘Ã£ Ä‘áº¿n** â†’ KhÃ´ng cáº§n check NO_SHOW ná»¯a
note bottom of CANCELED : **Cashier há»§y** â†’ KhÃ´ng cáº§n check NO_SHOW ná»¯a
note bottom of NO_SHOW : **Auto xá»­ lÃ½** â†’ Task tá»± Ä‘á»™ng xÃ³a khá»i Map

@enduml


