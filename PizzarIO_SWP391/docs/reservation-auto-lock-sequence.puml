@startuml Auto Lock Table Before 90 Minutes Sequence Diagram

participant "Spring Scheduler" as SpringScheduler
participant "ReservationService" as Service
participant "ReservationRepository" as Repo
participant "TableRepository" as TableRepo
participant "SimpMessagingTemplate" as WebSocket
participant "Reservation" as Entity
participant "DiningTable" as Table


group Scheduled Auto Lock Process
    SpringScheduler -> Service: closeTable() [@Scheduled fixedRate=5000ms]
    activate Service
    
    Service -> Service: synchronized method execution
    Service -> Repo: findAllUpcomingReservationInRange(now, now+90min)
    activate Repo
    Repo --> Service: List<Reservation> (reservations in next 90 minutes)
    deactivate Repo
    
    alt If reservations found
        loop For each reservation in range
            Service -> Entity: getDiningTable()
            Entity --> Service: DiningTable
            
            Service -> Table: getTableStatus()
            Table --> Service: TableStatus
            
            alt If table status is AVAILABLE
                Service -> Table: setTableStatus(RESERVED)
                Service -> TableRepo: save(table)
                activate TableRepo
                TableRepo --> Service: Updated DiningTable
                deactivate TableRepo
                
                Service -> Repo: save(reservation)
                activate Repo
                Repo --> Service: Updated Reservation
                deactivate Repo
                
                Service -> WebSocket: broadcastTableStatusToGuests(tableId, RESERVED)
                Service -> WebSocket: broadcastTableStatusToCashier(TABLE_RESERVED, ...)
                
                note right of Service: Table automatically locked for upcoming reservation
            else If table already RESERVED/OCCUPIED
                note right of Service: No action needed - table already locked
            end
        end
    else If no reservations in range
        note right of Service: No action needed - no upcoming reservations
    end
    
    Service --> SpringScheduler: Scheduled task completed
    deactivate Service
end

note over SpringScheduler: This process runs every 5 seconds to ensure tables are locked 90 minutes before reservation time

@enduml
